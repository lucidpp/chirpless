<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Chirpless">
    
    <!-- PWA Links -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="siteicon.png">
    <link rel="apple-touch-icon" href="siteicon.png">
    
    <title>Chirpless | Connected</title>
    <style>
        /* --- CSS VARIABLES & THEME --- */
        :root {
            --bg-color: #050505;
            --surface-color: #121212;
            --surface-highlight: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #999999;
            --accent: #ffffff;
            --accent-dim: #333333;
            /* Modern Glass Variables */
            --glass-panel: rgba(20, 20, 20, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-blur: blur(20px) saturate(180%);
            
            --border-radius: 20px;
            --padding: 20px;
            --nav-height: 85px;
            --mini-player-height: 70px;
            --sidebar-width: 250px;
            --font-main: 'SF Pro Display', -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        [data-theme="light"] {
            --bg-color: #f2f2f7;
            --surface-color: #ffffff;
            --surface-highlight: #e5e5ea;
            --text-primary: #000000;
            --text-secondary: #666666;
            --accent: #000000;
            --accent-dim: #d1d1d6;
            /* Light Mode Glass */
            --glass-panel: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(0, 0, 0, 0.05);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            background-color: var(--bg-color); color: var(--text-primary);
            font-family: var(--font-main); margin: 0; padding: 0;
            height: 100dvh; width: 100vw;
            overflow: hidden;
            transition: background-color 0.3s;
            user-select: none;
        }

        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .w-full { width: 100%; }
        .text-sm { font-size: 0.9rem; }
        .text-xs { font-size: 0.75rem; }
        .font-bold { font-weight: 700; }
        .text-secondary { color: var(--text-secondary); }
        .icon { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        
        /* --- LAYOUT --- */
        #app { height: 100%; display: flex; flex-direction: column; position: relative; }
        
        /* HEADER (Mobile Only) */
        header {
            padding: var(--padding); padding-top: max(15px, var(--safe-top));
            display: flex; justify-content: space-between; align-items: center; z-index: 10;
        }
        .brand { font-size: 1.4rem; font-weight: 800; display: flex; align-items: center; gap: 8px; letter-spacing: -0.5px; }
        .brand img { width: 28px; height: 28px; border-radius: 6px; }

        /* SIDEBAR (Desktop Only) */
        #desktop-sidebar {
            display: none;
            position: fixed; top: 0; left: 0; height: 100%; width: var(--sidebar-width);
            background: var(--surface-color); border-right: 1px solid var(--surface-highlight);
            padding: 30px 20px; z-index: 150;
            flex-direction: column; justify-content: space-between;
        }

        .sidebar-menu { display: flex; flex-direction: column; gap: 10px; margin-top: 40px; }
        .sidebar-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px;
            border-radius: 12px; color: var(--text-secondary); cursor: pointer; transition: 0.2s;
            font-weight: 600;
        }
        .sidebar-item:hover { background: var(--surface-highlight); color: var(--text-primary); }
        .sidebar-item.active { background: var(--text-primary); color: var(--bg-color); }
        .sidebar-item svg { width: 20px; height: 20px; }

        /* MAIN CONTENT */
        main {
            flex: 1; overflow-y: scroll; scroll-behavior: smooth;
            padding-bottom: calc(var(--nav-height) + var(--mini-player-height) + 20px);
            overscroll-behavior: contain;
            transition: margin-left 0.3s;
        }
        main::-webkit-scrollbar { display: none; }

        /* --- COMPONENTS --- */
        .section-title { font-size: 1.3rem; margin: 24px var(--padding) 12px; font-weight: 700; }
        
        .search-container { padding: 0 var(--padding); margin-bottom: 15px; }
        
        /* Modern Glass Search Bar */
        .search-bar {
            width: 100%;
            background: var(--glass-panel);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            padding: 12px 16px; border-radius: 14px;
            display: flex; align-items: center; font-size: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: background 0.3s;
        }
        .search-bar:focus-within {
             background: rgba(100, 100, 100, 0.2);
        }

        .search-bar input {
            background: transparent; border: none; width: 100%; color: inherit; font-size: inherit; margin-left: 10px;
        }

        .filters { display: flex; gap: 10px; padding: 0 var(--padding); margin-bottom: 20px; overflow-x: auto; }
        .chip {
            padding: 8px 16px; background: var(--surface-color); border-radius: 20px;
            font-size: 0.85rem; font-weight: 600; color: var(--text-secondary);
            border: 1px solid transparent; transition: all 0.2s; white-space: nowrap;
        }
        .chip.active { background: var(--text-primary); color: var(--bg-color); }

        .horizontal-scroll { display: flex; gap: 16px; overflow-x: auto; padding: 0 var(--padding) 10px; }
        .horizontal-scroll::-webkit-scrollbar { display: none; }
        
        .podcast-card { min-width: 140px; width: 140px; display: flex; flex-direction: column; gap: 8px; cursor: pointer; }
        .cover-art {
            width: 100%; aspect-ratio: 1; background: var(--surface-highlight);
            border-radius: 16px; overflow: hidden; position: relative;
        }
        .cover-art img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        .podcast-card:active .cover-art img { transform: scale(0.95); }

        .list-item {
            display: flex; align-items: center; gap: 16px; padding: 12px var(--padding);
            border-bottom: 1px solid rgba(255,255,255,0.03); transition: background 0.2s;
            cursor: pointer;
        }
        .list-item:active { background: var(--surface-highlight); }
        .list-img { width: 56px; height: 56px; border-radius: 12px; background: var(--surface-highlight); object-fit: cover; flex-shrink: 0; }
        .list-rank {
            font-size: 1.2rem; font-weight: 900; color: var(--text-secondary); width: 30px; text-align: center; font-variant-numeric: tabular-nums;
        }
        
        /* --- BADGES --- */
        .verified-badge { width: 14px; height: 14px; margin-left: 4px; vertical-align: middle; display: inline-block; visibility: hidden; }
        .verified-badge.visible { visibility: visible; }
        .verified-badge.lg { width: 18px; height: 18px; margin-left: 6px; }
        [data-theme="dark"] .verified-badge { fill: #ffffff; filter: drop-shadow(0 0 4px rgba(255,255,255,0.5)); }
        [data-theme="light"] .verified-badge { fill: #000000; filter: none; }

        .new-badge {
            font-size: 0.6rem; font-weight: 900; letter-spacing: 0.5px;
            background: var(--text-primary); color: var(--bg-color);
            padding: 3px 6px; border-radius: 6px; margin-left: 8px;
            vertical-align: middle; display: inline-block;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .chart-badge {
            font-size: 0.65rem; font-weight: 700;
            background: var(--surface-highlight); color: var(--text-secondary);
            padding: 2px 8px; border-radius: 4px; margin-left: 8px;
            vertical-align: middle; display: inline-flex; align-items: center; gap: 4px;
        }

        /* --- ODOMETER ANIMATION --- */
        .odometer-wrapper {
            display: inline-flex; align-items: baseline; overflow: hidden;
            height: 1.2em; line-height: 1.2em; vertical-align: bottom;
            font-variant-numeric: tabular-nums; opacity: 0;
            transition: opacity 0.3s ease;
        }
        .odometer-wrapper.active { opacity: 1; }
        .odometer-digit { display: inline-block; height: 1.2em; position: relative; }
        .odometer-ribbon {
            display: flex; flex-direction: column;
            transition: transform 1.2s cubic-bezier(0.16, 1, 0.3, 1);
            will-change: transform;
        }
        .odometer-ribbon div { height: 1.2em; display: flex; justify-content: center; align-items: center; }
        .odometer-static { display: inline-block; }
        .pop-effect { animation: pop-bright 0.2s ease-out forwards; }
        @keyframes pop-bright {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.1); filter: brightness(1.3); }
            100% { transform: scale(1); filter: brightness(1); }
        }

        /* --- PROFILE DETAIL VIEW (FIXED OVERLAY) --- */
        #view-profile-detail { 
            background: var(--bg-color); 
            z-index: 50; 
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            overflow-y: auto; 
            padding-bottom: calc(100px + var(--safe-bottom) + 80px); 
            overscroll-behavior: contain;
            transition: left 0.3s, width 0.3s;
        }
        .profile-header {
            padding: var(--padding); padding-top: 80px; display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .profile-art { width: 160px; height: 160px; border-radius: 30px; margin-bottom: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); object-fit: cover; }
        .profile-btn-row { display: flex; gap: 15px; margin-top: 20px; width: 100%; justify-content: center; }
        
        .chirp-btn-lg {
            display: flex; align-items: center; gap: 8px; padding: 12px 30px;
            border-radius: 30px; font-weight: 700; border: 1px solid var(--surface-highlight);
            background: var(--surface-color); color: var(--text-primary);
            transition: all 0.2s;
        }
        .chirp-btn-lg.active {
            background: var(--text-primary); color: var(--bg-color); transform: scale(1.05); border-color: var(--text-primary);
        }
        .chirp-btn-lg:active { transform: scale(0.95); }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 var(--padding); margin-top: 20px; }
        .stat-box {
            background: var(--surface-color); padding: 15px; border-radius: 16px;
            display: flex; flex-direction: column; gap: 4px;
        }

        /* --- MODALS --- */
        #install-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            width: 85%; max-width: 320px; background: var(--surface-color);
            padding: 24px; border-radius: 24px; text-align: center;
            z-index: 500; opacity: 0; pointer-events: none;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);
        }
        #install-modal.active { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }
        .install-btn { padding: 12px 24px; border-radius: 12px; font-weight: 700; margin: 0 5px; cursor: pointer; }
        .btn-yes { background: var(--text-primary); color: var(--bg-color); }
        .btn-no { background: var(--surface-highlight); color: var(--text-secondary); }

        #creators-modal {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--surface-color); border-top-left-radius: 30px; border-top-right-radius: 30px;
            z-index: 400; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            padding: 20px; padding-bottom: max(40px, var(--safe-bottom));
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }
        #creators-modal.active { transform: translateY(0); }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 350; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .creator-item {
            padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 1.1rem; font-weight: 500; display: flex; justify-content: space-between; align-items: center;
        }
        .creator-item:last-child { border-bottom: none; }
        .creator-item:active { background: var(--surface-highlight); border-radius: 12px; }

        /* --- MINI PLAYER & NAV --- */
        #mini-player {
            position: absolute; bottom: calc(var(--nav-height) + var(--safe-bottom)); left: 0; width: 100%;
            height: var(--mini-player-height); background: var(--glass);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.05);
            display: flex; align-items: center; padding: 0 var(--padding);
            z-index: 90; transition: transform 0.3s ease, left 0.3s, width 0.3s;
        }
        #mini-player.expanded { transform: translateY(200%); }

        nav {
            position: absolute; bottom: 0; width: 100%; 
            height: calc(var(--nav-height) + var(--safe-bottom));
            background: var(--bg-color); display: flex; justify-content: space-around;
            padding-top: 15px; padding-bottom: var(--safe-bottom);
            border-top: 1px solid rgba(255,255,255,0.05); z-index: 100;
            align-items: flex-start;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 6px; color: var(--text-secondary); opacity: 0.7; transition: 0.2s; }
        .nav-item.active { color: var(--text-primary); opacity: 1; }

        /* --- FULL PLAYER (MODERN GLASS THEME) --- */
        #full-player {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            /* Modern Glass Effect */
            background: rgba(10, 10, 10, 0.65);
            backdrop-filter: blur(45px) saturate(180%);
            -webkit-backdrop-filter: blur(45px) saturate(180%);
            
            z-index: 200; 
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            overflow: hidden; 
            padding: max(20px, var(--safe-top)) var(--padding) max(20px, var(--safe-bottom));
        }
        #full-player.active { transform: translateY(0); }
        
        /* Light mode override for player */
        [data-theme="light"] #full-player {
             background: rgba(255, 255, 255, 0.65);
        }

        .player-top { flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .player-art-area { flex: 1; display: flex; align-items: center; justify-content: center; min-height: 0; margin-bottom: 20px; position: relative; }
        .player-art-wrapper { width: 100%; height: 100%; max-width: 340px; max-height: 340px; aspect-ratio: 1; border-radius: 24px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .player-art-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        .player-info { flex: 0 0 auto; margin-bottom: 10px; text-align: left; }
        .player-controls-area { flex: 0 0 auto; width: 100%; }

        /* LYRICS OVERLAY */
        #lyrics-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(15px);
            z-index: 10; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            border-radius: 24px; padding: 30px;
        }
        #lyrics-overlay.active { opacity: 1; pointer-events: auto; }
        .lyrics-text { 
            font-size: 1.4rem; font-weight: 600; line-height: 1.6; color: #fff; 
            min-height: 100px; transition: opacity 0.2s;
        }
        
        .clickable-artist { text-decoration: underline; text-decoration-color: transparent; transition: 0.2s; cursor: pointer; }
        .clickable-artist.has-multi { text-decoration-color: var(--text-secondary); }
        .clickable-artist.has-multi:active { color: var(--text-primary); }

        /* --- TOAST --- */
        #toast {
            position: fixed; top: -60px; left: 50%; transform: translateX(-50%);
            background: var(--text-primary); color: var(--bg-color);
            padding: 12px 24px; border-radius: 30px; font-weight: 700;
            z-index: 300; transition: top 0.4s;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 8px;
        }
        #toast.show { top: 20px; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .popping { animation: pop 0.3s ease; }

        /* Loader */
        .spinner { width: 20px; height: 20px; border: 2px solid var(--text-secondary); border-top-color: var(--text-primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 10px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ================= DESKTOP STYLES ================= */
        @media (min-width: 768px) {
            /* Hide Mobile Header & Bottom Nav */
            header, nav { display: none !important; }

            /* Show Sidebar */
            #desktop-sidebar { display: flex; }

            /* Shift Main Content */
            main {
                margin-left: var(--sidebar-width);
                padding-bottom: calc(var(--mini-player-height) + 40px);
                height: 100vh;
            }

            /* Shift Profile View */
            #view-profile-detail {
                left: var(--sidebar-width);
                width: calc(100% - var(--sidebar-width));
                padding-bottom: 120px; /* Adjust for mini player */
            }
            /* Adjust Back Button in Profile */
            #view-profile-detail > div:first-child { top: 20px; left: 30px; }

            /* Mini Player Width Fix */
            #mini-player {
                left: var(--sidebar-width);
                width: calc(100% - var(--sidebar-width));
                bottom: 0;
            }

            /* Desktop Modal Overrides */
            #full-player {
                left: 50%; top: 50%;
                width: 450px; height: 85vh;
                transform: translate(-50%, 150%); /* Start below */
                border-radius: 24px;
                border: 1px solid var(--glass-border);
                box-shadow: 0 40px 80px rgba(0,0,0,0.6);
            }
            #full-player.active {
                transform: translate(-50%, -50%); /* Center */
            }
            .player-top { margin-top: 10px; }
            
            #full-player::before {
                content: ''; position: fixed; top: -50vh; left: -50vw; width: 200vw; height: 200vh;
                background: rgba(0,0,0,0.7); z-index: -1;
                pointer-events: none; opacity: 0; transition: opacity 0.4s;
            }
            #full-player.active::before { opacity: 1; pointer-events: auto; }
        }

    </style>
</head>
<body data-theme="dark">

    <div id="app">
        <!-- DESKTOP SIDEBAR -->
        <aside id="desktop-sidebar">
            <div class="brand">
                <img src="siteicon.png" alt="icon"> Chirpless
            </div>
            <div class="sidebar-menu">
                <div class="sidebar-item active" onclick="switchView('home', this)">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    Home
                </div>
                <div class="sidebar-item" onclick="switchView('discover', this)">
                    <svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    Discover
                </div>
                <div class="sidebar-item" onclick="switchView('library', this)">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
                    Library
                </div>
            </div>
            <div style="cursor:pointer; display:flex; align-items:center; gap:12px; color:var(--text-secondary); font-weight:600; padding:12px 16px;" onclick="toggleTheme()">
                <svg class="icon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                Theme
            </div>
        </aside>

        <!-- HEADER (Mobile) -->
        <header>
            <div class="brand">
                <img src="siteicon.png" alt="icon">
                Chirpless
            </div>
            <button onclick="toggleTheme()" style="background:none; border:none; color:inherit;">
                <svg class="icon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
        </header>

        <main id="main-content">
            <!-- HOME VIEW -->
            <div id="view-home" class="view">
                <div class="section-title">Trending Now</div>
                <div class="horizontal-scroll" id="trending-container" style="min-height:200px">
                    <div class="spinner"></div>
                </div>
                <div class="section-title">Recommended for You</div>
                <div class="horizontal-scroll" id="mix-container" style="min-height:200px">
                    <div class="spinner"></div>
                </div>
                <div style="height:20px"></div>
            </div>

            <!-- DISCOVER VIEW -->
            <div id="view-discover" class="view hidden">
                <div class="section-title">Explore</div>
                <div class="search-container">
                    <div class="search-bar">
                        <svg class="icon" style="opacity:0.5; width:20px;" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                        <input type="search" id="search-input" placeholder="Search..." onkeypress="handleSearch(event)">
                    </div>
                </div>
                <div class="filters">
                    <div class="chip active" onclick="setFilter('all', this)">All</div>
                    <div class="chip" onclick="setFilter('profile', this)">Profiles</div>
                    <div class="chip" onclick="setFilter('episode', this)">Episodes</div>
                    <div class="chip" onclick="setFilter('charts', this)">Charts</div>
                </div>
                <div id="search-results">
                    <div style="text-align:center; color:var(--text-secondary); margin-top:40px;">
                        Find creators and stories.
                    </div>
                </div>
            </div>

            <!-- LIBRARY VIEW -->
            <div id="view-library" class="view hidden">
                <div class="section-title">Your Chirps</div>
                <div id="library-list"></div>
            </div>
        </main>

        <!-- PROFILE DETAIL VIEW -->
        <div id="view-profile-detail" class="hidden">
            <div style="position:absolute; top:max(15px, env(safe-area-inset-top)); left:20px; z-index:10;">
                <button onclick="closeProfile()" style="background:var(--glass); width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:none; color:var(--text-primary);">
                    <svg class="icon" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
                </button>
            </div>
            
            <div class="profile-header">
                <img id="pd-img" src="" class="profile-art">
                <h1 id="pd-title" style="margin:0; font-size:1.8rem; line-height:1.2;">Title</h1>
                <p id="pd-artist-container" style="margin:8px 0;">
                    <span id="pd-artist" class="text-secondary clickable-artist" onclick="handleArtistClick(this.innerText)">Artist</span>
                    <!-- Verification Badge -->
                    <svg class="verified-badge lg" id="pd-verified" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                </p>
                
                <div class="profile-btn-row">
                    <button id="pd-chirp-btn" class="chirp-btn-lg" onclick="toggleProfileChirp()">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
                        <span id="pd-chirp-text">Chirp</span>
                    </button>
                </div>
            </div>

            <div class="filters" style="justify-content:center; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:15px;">
                <div class="chip active" id="tab-episodes" onclick="switchProfileTab('episodes')">Episodes</div>
                <div class="chip" id="tab-stats" onclick="switchProfileTab('stats')">Stats</div>
            </div>

            <div id="pd-content-episodes" style="padding-bottom:100px;"></div>
            <div id="pd-loading-more" class="hidden"><div class="spinner"></div></div>

            <div id="pd-content-stats" class="hidden" style="padding-bottom:100px;">
                <div class="stats-grid">
                    <div class="stat-box">
                        <span class="text-xs text-secondary">Total Chirps</span>
                        <span class="font-bold odometer-container" style="font-size:1.5rem" id="stat-chirps"></span>
                    </div>
                    <div class="stat-box">
                        <span class="text-xs text-secondary">Total Cash Earned ($0.006/stream)</span>
                        <span class="font-bold odometer-container" style="font-size:1.8rem; color:var(--text-primary);" id="stat-cash">--</span>
                    </div>
                </div>
                <div style="padding:20px; text-align:center; color:var(--text-secondary); font-size:0.8rem; line-height:1.5;">
                    Data reflects currently loaded episodes only.<br>
                    (Historical data not retrieved)
                </div>
            </div>
        </div>

        <!-- MODALS -->
        <div class="modal-overlay" id="install-overlay"></div>
        <div id="install-modal">
            <h2 style="margin-top:0;">Install Chirpless?</h2>
            <p style="color:var(--text-secondary); margin-bottom:20px;">Get the full app experience on your home screen.</p>
            <div class="flex justify-center">
                <button class="install-btn btn-no" onclick="dismissInstall()">No</button>
                <button class="install-btn btn-yes" onclick="triggerInstall()">Yes</button>
            </div>
        </div>

        <div class="modal-overlay" id="modal-overlay" onclick="closeCreatorsModal()"></div>
        <div id="creators-modal">
            <div style="text-align:center; font-weight:bold; margin-bottom:20px; opacity:0.6;">Featured Creators</div>
            <div id="creators-list"></div>
        </div>

        <div id="toast">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="var(--bg-color)"><path d="M21 15C21 19 17 22 13 22C9 22 10 18 10 15C10 12 5 10 3 8C5.5 6 12 2 12 2Z"/></svg>
            Chirped!
        </div>

        <!-- MINI PLAYER -->
        <div id="mini-player" onclick="openFullPlayer()">
            <img id="mini-img" src="" class="list-img" style="opacity:0">
            <div style="flex:1; margin-left:12px; overflow:hidden;">
                <div id="mini-title" class="font-bold text-sm" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Select a chirp</div>
                <div id="mini-artist" class="text-xs text-secondary">Chirpless</div>
            </div>
            <button id="mini-play-btn" onclick="event.stopPropagation(); togglePlay()" style="padding:10px; background:none; border:none; color:inherit;">
                <svg class="icon" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
            </button>
        </div>

        <!-- NAV (Mobile) -->
        <nav>
            <div class="nav-item active" onclick="switchView('home', this)">
                <svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                <span class="text-xs">Home</span>
            </div>
            <div class="nav-item" onclick="switchView('discover', this)">
                <svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                <span class="text-xs">Discover</span>
            </div>
            <div class="nav-item" onclick="switchView('library', this)">
                <svg class="icon" viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
                <span class="text-xs">Library</span>
            </div>
        </nav>

        <!-- FULL PLAYER -->
        <div id="full-player">
            <div class="player-top">
                <button onclick="closeFullPlayer()" style="background:none; border:none; color:inherit;"><svg class="icon" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg></button>
                <span class="text-xs font-bold" style="letter-spacing:2px;">NOW PLAYING</span>
                <div style="width:24px;"></div>
            </div>

            <div class="player-art-area">
                <div class="player-art-wrapper">
                    <img id="fp-img" src="" alt="Album Art">
                    <div id="lyrics-overlay">
                        <div class="spinner" id="lyrics-spinner" style="margin-bottom:20px;"></div>
                        <div class="lyrics-text" id="lyrics-content">Transcribing Audio Stream...</div>
                    </div>
                </div>
            </div>

            <div class="player-info">
                <h2 id="fp-title" style="margin:0; font-size:1.5rem; line-height:1.2; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">Title</h2>
                <p id="fp-artist" class="text-secondary clickable-artist" onclick="handleArtistClick(this.innerText)" style="margin:5px 0 0;">Artist</p>
            </div>

            <div class="player-controls-area">
                <div class="flex justify-between items-center" style="margin-bottom:15px; padding:0 10px;">
                    <button onclick="toggleLyrics()" style="color:var(--text-secondary); background:none; border:none;">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><line x1="9" y1="10" x2="15" y2="10"/><line x1="9" y1="6" x2="15" y2="6"/></svg>
                    </button>
                    <canvas id="wave-canvas" style="flex:1; height:40px; margin:0 15px; opacity:0.6;"></canvas>
                </div>
                
                <div id="progress-container" onclick="seek(event)" style="width:100%; height:20px; display:flex; align-items:center;">
                    <div style="width:100%; height:4px; background:var(--accent-dim); border-radius:2px; overflow:hidden;">
                        <div id="progress-fill" style="width:0%; height:100%; background:var(--text-primary);"></div>
                    </div>
                </div>
                <div class="flex justify-between text-xs text-secondary" style="margin-bottom:20px;">
                    <span id="time-current">0:00</span>
                    <span id="time-total">0:00</span>
                </div>

                <div class="flex justify-between items-center" style="max-width:350px; margin:0 auto;">
                    <button class="bird-btn" id="fp-bird-btn" onclick="toggleTrackChirp()" style="background:var(--surface-highlight); width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:inherit; border:none;">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
                    </button>
                    <button onclick="skip(-15)" style="background:none; border:none; color:inherit;"><svg class="icon" style="width:32px; height:32px;" viewBox="0 0 24 24"><path d="M11 17l-5-5 5-5M18 17l-5-5 5-5"/></svg></button>
                    <button onclick="togglePlay()" style="width:70px; height:70px; background:var(--text-primary); color:var(--bg-color); border-radius:50%; display:flex; align-items:center; justify-content:center; border:none;">
                        <svg id="fp-play-icon" style="width:32px; height:32px; fill:currentColor; stroke:none;" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                    </button>
                    <button onclick="skip(15)" style="background:none; border:none; color:inherit;"><svg class="icon" style="width:32px; height:32px;" viewBox="0 0 24 24"><path d="M13 17l5-5-5-5M6 17l5-5-5-5"/></svg></button>
                    <button onclick="changeSpeed()" style="background:var(--surface-highlight); width:44px; height:44px; border-radius:50%; font-weight:bold; font-size:0.8rem; border:none; color:inherit;" id="speed-btn">1x</button>
                </div>
            </div>
        </div>
    </div>

    <audio id="audio-player" preload="none"></audio>

    <script>
        // PWA REGISTRATION & INSTALL LOGIC
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .catch(err => console.log('SW failed', err));
                
                setTimeout(() => {
                    if (deferredPrompt) {
                        document.getElementById('install-overlay').classList.add('active');
                        document.getElementById('install-modal').classList.add('active');
                    }
                }, 3000);
            });
        }

        function dismissInstall() {
            document.getElementById('install-overlay').classList.remove('active');
            document.getElementById('install-modal').classList.remove('active');
        }

        function triggerInstall() {
            dismissInstall();
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    deferredPrompt = null;
                });
            } else {
                alert("To install on iOS: Tap 'Share' icon below, then 'Add to Home Screen'.");
            }
        }

        /* --- STATE & CONFIG --- */
        let currentTrack = null;
        let isPlaying = false;
        let playbackSpeed = 1.0;
        let currentFilter = 'all';
        
        let savedChirps = JSON.parse(localStorage.getItem('chirps_v26') || '[]');
        let savedProfileChirps = JSON.parse(localStorage.getItem('profile_chirps_v26') || '[]');
        
        let currentProfileId = null;
        let currentProfileEpisodes = [];
        let renderedEpisodeCount = 0;
        const EPISODES_PER_PAGE = 10;
        let activeProfileStats = null;
        
        const VERIFIED_BADGE_HTML = `
            <svg class="verified-badge" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>`;

        /* --- DETERMINISTIC STATS & FORMATTING --- */
        function seededRandom(str) {
            let h = 1779033703 ^ str.length;
            for(let i = 0; i < str.length; i++) {
                h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
                h = h << 13 | h >>> 19;
            }
            return function() {
                h = Math.imul(h ^ (h >>> 16), 2246822507);
                h = Math.imul(h ^ (h >>> 13), 3266489909);
                return (h >>> 0) / 4294967296;
            }
        }

        function getDeterministicStats(id, isProfile = false, dateStr = null) {
            const rng = seededRandom(id);
            const tierSelector = rng(); 
            const val = rng();          

            let minChirps, maxChirps;

            if (tierSelector < 0.4) {
                minChirps = 3000; maxChirps = 281000;
            } else if (tierSelector < 0.7) {
                minChirps = 1200; maxChirps = 14200000;
            } else if (tierSelector < 0.9) {
                minChirps = 827000; maxChirps = 28000000;
            } else {
                minChirps = 5000000; maxChirps = 5000000000;
            }
            
            if (isProfile) {
                const chirps = Math.floor(minChirps + Math.pow(val, 2) * (maxChirps - minChirps));
                const listens = Math.floor(chirps * (10 + val * 40)); 
                const cash = listens * 0.006;
                if(isNaN(chirps) || isNaN(cash)) return { chirps: minChirps, cash: 0, listens: 0 };
                return { listens, chirps, cash };
            }

            let epMin = Math.floor(minChirps / 50); 
            let epMax = Math.floor(maxChirps / 20); 
            if (epMin < 100) epMin = 100;

            if (dateStr) {
                const date = new Date(dateStr);
                if(!isNaN(date.getTime())) {
                    const now = new Date();
                    const hoursOld = (now - date) / (1000 * 60 * 60);
                    if (hoursOld < 24) { epMax = Math.min(epMax, 15000); } 
                    else if (hoursOld < 168) { epMax = Math.min(epMax, 500000); } 
                    else if (hoursOld < 720) { epMax = Math.min(epMax, 5000000); }
                }
            }

            const chirps = Math.floor(epMin + Math.pow(val, 3) * (epMax - epMin));
            const listens = chirps * 20;
            const cash = listens * 0.006;
            
            if(isNaN(listens) || isNaN(chirps) || isNaN(cash)) {
                return { listens: 1000, chirps: 50, cash: 6 };
            }
            return { listens, chirps, cash };
        }

        /* --- CHART LOGIC --- */
        function getChartRank(id) {
            const rng = seededRandom(id + "_chart");
            if (rng() > 0.8) return Math.floor(rng() * 45) + 1;
            return null;
        }

        function getTopNewRank(id, dateStr) {
            if (!isNewEpisode(dateStr)) return null;
            const rng = seededRandom(id + "_newchart");
            if (rng() > 0.7) return Math.floor(rng() * 45) + 1;
            return null;
        }

        function formatNumber(num) {
            if(isNaN(num)) return "0";
            if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'b';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'm';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return num.toLocaleString();
        }

        function formatCurrency(num) {
            if(isNaN(num)) return "$0.00";
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
        }

        function isNewEpisode(dateStr) {
            if (!dateStr) return false;
            const date = new Date(dateStr);
            if(isNaN(date.getTime())) return false;
            const now = new Date();
            return (now - date) < (7 * 24 * 60 * 60 * 1000);
        }

        /* --- ODOMETER ANIMATION SYSTEM --- */
        function updateOdometer(container, value) {
            if(!container) return;
            const formatted = typeof value === 'number' ? formatNumber(value) : value;
            
            if(!container.hasChildNodes()) {
                container.innerHTML = '';
                container.classList.add('odometer-wrapper');
                formatted.split('').forEach(char => {
                    if (/[0-9]/.test(char)) {
                        const wrapper = document.createElement('span');
                        wrapper.className = 'odometer-digit';
                        const ribbon = document.createElement('div');
                        ribbon.className = 'odometer-ribbon';
                        for(let i=0; i<=9; i++) {
                            const d = document.createElement('div');
                            d.innerText = i;
                            ribbon.appendChild(d);
                        }
                        wrapper.appendChild(ribbon);
                        container.appendChild(wrapper);
                    } else {
                        const s = document.createElement('span');
                        s.className = 'odometer-static';
                        s.innerText = char;
                        container.appendChild(s);
                    }
                });
            }

            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    container.classList.add('active'); 
                    container.classList.add('pop-effect');
                    const chars = formatted.split('');
                    let idx = 0;
                    Array.from(container.children).forEach(child => {
                        if(child.classList.contains('odometer-digit')) {
                            const target = parseInt(chars[idx]);
                            const ribbon = child.querySelector('.odometer-ribbon');
                            if(ribbon && !isNaN(target)) {
                                ribbon.style.transform = `translateY(${target * -1.2}em)`;
                            }
                        }
                        idx++;
                    });
                    setTimeout(() => container.classList.remove('pop-effect'), 500);
                });
            });
        }

        function simulateLiveStats() {
            const profileView = document.getElementById('view-profile-detail');
            if(profileView.classList.contains('hidden') || !activeProfileStats) return;

            activeProfileStats.chirps += Math.floor(Math.random() * 5) + 1;
            activeProfileStats.listens += Math.floor(Math.random() * 100) + 10;
            activeProfileStats.cash = activeProfileStats.listens * 0.006;

            const chirpsEl = document.getElementById('stat-chirps');
            const cashEl = document.getElementById('stat-cash');

            if(!document.getElementById('pd-content-stats').classList.contains('hidden')) {
                updateOdometer(chirpsEl, activeProfileStats.chirps);
                updateOdometer(cashEl, formatCurrency(activeProfileStats.cash));
            }
        }

        let lyricsInterval;
        const PODCAST_SCRIPT = [
            "So, I was thinking about this the other day.",
            "Right, exactly.",
            "It's a complex issue, for sure.",
            "If you look at the history of it...",
            "That's a great point you bring up.",
            "I think we need to take a step back.",
            "It really changes the perspective on everything.",
            "Absolutely, I agree 100%.",
            "But what about the long-term implications?",
            "It's hard to say right now.",
            "The data suggests otherwise, though.",
            "Wait, let me just pull that up.",
            "This reminds me of a conversation I had last week.",
            "It's kind of wild when you actually think about it.",
            "Yeah, totally.",
            "Moving on to the next topic...",
            "I feel like that's a common misconception.",
            "Well, that's just the nature of the industry.",
            "Can you believe that actually happened?",
            "It's all about finding that balance.",
            "So, what's the takeaway here?",
            "I think it comes down to personal preference.",
            "Let's dive a little deeper into that.",
            "That is fascinating.",
            "I never thought about it that way.",
            "It's a game changer, honestly.",
            "You know what I mean?",
            "Exactly.",
            "So, where do we go from here?",
            "It's definitely something to keep an eye on.",
            "Thanks for sharing that.",
            "I think the audience will really resonate with this.",
            "It's a bit controversial, but...",
            "Let's break it down simply.",
            "It's not as simple as black and white.",
            "There's a lot of grey area there.",
            "Wow, that is intense.",
            "So, tell me more about that.",
            "It's pretty straightforward once you get the hang of it.",
            "I was reading an article about this yesterday.",
            "It's completely disrupted the market.",
            "That's the beauty of it.",
            "I couldn't have said it better myself.",
            "Let's switch gears for a second.",
            "It's a classic example of what not to do.",
            "But here's the thing...",
            "You have to look at the bigger picture.",
            "It's a slippery slope.",
            "Ideally, yes, but realistically...",
            "That's a wrap for this segment."
        ];

        function toggleLyrics() {
            const overlay = document.getElementById('lyrics-overlay');
            const isActive = overlay.classList.contains('active');
            
            if(isActive) {
                overlay.classList.remove('active');
                clearInterval(lyricsInterval);
            } else {
                overlay.classList.add('active');
                const txt = document.getElementById('lyrics-content');
                const spinner = document.getElementById('lyrics-spinner');
                
                txt.innerText = "Analyzing Audio Stream...";
                txt.style.opacity = 0.7;
                spinner.style.display = "block";
                
                let idx = Math.floor(Math.random() * PODCAST_SCRIPT.length);
                
                setTimeout(() => {
                    spinner.style.display = "none";
                    txt.style.opacity = 1;
                    
                    lyricsInterval = setInterval(() => {
                        if(idx >= PODCAST_SCRIPT.length) idx = 0;
                        txt.style.transform = "translateY(-10px)";
                        txt.style.opacity = 0;
                        setTimeout(() => {
                            txt.innerText = PODCAST_SCRIPT[idx];
                            txt.style.transform = "translateY(10px)";
                            requestAnimationFrame(() => {
                                txt.style.transform = "translateY(0)";
                                txt.style.opacity = 1;
                            });
                            idx++;
                        }, 200);
                    }, 2500 + Math.random() * 1500);
                }, 1500); 
            }
        }

        async function search(query) {
            let entity = 'podcastEpisode'; 
            if (currentFilter === 'profile') entity = 'podcast';
            
            try {
                // CACHE BUSTING TIMESTAMP
                const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&media=podcast&entity=${entity}&limit=45&_t=${Date.now()}`);
                if (!res.ok) throw new Error('Fetch Error');
                const data = await res.json();
                if(!data.results) return [];

                return data.results.map(item => ({
                    id: item.collectionId + (item.trackId || ''),
                    type: item.kind === 'podcast' ? 'profile' : 'episode',
                    title: item.trackName || item.collectionName || 'Untitled',
                    artist: item.artistName || item.collectionName || 'Unknown Creator',
                    image: item.artworkUrl600,
                    src: item.episodeUrl,
                    collectionId: item.collectionId,
                    date: item.releaseDate
                }));
            } catch (error) {
                console.warn("API Error:", error);
                return [];
            }
        }

        async function fetchProfileEpisodes(collectionId, artistNameFallback) {
             try {
                // CACHE BUSTING TIMESTAMP
                const res = await fetch(`https://itunes.apple.com/lookup?id=${collectionId}&media=podcast&entity=podcastEpisode&limit=60&_t=${Date.now()}`);
                if(!res.ok) throw new Error("Fetch failed");
                const data = await res.json();
                if (!data.results || data.results.length === 0) throw new Error("No episodes");

                const showInfo = data.results[0];
                const artistName = showInfo.artistName || showInfo.collectionName || "Unknown";
                
                return data.results.slice(1).map(item => ({
                    id: item.trackId,
                    title: item.trackName || "Untitled Episode",
                    src: item.episodeUrl,
                    image: item.artworkUrl600,
                    artist: artistName, 
                    date: item.releaseDate,
                    duration: item.trackTimeMillis
                }));
             } catch (error) {
                 if(artistNameFallback) return await search(artistNameFallback);
                 return [];
             }
        }

        function init() {
            renderLibrary();
            loadHomeContent();
            setInterval(simulateLiveStats, 1400);
            document.getElementById('view-profile-detail').addEventListener('scroll', (e) => {
                const el = e.target;
                if(el.scrollTop + el.clientHeight >= el.scrollHeight - 50) renderMoreEpisodes();
            });
        }

        async function loadHomeContent() {
            const trending = await search('Popular');
            const trendingContainer = document.getElementById('trending-container');
            trendingContainer.innerHTML = '';
            
            if(trending.length === 0) {
                trendingContainer.innerHTML = '<div style="padding:20px; color:var(--text-secondary);">Offline</div>';
            } else {
                trending.slice(0, 10).forEach(item => {
                    const stats = getDeterministicStats(item.id.toString(), true);
                    const verified = stats.chirps > 50000000 ? VERIFIED_BADGE_HTML : '';
                    const el = document.createElement('div');
                    el.className = 'podcast-card';
                    el.onclick = () => { if(item.type==='profile') openProfile(item); else playTrack(item); };
                    el.innerHTML = `
                       <div class="cover-art"><img src="${item.image}"></div>
                       <div class="font-bold text-sm" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${item.title}</div>
                       <div class="text-xs text-secondary" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.artist} ${verified}</div>
                    `;
                    trendingContainer.appendChild(el);
                });
            }

            const mix = await search('True Crime');
            const mixContainer = document.getElementById('mix-container');
            mixContainer.innerHTML = '';
            
            if(mix.length > 0) {
                mix.slice(0, 10).forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'podcast-card';
                    el.onclick = () => { if(item.type==='profile') openProfile(item); else playTrack(item); };
                    el.innerHTML = `
                       <div class="cover-art"><img src="${item.image}"></div>
                       <div class="font-bold text-sm" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${item.title}</div>
                       <div class="text-xs text-secondary">${item.artist || 'Unknown'}</div>
                    `;
                    mixContainer.appendChild(el);
                });
            }
        }

        function setFilter(filter, btn) {
            currentFilter = filter;
            document.querySelectorAll('.filters .chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            
            if(filter === 'charts') {
                renderCharts();
            } else {
                const val = document.getElementById('search-input').value;
                if(val) doSearch(val);
                else document.getElementById('search-results').innerHTML = '<div style="text-align:center; padding:20px; opacity:0.6;">Search to explore</div>';
            }
        }

        async function renderCharts() {
            const container = document.getElementById('search-results');
            container.innerHTML = '<div class="spinner"></div>';
            
            const chartItems = await search('Podcast Hits');
            container.innerHTML = '';
            
            const topTitle = document.createElement('div');
            topTitle.className = 'section-title';
            topTitle.innerText = "Top 45 Global";
            container.appendChild(topTitle);

            chartItems.slice(0, 45).forEach((item, index) => {
                const el = document.createElement('div');
                el.className = 'list-item';
                el.onclick = () => item.type === 'profile' ? openProfile(item) : playTrack(item);
                el.innerHTML = `
                    <div class="list-rank">${index + 1}</div>
                    <img src="${item.image}" class="list-img">
                    <div style="flex:1; overflow:hidden;">
                        <div class="font-bold text-sm" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.title}</div>
                        <div class="text-xs text-secondary">${item.artist}</div>
                    </div>
                `;
                container.appendChild(el);
            });

            const newTitle = document.createElement('div');
            newTitle.className = 'section-title';
            newTitle.innerText = "Top New Releases";
            container.appendChild(newTitle);
            
            const newItems = chartItems.filter(i => isNewEpisode(i.date)).slice(0, 45);
            if(newItems.length === 0) container.innerHTML += '<div style="padding:20px; text-align:center; opacity:0.6;">No new chart entries this week.</div>';
            
            newItems.forEach((item, index) => {
                const el = document.createElement('div');
                el.className = 'list-item';
                el.onclick = () => playTrack(item);
                el.innerHTML = `
                    <div class="list-rank" style="color:var(--text-primary)">${index + 1}</div>
                    <img src="${item.image}" class="list-img">
                    <div style="flex:1; overflow:hidden;">
                        <div class="font-bold text-sm" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.title} <span class="new-badge">NEW </span></div>
                        <div class="text-xs text-secondary">${item.artist}</div>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        function handleSearch(e) {
            if (e.key === 'Enter') {
                document.getElementById('search-input').blur();
                if(currentFilter === 'charts') {
                    currentFilter = 'all';
                    document.querySelectorAll('.filters .chip').forEach(c => c.classList.remove('active'));
                    document.querySelector('.filters .chip').classList.add('active');
                }
                doSearch(e.target.value);
            }
        }

        async function doSearch(query) {
            const container = document.getElementById('search-results');
            container.innerHTML = '<div style="padding:20px; text-align:center; opacity:0.5">Searching...</div>';
            
            const results = await search(query);
            container.innerHTML = '';
            
            if(results.length === 0) {
                container.innerHTML = '<div style="text-align:center; margin-top:20px; color:var(--text-secondary);">No results found.</div>';
                return;
            }
            
            results.forEach(item => {
                const stats = getDeterministicStats(item.id.toString(), item.type === 'profile', item.date);
                const el = document.createElement('div');
                
                const verified = (item.type === 'profile' && stats.chirps > 50000000) ? VERIFIED_BADGE_HTML : '';
                
                let chartBadge = '';
                const chartRank = getChartRank(item.id.toString());
                const newRank = getTopNewRank(item.id.toString(), item.date);
                if (newRank) chartBadge = `<span class="chart-badge"> #${newRank} Top New</span>`;
                else if (chartRank) chartBadge = `<span class="chart-badge"> #${chartRank} Top Podcasts</span>`;

                if (item.type === 'profile') {
                    el.className = 'list-item';
                    el.onclick = () => openProfile(item);
                    
                    const statContainer = document.createElement('div');
                    statContainer.className = 'text-xs text-secondary flex items-center gap-1 info-col';
                    statContainer.style.marginTop = '4px';
                    statContainer.innerHTML = `<svg class="icon" style="width:12px;height:12px" viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg> <span class="odometer-container"></span>`;
                    
                    el.innerHTML = `
                        <img src="${item.image}" class="list-img" style="border-radius:50%">
                        <div style="flex:1" class="info-col">
                            <div class="font-bold">${item.title} ${verified}</div>
                            <div class="text-xs text-secondary">Podcast  ${item.artist} ${chartBadge}</div>
                        </div>
                        <button style="padding:8px; background:var(--surface-highlight); border-radius:20px; font-size:0.75rem; font-weight:bold; border:none; color:inherit;">View</button>
                    `;
                    el.querySelector('.info-col').appendChild(statContainer);
                    const odo = statContainer.querySelector('.odometer-container');
                    setTimeout(() => updateOdometer(odo, stats.chirps), 600);

                } else {
                    el.className = 'list-item';
                    el.onclick = () => playTrack(item);
                    
                    const statContainer = document.createElement('div');
                    statContainer.className = 'flex items-center text-xs text-secondary';
                    statContainer.style.gap = '4px';
                    statContainer.innerHTML = `<svg class="icon" style="width:12px; height:12px;" viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg> <span class="odometer-container"></span>`;

                    const newBadge = isNewEpisode(item.date) ? '<span class="new-badge">NEW </span>' : '';

                    el.innerHTML = `
                        <img src="${item.image}" class="list-img">
                        <div style="flex:1">
                            <div class="font-bold text-sm" style="display:-webkit-box; -webkit-line-clamp:1; -webkit-box-orient:vertical; overflow:hidden;">${item.title}${newBadge}</div>
                            <div class="text-xs text-secondary">${item.artist} ${chartBadge}</div>
                            <div class="flex items-center" style="gap:10px; margin-top:4px;">
                                <div class="stats-wrapper"></div>
                                <div class="text-xs text-secondary"> ${timeAgo(item.date)}</div>
                            </div>
                        </div>
                    `;
                    el.querySelector('.stats-wrapper').appendChild(statContainer);
                    const odo = statContainer.querySelector('.odometer-container');
                    setTimeout(() => updateOdometer(odo, stats.chirps), 600);
                }
                container.appendChild(el);
            });
        }

        async function openProfile(item) {
            currentProfileId = item.id.toString();
            const view = document.getElementById('view-profile-detail');
            
            document.getElementById('pd-img').src = item.image;
            document.getElementById('pd-title').innerText = item.title;
            
            const artEl = document.getElementById('pd-artist');
            artEl.innerText = item.artist;
            if(item.artist.includes(',')) artEl.classList.add('has-multi');
            else artEl.classList.remove('has-multi');

            updateProfileChirpBtn(savedProfileChirps.includes(currentProfileId));

            view.classList.remove('hidden');
            switchProfileTab('episodes');
            
            // RESET STATS
            activeProfileStats = null;
            document.getElementById('stat-chirps').innerHTML = '';
            document.getElementById('stat-cash').innerHTML = '';
            document.getElementById('pd-verified').classList.remove('visible');

            document.getElementById('pd-content-episodes').innerHTML = '<div class="spinner"></div>';
            
            const idToFetch = item.collectionId || item.id; 
            currentProfileEpisodes = await fetchProfileEpisodes(idToFetch, item.artist);

            // AGGREGATE STATS
            let aggChirps = 0;
            let aggCash = 0;
            
            if(currentProfileEpisodes.length === 0) {
                document.getElementById('pd-content-episodes').innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-secondary)">No episodes found.</div>';
            } else {
                currentProfileEpisodes.forEach(ep => {
                    const s = getDeterministicStats(ep.id.toString(), false, ep.date);
                    aggChirps += s.chirps;
                    aggCash += s.cash;
                });
                
                activeProfileStats = { chirps: aggChirps, cash: aggCash };
                
                setTimeout(() => {
                    updateOdometer(document.getElementById('stat-chirps'), aggChirps);
                    updateOdometer(document.getElementById('stat-cash'), formatCurrency(aggCash));
                }, 50);

                if (aggChirps >= 50000000) {
                    document.getElementById('pd-verified').classList.add('visible');
                }

                document.getElementById('pd-content-episodes').innerHTML = '';
                renderedEpisodeCount = 0;
                renderMoreEpisodes();
            }
        }

        function renderMoreEpisodes() {
            if(renderedEpisodeCount >= currentProfileEpisodes.length) return;
            const listContainer = document.getElementById('pd-content-episodes');
            const end = Math.min(renderedEpisodeCount + EPISODES_PER_PAGE, currentProfileEpisodes.length);
            
            for(let i = renderedEpisodeCount; i < end; i++) {
                const ep = currentProfileEpisodes[i];
                const epStats = getDeterministicStats(ep.id.toString(), false, ep.date);
                
                const el = document.createElement('div');
                el.className = 'list-item';
                if(!ep.artist) ep.artist = document.getElementById('pd-artist').innerText;
                
                const newBadge = isNewEpisode(ep.date) ? '<span class="new-badge">NEW </span>' : '';

                el.onclick = () => playTrack(ep);
                el.innerHTML = `
                    <div style="width:40px; height:40px; background:var(--surface-highlight); border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--text-primary);">
                        <svg class="icon" style="width:16px; height:16px; fill:currentColor; stroke:none;" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                    </div>
                    <div style="flex:1">
                        <div class="font-bold text-sm" style="display:-webkit-box; -webkit-line-clamp:1; -webkit-box-orient:vertical; overflow:hidden;">${ep.title}${newBadge}</div>
                        <div class="text-xs text-secondary flex items-center gap-2">
                             <span>${timeAgo(ep.date)}</span>  
                             <span class="flex items-center gap-1">
                                <svg class="icon" style="width:10px; height:10px" viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg> 
                                <span class="odometer-container"></span>
                             </span>
                        </div>
                    </div>
                `;
                listContainer.appendChild(el);
                const odo = el.querySelector('.odometer-container');
                setTimeout(() => updateOdometer(odo, epStats.chirps), 50 + (i - renderedEpisodeCount) * 20); 
            }
            renderedEpisodeCount = end;
        }

        function closeProfile() {
            document.getElementById('view-profile-detail').classList.add('hidden');
            activeProfileStats = null;
        }

        function switchProfileTab(tab) {
            document.getElementById('tab-episodes').classList.toggle('active', tab === 'episodes');
            document.getElementById('tab-stats').classList.toggle('active', tab === 'stats');
            
            const stats = document.getElementById('pd-content-stats');
            const eps = document.getElementById('pd-content-episodes');
            
            if(tab === 'stats') {
                eps.classList.add('hidden');
                stats.classList.remove('hidden');
                if(activeProfileStats) {
                    const chirpsEl = document.getElementById('stat-chirps');
                    const cashEl = document.getElementById('stat-cash');
                    chirpsEl.innerHTML = '';
                    cashEl.innerHTML = '';
                    setTimeout(() => {
                        updateOdometer(chirpsEl, activeProfileStats.chirps);
                        updateOdometer(cashEl, formatCurrency(activeProfileStats.cash));
                    }, 50);
                }
            } else {
                stats.classList.add('hidden');
                eps.classList.remove('hidden');
            }
        }

        function toggleProfileChirp() {
            const index = savedProfileChirps.indexOf(currentProfileId);
            if (index > -1) {
                savedProfileChirps.splice(index, 1);
                updateProfileChirpBtn(false);
            } else {
                savedProfileChirps.push(currentProfileId);
                updateProfileChirpBtn(true);
                showToast();
                document.getElementById('pd-chirp-btn').classList.add('popping');
                setTimeout(() => document.getElementById('pd-chirp-btn').classList.remove('popping'), 300);
            }
            localStorage.setItem('profile_chirps_v26', JSON.stringify(savedProfileChirps));
        }

        function updateProfileChirpBtn(active) {
            const btn = document.getElementById('pd-chirp-btn');
            const txt = document.getElementById('pd-chirp-text');
            if(active) {
                btn.classList.add('active');
                txt.innerText = "Chirped!";
            } else {
                btn.classList.remove('active');
                txt.innerText = "Chirp";
            }
        }

        function playTrack(track) {
            currentTrack = track;
            const artistName = track.artist || "Unknown Creator";
            
            document.getElementById('mini-img').src = track.image;
            document.getElementById('mini-img').style.opacity = 1;
            document.getElementById('mini-title').innerText = track.title;
            document.getElementById('mini-artist').innerText = artistName;
            
            document.getElementById('fp-img').src = track.image;
            document.getElementById('fp-title').innerText = track.title;
            
            const fpArtistEl = document.getElementById('fp-artist');
            fpArtistEl.innerText = artistName;
            if(artistName.includes(',')) fpArtistEl.classList.add('has-multi');
            else fpArtistEl.classList.remove('has-multi');

            const fpBtn = document.getElementById('fp-bird-btn');
            const isSaved = savedChirps.some(t => t.id === track.id);
            fpBtn.style.background = isSaved ? 'var(--text-primary)' : 'var(--surface-highlight)';
            fpBtn.style.color = isSaved ? 'var(--bg-color)' : 'inherit';

            const audio = document.getElementById('audio-player');
            audio.src = track.src;
            audio.play().then(() => {
                isPlaying = true;
                updatePlayIcons();
                openFullPlayer();
                startWaveform();
            });
        }

        function toggleTrackChirp() {
            if(!currentTrack) return;
            const btn = document.getElementById('fp-bird-btn');
            const idx = savedChirps.findIndex(t => t.id === currentTrack.id);
            if(idx > -1) {
                savedChirps.splice(idx, 1);
                btn.style.background = 'var(--surface-highlight)';
                btn.style.color = 'inherit';
            } else {
                savedChirps.unshift(currentTrack);
                btn.style.background = 'var(--text-primary)';
                btn.style.color = 'var(--bg-color)';
                showToast();
            }
            localStorage.setItem('chirps_v26', JSON.stringify(savedChirps));
            renderLibrary();
        }

        function togglePlay() {
            const audio = document.getElementById('audio-player');
            if(audio.paused && audio.src) {
                audio.play(); isPlaying = true;
                startWaveform();
            } else {
                audio.pause(); isPlaying = false;
            }
            updatePlayIcons();
        }
        
        function updatePlayIcons() {
            const path = isPlaying 
                ? '<rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect>' 
                : '<polygon points="5 3 19 12 5 21 5 3"></polygon>';
            document.querySelectorAll('#mini-play-btn svg, #fp-play-icon').forEach(s => s.innerHTML = path);
        }

        function showToast() {
            const t = document.getElementById('toast');
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        function timeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = (now - date) / 1000;
            if(diff < 60) return 'Just now';
            if(diff < 3600) return Math.floor(diff/60) + 'm ago';
            if(diff < 86400) return Math.floor(diff/3600) + 'h ago';
            return Math.floor(diff/86400) + 'd ago';
        }

        function renderLibrary() {
            const div = document.getElementById('library-list');
            div.innerHTML = '';
            if(!savedChirps.length) {
                div.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-secondary)">No saved chirps.</div>';
                return;
            }
            savedChirps.forEach(item => {
                const el = document.createElement('div');
                el.className = 'list-item';
                el.onclick = () => playTrack(item);
                el.innerHTML = `
                    <img src="${item.image}" class="list-img">
                    <div style="flex:1">
                        <div class="font-bold text-sm">${item.title}</div>
                        <div class="text-xs text-secondary">Saved Chirp</div>
                    </div>
                `;
                div.appendChild(el);
            });
        }

        function switchView(id, btn) {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById('view-'+id).classList.remove('hidden');
            
            // Sync Navs
            const targetText = btn.innerText.trim();
            document.querySelectorAll('.nav-item, .sidebar-item').forEach(item => {
                item.classList.remove('active');
                if(item.innerText.trim() === targetText) item.classList.add('active');
            });
        }

        function openFullPlayer() { 
            document.getElementById('full-player').classList.add('active'); 
            document.getElementById('mini-player').classList.add('expanded');
        }
        function closeFullPlayer() { 
            document.getElementById('full-player').classList.remove('active'); 
            document.getElementById('mini-player').classList.remove('expanded');
        }
        function toggleTheme() {
            const b = document.body;
            b.setAttribute('data-theme', b.getAttribute('data-theme')==='dark'?'light':'dark');
        }
        function handleArtistClick(artistString) {
            if(!artistString) return;
            if(artistString.includes(',')) {
                const creators = artistString.split(',').map(s => s.trim()).filter(s => s.length > 0);
                const modalList = document.getElementById('creators-list');
                modalList.innerHTML = '';
                creators.forEach(creator => {
                    const div = document.createElement('div');
                    div.className = 'creator-item';
                    div.innerHTML = `<span>${creator}</span> <svg class="icon" style="width:16px; opacity:0.5" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>`;
                    div.onclick = () => {
                        closeCreatorsModal(); closeFullPlayer(); closeProfile();
                        const discoverTab = document.querySelectorAll('.nav-item')[1]; 
                        switchView('discover', discoverTab);
                        document.getElementById('search-input').value = creator;
                        doSearch(creator);
                    };
                    modalList.appendChild(div);
                });
                document.getElementById('modal-overlay').classList.add('active');
                document.getElementById('creators-modal').classList.add('active');
            } else {
                closeFullPlayer(); closeProfile();
                const discoverTab = document.querySelectorAll('.nav-item')[1];
                switchView('discover', discoverTab);
                document.getElementById('search-input').value = artistString;
                doSearch(artistString);
            }
        }
        function closeCreatorsModal() {
            document.getElementById('modal-overlay').classList.remove('active');
            document.getElementById('creators-modal').classList.remove('active');
        }

        // Utils
        const canvas = document.getElementById('wave-canvas');
        const ctx = canvas.getContext('2d');
        let animId;
        function startWaveform() {
            if(animId) cancelAnimationFrame(animId);
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            loop();
        }
        function loop() {
            if(!isPlaying) return;
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-primary');
            const bars = 50; 
            const w = canvas.width/bars;
            for(let i=0; i<bars; i++) {
                const h = Math.abs(Math.sin(Date.now()/200 + i*0.5)) * canvas.height;
                ctx.fillRect(i*w, (canvas.height-h)/2, w-2, h);
            }
            animId = requestAnimationFrame(loop);
        }
        
        function seek(e) {
            const rect = document.getElementById('progress-container').getBoundingClientRect();
            const pct = (e.clientX - rect.left) / rect.width;
            const audio = document.getElementById('audio-player');
            if(audio.duration) audio.currentTime = pct * audio.duration;
        }

        const audioEl = document.getElementById('audio-player');
        audioEl.ontimeupdate = () => {
            if(audioEl.duration) {
                const pct = (audioEl.currentTime / audioEl.duration) * 100;
                document.getElementById('progress-fill').style.width = pct + '%';
                document.getElementById('time-current').innerText = formatTime(audioEl.currentTime);
                document.getElementById('time-total').innerText = formatTime(audioEl.duration);
            }
        };
        function formatTime(s) {
            if(!s) return "0:00";
            const m = Math.floor(s/60);
            const sec = Math.floor(s%60);
            return `${m}:${sec<10?'0':''}${sec}`;
        }
        function skip(v) { audioEl.currentTime += v; }
        function changeSpeed() {
             playbackSpeed = playbackSpeed === 1.0 ? 1.5 : (playbackSpeed === 1.5 ? 2.0 : 1.0);
             audioEl.playbackRate = playbackSpeed;
             document.getElementById('speed-btn').innerText = playbackSpeed + 'x';
        }

        init();

    </script>
</body>
    </html>
