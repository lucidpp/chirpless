<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chirpless</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&family=Oswald:wght@700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Roboto', 'sans-serif'],
                        logo: ['Oswald', 'sans-serif'],
                    },
                    colors: {
                        chirp: {
                            bg: '#0f0f0f',
                            sidebar: '#0f0f0f',
                            hover: '#272727',
                            border: '#303030',
                            text: '#f1f1f1',
                            secondary: '#aaaaaa',
                            red: '#cc0000',
                            blue: '#3ea6ff',
                            green: '#2ba640'
                        }
                    },
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f0f0f; color: #f1f1f1; overflow-x: hidden; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f0f0f; }
        ::-webkit-scrollbar-thumb { background: #717171; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }
        
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }
        
        .shorts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 10px;
        }

        /* Hide generic file inputs */
        input[type="file"] {
            display: none;
        }

        .tab-active {
            border-bottom: 3px solid #f1f1f1;
            color: #f1f1f1;
        }
        .tab-inactive {
            color: #aaaaaa;
            border-bottom: 3px solid transparent;
        }
        .tab-inactive:hover {
            color: #f1f1f1;
        }

        /* Smooth fade */
        .fade-enter { opacity: 0; transform: translateY(10px); }
        .fade-enter-active { opacity: 1; transform: translateY(0); transition: opacity 300ms, transform 300ms; }
        
        .aspect-video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 */
            height: 0;
            overflow: hidden;
            background: #000;
        }
        .aspect-video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Odometer Wheel Styles */
        .odometer-wrapper {
            display: inline-flex;
            overflow: hidden;
            height: 1.2em; /* Adjust based on font size */
            line-height: 1.2em;
            vertical-align: bottom;
        }
        
        .odometer-digit {
            display: inline-block;
            position: relative;
            transition: transform 1s cubic-bezier(0.16, 1, 0.3, 1);
            text-align: center;
        }

        .odometer-digit-strip {
            display: flex;
            flex-direction: column;
        }
        
        .odometer-digit-strip span {
            display: block;
            height: 1.2em;
            line-height: 1.2em;
        }

        /* Search Bar Shine */
        .search-container {
            position: relative;
            overflow: hidden;
        }
        .search-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.1), transparent);
            transform: skewX(-25deg);
            transition: 0.5s;
            pointer-events: none;
        }
        .search-container:hover::after {
            left: 150%;
            transition: 0.7s ease-in-out;
        }

        /* Like Explosion Particles */
        .particle {
            position: absolute;
            pointer-events: none;
            border-radius: 50%;
            animation: pop 0.6s ease-out forwards;
        }
        @keyframes pop {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tw-translate-x), var(--tw-translate-y)) scale(0); opacity: 0; }
        }

        /* Sidebar Styling Refinements */
        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            color: #f1f1f1;
            transition: background-color 0.2s;
        }
        .sidebar-item:hover {
            background-color: #272727;
        }
        .sidebar-item i {
            width: 24px;
            text-align: center;
            font-size: 1.2rem;
        }
        .sidebar-item span {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .ambient-glow {
            transition: background 1s ease;
        }
    </style>
</head>
<body class="font-sans antialiased min-h-screen flex flex-col">

    <!-- ONBOARDING MODAL -->
    <div id="onboarding" class="fixed inset-0 z-50 bg-chirp-bg flex items-center justify-center p-4">
        <div class="bg-chirp-hover p-8 rounded-xl w-full max-w-2xl border border-chirp-border shadow-2xl">
            <h1 class="text-4xl font-logo font-bold mb-2 text-center text-white">Chirpless</h1>
            <p class="text-chirp-secondary text-center mb-8">Create your channel identity to start creating.</p>
            
            <form id="onboardingForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Images -->
                    <div class="space-y-4">
                        <div class="flex flex-col items-center">
                            <div class="w-24 h-24 rounded-full bg-chirp-bg border-2 border-chirp-border overflow-hidden mb-2 relative group cursor-pointer" onclick="document.getElementById('pfpInput').click()">
                                <img id="pfpPreview" src="https://ui-avatars.com/api/?name=User&background=random" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                                    <i class="fa-solid fa-camera"></i>
                                </div>
                            </div>
                            <label class="text-sm text-chirp-secondary">Profile Picture</label>
                            <input type="file" id="pfpInput" accept="image/*">
                        </div>

                        <div class="flex flex-col items-center">
                            <div class="w-full h-24 rounded-lg bg-chirp-bg border-2 border-chirp-border overflow-hidden mb-2 relative group cursor-pointer" onclick="document.getElementById('bannerInput').click()">
                                <img id="bannerPreview" src="https://via.placeholder.com/600x150/000000/333333?text=Channel+Banner" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                                    <i class="fa-solid fa-image"></i>
                                </div>
                            </div>
                            <label class="text-sm text-chirp-secondary">Channel Banner</label>
                            <input type="file" id="bannerInput" accept="image/*">
                        </div>
                    </div>

                    <!-- Details -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Channel Name</label>
                            <input type="text" id="channelName" required class="w-full bg-chirp-bg border border-chirp-border rounded p-2 focus:border-chirp-blue outline-none transition" placeholder="e.g. Tech Guru">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Handle</label>
                            <div class="flex items-center bg-chirp-bg border border-chirp-border rounded px-2">
                                <span class="text-chirp-secondary">@</span>
                                <input type="text" id="channelHandle" required class="w-full bg-transparent p-2 outline-none" placeholder="techguru">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Subscriber Count (Start)</label>
                            <input type="number" id="subCount" value="0" class="w-full bg-chirp-bg border border-chirp-border rounded p-2 focus:border-chirp-blue outline-none" placeholder="0">
                        </div>
                         <div>
                            <label class="block text-sm font-medium mb-1">Country</label>
                            <select id="country" class="w-full bg-chirp-bg border border-chirp-border rounded p-2 outline-none">
                                <option value="United States">United States</option>
                                <option value="United Kingdom">United Kingdom</option>
                                <option value="Canada">Canada</option>
                                <option value="Germany">Germany</option>
                                <option value="Japan">Japan</option>
                                <option value="Brazil">Brazil</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Bio / About</label>
                    <textarea id="channelBio" rows="3" class="w-full bg-chirp-bg border border-chirp-border rounded p-2 focus:border-chirp-blue outline-none resize-none" placeholder="Tell viewers about your channel..."></textarea>
                </div>

                <button type="submit" class="w-full bg-chirp-blue text-black font-bold py-2 rounded-full hover:bg-blue-400 transition">Create Channel</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP STRUCTURE (Hidden initially) -->
    <div id="app" class="hidden flex-1 flex flex-col h-screen">
        
        <!-- HEADER -->
        <nav class="h-14 bg-chirp-bg flex items-center justify-between px-6 fixed w-full top-0 z-40 border-b border-chirp-border/10">
            <div class="flex items-center gap-6">
                <button class="p-2 hover:bg-chirp-hover rounded-full w-10 h-10 flex items-center justify-center">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
                <div class="flex items-center cursor-pointer" onclick="router.navigate('channel')">
                    <span class="font-logo font-bold text-2xl tracking-tight text-white select-none">Chirpless</span>
                </div>
            </div>

            <div class="hidden md:flex flex-1 max-w-2xl mx-10">
                <div class="flex w-full search-container rounded-full group">
                    <input type="text" placeholder="Search" class="w-full bg-[#121212] border border-[#303030] rounded-l-full py-2 px-4 focus:border-blue-500 outline-none placeholder-gray-500 transition group-hover:bg-black">
                    <button class="bg-[#222222] border border-l-0 border-[#303030] rounded-r-full px-5 py-2 hover:bg-[#303030] transition relative z-10">
                        <i class="fa-solid fa-magnifying-glass text-gray-400"></i>
                    </button>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <button onclick="ui.toggleUploadModal()" class="p-2 hover:bg-chirp-hover rounded-full w-10 h-10 flex items-center justify-center relative group">
                    <i class="fa-solid fa-video text-xl group-hover:text-white transition"></i>
                    <span class="absolute -bottom-10 bg-gray-600 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition pointer-events-none">Create</span>
                </button>
                <button onclick="router.navigate('studio')" class="p-2 hover:bg-chirp-hover rounded-full w-10 h-10 flex items-center justify-center group relative" title="Manage Videos">
                    <i class="fa-solid fa-wand-magic-sparkles text-xl group-hover:text-chirp-blue transition"></i>
                </button>
                <div class="w-8 h-8 rounded-full overflow-hidden cursor-pointer border border-transparent hover:border-chirp-blue transition" onclick="router.navigate('channel')">
                    <img id="navPfp" src="" class="w-full h-full object-cover">
                </div>
            </div>
        </nav>

        <div class="flex flex-1 pt-14 overflow-hidden">
            <!-- SIDEBAR -->
            <aside class="w-20 md:w-64 bg-chirp-sidebar hidden md:flex flex-col overflow-y-auto pb-4 shrink-0 px-3">
                <div class="space-y-1 mt-3">
                    <div onclick="router.navigate('channel')" class="sidebar-item">
                        <i class="fa-solid fa-house"></i>
                        <span>Home</span>
                    </div>
                    <div onclick="router.navigate('shorts')" class="sidebar-item">
                        <i class="fa-solid fa-bolt"></i>
                        <span>Shorts</span>
                    </div>
                    <div class="sidebar-item">
                        <i class="fa-solid fa-clapperboard"></i>
                        <span>Subscriptions</span>
                    </div>
                </div>
                <hr class="border-chirp-border my-3 mx-2">
                <div class="space-y-1">
                    <h3 class="px-3 py-1 font-bold text-base mb-1 flex items-center gap-2">You <i class="fa-solid fa-chevron-right text-xs"></i></h3>
                    <div onclick="router.navigate('studio')" class="sidebar-item">
                         <i class="fa-solid fa-user-gear"></i>
                        <span>Your Channel</span>
                    </div>
                    <div onclick="router.navigate('history')" class="sidebar-item">
                        <i class="fa-solid fa-clock-rotate-left"></i>
                        <span>History</span>
                    </div>
                    <div onclick="router.navigate('playlists')" class="sidebar-item">
                        <i class="fa-solid fa-list-ul"></i>
                        <span>Playlists</span>
                    </div>
                     <div class="sidebar-item">
                        <i class="fa-regular fa-thumbs-up"></i>
                        <span>Liked videos</span>
                    </div>
                </div>
                <hr class="border-chirp-border my-3 mx-2">
                <div class="px-2">
                    <button onclick="simulation.nextDay()" class="w-full bg-gradient-to-r from-chirp-blue to-purple-600 text-white font-bold py-3 rounded-lg shadow-lg hover:opacity-90 hover:scale-[1.02] transition active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-calendar-day"></i> Next Day
                    </button>
                    <p id="currentDayDisplay" class="text-center text-xs text-chirp-secondary mt-2 font-mono">Day 1</p>
                </div>
            </aside>

            <!-- MAIN CONTENT AREA -->
            <main id="mainContent" class="flex-1 overflow-y-auto bg-chirp-bg p-4 relative scroll-smooth">
                
                <!-- CHANNEL VIEW -->
                <div id="channelView" class="max-w-6xl mx-auto fade-enter-active">
                    <!-- Banner -->
                    <div class="w-full h-32 md:h-52 rounded-xl overflow-hidden bg-gray-800 mb-6">
                        <img id="channelBanner" src="" class="w-full h-full object-cover">
                    </div>

                    <!-- Header -->
                    <div class="flex flex-col md:flex-row gap-6 items-center md:items-start mb-6 px-4">
                        <div class="w-32 h-32 md:w-40 md:h-40 rounded-full overflow-hidden border-4 border-chirp-bg -mt-20 z-10">
                            <img id="channelPfp" src="" class="w-full h-full object-cover bg-black">
                        </div>
                        <div class="flex-1 text-center md:text-left">
                            <h1 class="text-3xl font-bold flex items-center justify-center md:justify-start gap-2">
                                <span id="displayName"></span>
                                <i id="channelVerified" class="hidden fa-solid fa-circle-check text-chirp-secondary text-lg" title="Verified"></i>
                            </h1>
                            <div class="text-chirp-secondary text-sm flex flex-col md:flex-row gap-2 mt-1 items-center md:items-start">
                                <span id="displayHandle"></span>
                                <span class="hidden md:inline">â€¢</span>
                                <span id="displaySubs" class="odometer-target">0</span> subscribers
                                <span class="hidden md:inline">â€¢</span>
                                <span id="displayVideoCount">0 videos</span>
                            </div>
                            <div class="mt-2 text-chirp-secondary text-sm truncate max-w-2xl cursor-pointer" onclick="ui.switchTab('about')">
                                <span id="bioSnippet"></span> <span class="font-bold text-white">...more</span>
                            </div>
                            <div class="mt-4 flex gap-2 justify-center md:justify-start">
                                <button class="bg-[#272727] hover:bg-[#3f3f3f] text-sm font-medium py-2 px-4 rounded-full transition">Customize channel</button>
                                <button onclick="router.navigate('studio')" class="bg-[#272727] hover:bg-[#3f3f3f] text-sm font-medium py-2 px-4 rounded-full transition">Manage videos</button>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="border-b border-chirp-border mb-6 flex gap-6 px-4 overflow-x-auto">
                        <button onclick="ui.switchTab('home')" class="tab-btn tab-active pb-3 font-medium uppercase text-sm" data-tab="home">Home</button>
                        <button onclick="ui.switchTab('videos')" class="tab-btn tab-inactive pb-3 font-medium uppercase text-sm" data-tab="videos">Videos</button>
                        <button onclick="ui.switchTab('shorts')" class="tab-btn tab-inactive pb-3 font-medium uppercase text-sm" data-tab="shorts">Shorts</button>
                        <button onclick="ui.switchTab('playlists')" class="tab-btn tab-inactive pb-3 font-medium uppercase text-sm" data-tab="playlists">Playlists</button>
                        <button onclick="ui.switchTab('about')" class="tab-btn tab-inactive pb-3 font-medium uppercase text-sm" data-tab="about">About</button>
                    </div>

                    <!-- Tab Contents -->
                    <div id="tab-home" class="tab-content block">
                        <div id="emptyState" class="text-center py-20 hidden">
                            <div class="bg-[#1f1f1f] w-32 h-32 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fa-solid fa-video text-4xl text-chirp-secondary"></i>
                            </div>
                            <h3 class="text-xl font-bold">Upload a video to get started</h3>
                            <p class="text-chirp-secondary mb-4">Start sharing your story with the world.</p>
                            <button onclick="ui.toggleUploadModal()" class="bg-chirp-blue text-black font-bold py-2 px-4 rounded-full">Upload Video</button>
                        </div>
                        <div id="latestVideosGrid" class="video-grid"></div>
                    </div>

                    <div id="tab-videos" class="tab-content hidden">
                        <h2 class="text-lg font-bold mb-4">Videos</h2>
                        <div id="allVideosGrid" class="video-grid"></div>
                    </div>

                    <div id="tab-shorts" class="tab-content hidden">
                        <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-bolt text-chirp-red"></i> Shorts</h2>
                        <div id="shortsGrid" class="shorts-grid"></div>
                    </div>

                    <div id="tab-playlists" class="tab-content hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold">Created Playlists</h2>
                            <button onclick="playlistMgr.create()" class="text-sm bg-[#272727] hover:bg-[#3f3f3f] px-3 py-1 rounded-full font-medium">
                                <i class="fa-solid fa-plus mr-1"></i> New Playlist
                            </button>
                        </div>
                        <div id="playlistsGrid" class="video-grid"></div>
                    </div>

                    <div id="tab-about" class="tab-content hidden">
                        <div class="flex flex-col md:flex-row gap-8">
                            <div class="flex-1">
                                <h3 class="text-lg font-bold mb-2">Description</h3>
                                <p id="fullBio" class="whitespace-pre-wrap text-sm leading-relaxed text-gray-300"></p>
                            </div>
                            <div class="w-full md:w-80 space-y-4">
                                <h3 class="text-lg font-bold border-b border-chirp-border pb-2">Stats</h3>
                                <div class="space-y-3 text-sm">
                                    <div class="border-b border-chirp-border pb-3">
                                        Joined <span id="joinDate"></span>
                                    </div>
                                    <div class="border-b border-chirp-border pb-3">
                                        <span id="totalViewsStats" class="odometer-target">0</span> views
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fa-solid fa-earth-americas text-chirp-secondary"></i>
                                        <span id="countryDisplay"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STUDIO / MANAGE VIDEOS VIEW -->
                <div id="studioView" class="hidden max-w-7xl mx-auto p-4">
                    <h1 class="text-2xl font-bold mb-6">Channel Studio</h1>
                    
                    <!-- Top Analytics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-[#1f1f1f] p-5 rounded-xl border border-chirp-border">
                            <h3 class="text-chirp-secondary text-sm font-medium mb-1">Total Revenue (Est.)</h3>
                            <div class="text-2xl font-bold text-chirp-green">$<span id="studioRevenue">0.00</span></div>
                            <p class="text-xs text-chirp-secondary mt-2">Lifetime earnings</p>
                        </div>
                        <div class="bg-[#1f1f1f] p-5 rounded-xl border border-chirp-border">
                            <h3 class="text-chirp-secondary text-sm font-medium mb-1">Views (Today)</h3>
                            <div class="text-2xl font-bold" id="studioViewsToday">0</div>
                            <p class="text-xs text-chirp-green mt-2"><i class="fa-solid fa-arrow-up"></i> Live</p>
                        </div>
                         <div class="bg-[#1f1f1f] p-5 rounded-xl border border-chirp-border">
                            <h3 class="text-chirp-secondary text-sm font-medium mb-1">Views (Lifetime)</h3>
                            <div class="text-2xl font-bold" id="studioViewsLife">0</div>
                        </div>
                        <div class="bg-[#1f1f1f] p-5 rounded-xl border border-chirp-border">
                            <h3 class="text-chirp-secondary text-sm font-medium mb-1">Subscribers</h3>
                            <div class="text-2xl font-bold" id="studioSubs">0</div>
                        </div>
                    </div>

                    <div class="flex gap-6 flex-col lg:flex-row">
                        <!-- Video List -->
                        <div class="flex-1 bg-[#1f1f1f] rounded-xl border border-chirp-border overflow-hidden">
                            <div class="p-4 border-b border-chirp-border flex justify-between items-center">
                                <h3 class="font-bold">Video Content</h3>
                                <span class="text-xs text-chirp-secondary" id="storageCount">0/2 Videos (Storage Limit)</span>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-[#121212] text-chirp-secondary uppercase text-xs">
                                        <tr>
                                            <th class="p-4">Video</th>
                                            <th class="p-4">Date</th>
                                            <th class="p-4">Views</th>
                                            <th class="p-4">Likes</th>
                                            <th class="p-4 text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studioVideoList" class="divide-y divide-chirp-border">
                                        <!-- Studio Items -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="studioEmpty" class="hidden p-8 text-center text-chirp-secondary">
                                No videos found.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GENERIC LIST VIEW (Shorts, History, Subscriptions) -->
                <div id="genericView" class="hidden max-w-6xl mx-auto">
                    <h2 id="genericTitle" class="text-2xl font-bold mb-6"></h2>
                    <div id="genericGrid" class="video-grid"></div>
                </div>

                <!-- PLAYLIST DETAIL VIEW -->
                <div id="playlistDetailView" class="hidden max-w-6xl mx-auto flex flex-col md:flex-row gap-8">
                    <!-- Playlist Sidebar -->
                    <div class="w-full md:w-80 shrink-0">
                         <div class="bg-gradient-to-b from-[#444] to-[#111] p-6 rounded-xl min-h-[500px] flex flex-col text-center md:text-left sticky top-4">
                            <div class="aspect-video bg-black rounded-xl overflow-hidden mb-4 shadow-xl">
                                <img id="plDetailThumb" src="" class="w-full h-full object-cover">
                            </div>
                            <h2 id="plDetailTitle" class="text-2xl font-bold mb-2"></h2>
                            <p id="plDetailOwner" class="text-sm font-bold text-white mb-1"></p>
                            <div class="text-xs text-[#aaa] mb-4">
                                <span id="plDetailVideoCount"></span> videos â€¢ <span id="plDetailViews" class="odometer-target">0</span> views
                            </div>
                            <div class="flex gap-2 mt-auto">
                                <button class="flex-1 bg-white text-black font-bold py-2 rounded-full hover:bg-gray-200"><i class="fa-solid fa-play mr-2"></i> Play all</button>
                                <button class="w-10 h-10 flex items-center justify-center bg-[#ffffff1a] rounded-full hover:bg-[#ffffff33]"><i class="fa-solid fa-shuffle text-white"></i></button>
                            </div>
                         </div>
                    </div>
                    <!-- Playlist Videos -->
                    <div class="flex-1 space-y-2" id="plDetailList">
                        <!-- Items injected here -->
                    </div>
                </div>

                <!-- WATCH VIEW -->
                <div id="watchView" class="hidden max-w-[1700px] mx-auto flex flex-col lg:flex-row gap-6">
                    <!-- Left: Player & Comments -->
                    <div class="flex-1">
                        <!-- Player -->
                        <div id="playerContainer" class="w-full bg-black rounded-none md:rounded-xl overflow-hidden aspect-video-container shadow-lg shadow-black/50 ambient-glow">
                            <video id="mainPlayer" controls class="w-full h-full object-contain" controlsList="nodownload"></video>
                        </div>

                        <!-- Info -->
                        <div class="py-4 px-2 md:px-0">
                            <h1 id="videoTitle" class="text-xl md:text-2xl font-bold mb-2 line-clamp-2"></h1>
                            
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full overflow-hidden cursor-pointer" onclick="router.navigate('channel')">
                                        <img id="videoOwnerPfp" src="" class="w-full h-full object-cover">
                                    </div>
                                    <div>
                                        <div class="flex items-center gap-1 cursor-pointer hover:text-gray-300" onclick="videoMgr.showCollabModal()">
                                            <div id="videoOwnerName" class="font-bold text-sm"></div>
                                            <i id="videoVerified" class="hidden fa-solid fa-circle-check text-chirp-secondary text-xs" title="Verified"></i>
                                        </div>
                                        <div id="videoOwnerSubs" class="text-xs text-chirp-secondary"></div>
                                    </div>
                                    <button class="ml-4 bg-white text-black px-4 py-2 rounded-full font-bold text-sm hover:bg-gray-200">Subscribe</button>
                                </div>

                                <div class="flex items-center gap-2 overflow-x-auto pb-2 md:pb-0">
                                    <div class="flex bg-[#222222] rounded-full h-9 items-center">
                                        <button id="likeBtn" class="flex items-center gap-2 px-4 h-full hover:bg-[#303030] rounded-l-full border-r border-[#303030] relative overflow-hidden" onclick="videoMgr.likeVideo(this)">
                                            <i class="fa-regular fa-thumbs-up transition-transform duration-200"></i>
                                            <span id="likeCount" class="text-sm font-medium odometer-target">0</span>
                                        </button>
                                        <button class="px-4 h-full hover:bg-[#303030] rounded-r-full" onclick="videoMgr.dislikeVideo()">
                                            <i class="fa-regular fa-thumbs-down"></i>
                                        </button>
                                    </div>
                                    <button class="flex items-center gap-2 px-4 py-2 bg-[#222222] rounded-full hover:bg-[#303030] text-sm font-medium">
                                        <i class="fa-solid fa-share"></i> Share
                                    </button>
                                    <button class="flex items-center gap-2 px-4 py-2 bg-[#222222] rounded-full hover:bg-[#303030] text-sm font-medium">
                                        <i class="fa-solid fa-download"></i> Download
                                    </button>
                                </div>
                            </div>

                            <!-- Description Box -->
                            <div id="descContainer" class="bg-[#222222] rounded-xl p-3 mt-4 text-sm cursor-pointer hover:bg-[#303030] transition ambient-glow">
                                <div class="font-bold mb-1">
                                    <span id="viewCount" class="odometer-target">0</span> views â€¢ <span id="uploadDate"></span>
                                </div>
                                <p id="videoDesc" class="text-white whitespace-pre-wrap">No description provided.</p>
                            </div>
                        </div>

                        <!-- Comments Section -->
                        <div class="mt-6 px-2 md:px-0">
                            <div class="flex items-center gap-8 mb-6">
                                <h3 class="text-xl font-bold"><span id="commentCount">0</span> Comments</h3>
                                <div class="flex items-center gap-2 text-sm font-medium cursor-pointer">
                                    <i class="fa-solid fa-arrow-down-short-wide"></i> Sort by
                                </div>
                            </div>

                            <!-- Comment Input -->
                            <div class="flex gap-4 mb-8">
                                <div class="w-10 h-10 rounded-full overflow-hidden shrink-0">
                                    <img id="commentPfp" src="" class="w-full h-full object-cover">
                                </div>
                                <div class="flex-1">
                                    <input type="text" id="commentInput" placeholder="Add a comment..." class="w-full bg-transparent border-b border-chirp-border focus:border-white outline-none pb-1 transition placeholder-gray-500">
                                    <div class="flex justify-end mt-2 gap-2">
                                        <button onclick="document.getElementById('commentInput').value=''" class="px-3 py-2 text-sm font-medium hover:bg-chirp-hover rounded-full">Cancel</button>
                                        <button onclick="videoMgr.postComment()" class="px-3 py-2 text-sm font-medium bg-chirp-blue text-black rounded-full hover:bg-blue-400">Comment</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Featured Comments Toggle -->
                            <div id="viewCommentsBtn" class="w-full py-3 border border-chirp-border rounded-full text-center font-bold text-chirp-blue hover:bg-blue-900/20 cursor-pointer mb-4 select-none" onclick="ui.toggleComments()">
                                View Featured Comments
                            </div>

                            <div id="commentsList" class="space-y-6 hidden">
                                <!-- Comments injected here -->
                            </div>
                        </div>
                    </div>

                    <!-- Right: Recommendations -->
                    <div class="w-full lg:w-[400px] shrink-0 px-2 lg:px-0">
                        <div id="recommendationsList" class="space-y-3">
                            <!-- Recs injected here -->
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- UPLOAD MODAL -->
    <div id="uploadModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div class="bg-[#282828] w-full max-w-4xl h-[80vh] rounded-xl flex flex-col shadow-2xl relative">
            <div class="flex justify-between items-center p-4 border-b border-[#3e3e3e]">
                <h2 class="text-xl font-bold">Upload videos</h2>
                <button onclick="ui.toggleUploadModal()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            
            <div class="flex-1 flex flex-col items-center justify-center p-10 text-center" id="uploadDropZone">
                <div class="w-32 h-32 rounded-full bg-[#1f1f1f] flex items-center justify-center mb-6">
                    <i class="fa-solid fa-upload text-5xl text-chirp-secondary"></i>
                </div>
                <h3 class="text-lg font-medium mb-1">Select files to upload</h3>
                <p class="text-xs text-chirp-secondary mb-6">Your videos will be private until you publish them.</p>
                
                <button id="selectFilesBtn" onclick="document.getElementById('videoInput').click()" class="bg-chirp-blue text-black font-bold py-2 px-6 rounded-sm uppercase text-sm">Select Files</button>
                <input type="file" id="videoInput" accept="video/mp4,video/webm" onchange="videoMgr.handleFileSelect(this)">
            </div>

            <!-- Upload details form (hidden initially) -->
            <div id="uploadDetails" class="hidden flex-1 p-6 overflow-y-auto flex-col md:flex-row gap-6">
                <div class="flex-1 space-y-4">
                    <div>
                        <label class="block text-xs font-bold mb-1 text-chirp-secondary">Title (required)</label>
                        <input type="text" id="upTitle" class="w-full bg-chirp-bg border border-chirp-border rounded p-3 text-sm focus:border-chirp-blue outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold mb-1 text-chirp-secondary">Description</label>
                        <textarea id="upDesc" rows="5" class="w-full bg-chirp-bg border border-chirp-border rounded p-3 text-sm focus:border-chirp-blue outline-none resize-none"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold mb-1 text-chirp-secondary">Collaborator (Optional)</label>
                        <select id="collabSelect" class="w-full bg-chirp-bg border border-chirp-border rounded p-3 text-sm focus:border-chirp-blue outline-none">
                            <option value="">None</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    <div class="flex items-center gap-4">
                         <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="upIsShort" class="w-4 h-4 text-chirp-blue">
                            <span class="text-sm">Upload as Short</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                             <input type="checkbox" id="upAddToPlaylist" class="w-4 h-4 text-chirp-blue">
                            <span class="text-sm">Add to 'My Videos' Playlist</span>
                        </label>
                    </div>
                </div>
                <div class="w-full md:w-72 bg-[#1f1f1f] rounded-lg p-4 flex flex-col gap-2">
                    <div class="aspect-video bg-black rounded overflow-hidden">
                        <video id="previewPlayer" class="w-full h-full object-cover"></video>
                    </div>
                    <div class="text-xs text-chirp-secondary mt-2">
                        <p>Filename: <span id="upFilename" class="text-white truncate"></span></p>
                    </div>
                </div>
            </div>
            
            <div id="uploadActions" class="hidden p-4 border-t border-[#3e3e3e] flex justify-end gap-3">
                 <button onclick="ui.resetUpload()" class="text-sm font-medium px-4 py-2 hover:bg-[#3e3e3e] rounded">Cancel</button>
                <button onclick="videoMgr.finalizeUpload()" class="bg-chirp-blue text-black font-bold py-2 px-6 rounded-sm uppercase text-sm">Publish</button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- State Management ---
        const store = {
            user: null,
            videos: [],
            playlists: [],
            currentVideoId: null,
            day: 1,
            stats: {
                revenue: 0,
                viewsToday: 0
            }
        };

        const collaborators = [
            { name: "MrBeast", subs: 320000000 },
            { name: "The Rock", subs: 70000000 },
            { name: "Hulk Hogan", subs: 5000000 },
            { name: "PewDiePie", subs: 111000000 },
            { name: "MKBHD", subs: 19000000 },
            { name: "Gordon Ramsay", subs: 20000000 },
            { name: "Billie Eilish", subs: 45000000 },
            { name: "Ninja", subs: 23000000 },
            { name: "Elon Musk", subs: 150000000 },
            { name: "Mark Zuckerberg", subs: 12 },
            { name: "Jeff Bezos", subs: 500 },
            { name: "Shroud", subs: 10000000 },
            { name: "Pokimane", subs: 6000000 }
        ];

        const bots = [
            { name: "TechFan99", pfp: "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" },
            { name: "PixelPerfect", pfp: "https://api.dicebear.com/7.x/avataaars/svg?seed=Aneka" },
            { name: "CodeMaster", pfp: "https://api.dicebear.com/7.x/avataaars/svg?seed=Bob" },
            { name: "VistaViewer", pfp: "https://api.dicebear.com/7.x/avataaars/svg?seed=Jack" },
            { name: "DigitalDream", pfp: "https://api.dicebear.com/7.x/avataaars/svg?seed=Molly" },
            { name: "StreamQueen", pfp: "https://api.dicebear.com/7.x/avataaars/svg?seed=Sarah" },
        ];

        const botComments = [
            "This is actually insane quality! ðŸ”¥",
            "First view! Notification squad wya?",
            "Underrated channel, keep it up.",
            "The editing on this is next level.",
            "Make more of this content please!!",
            "Chirpless is taking over.",
            "Who is watching this in 2026? ðŸ‘‡",
            "Love the vibe of this video."
        ];

        // --- Utils ---
        const util = {
            formatNumber: (num) => {
                if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'B';
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num.toString();
            },
            getTimeAgo: (date) => {
                const seconds = Math.floor((new Date() - new Date(date)) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + " years ago";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + " months ago";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + " days ago";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + " hours ago";
                return "Just now";
            },
            getRandomInt: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,

            // Odometer Logic
            updateOdometer: (elementId, value) => {
                const el = document.getElementById(elementId);
                if (!el) return;
                
                let strValue = value.toString();
                strValue = util.formatNumber(value);

                if (!el.classList.contains('odometer-initialized')) {
                    el.classList.add('odometer-initialized');
                    el.innerHTML = ''; 
                    const wrapper = document.createElement('div');
                    wrapper.className = 'odometer-wrapper';
                    el.appendChild(wrapper);
                }

                const wrapper = el.querySelector('.odometer-wrapper');
                const currentDigits = wrapper.children;
                
                if (currentDigits.length !== strValue.length) {
                    wrapper.innerHTML = '';
                    for (let char of strValue) {
                        const digitContainer = document.createElement('div');
                        digitContainer.className = 'odometer-digit';
                        
                        if (/[0-9]/.test(char)) {
                            const strip = document.createElement('div');
                            strip.className = 'odometer-digit-strip';
                            for(let i=0; i<=9; i++) {
                                const span = document.createElement('span');
                                span.innerText = i;
                                strip.appendChild(span);
                            }
                            digitContainer.appendChild(strip);
                        } else {
                            digitContainer.innerText = char;
                        }
                        wrapper.appendChild(digitContainer);
                    }
                }

                Array.from(wrapper.children).forEach((digitDiv, idx) => {
                    const char = strValue[idx];
                    if (/[0-9]/.test(char)) {
                        const strip = digitDiv.querySelector('.odometer-digit-strip');
                        const num = parseInt(char);
                        if(strip) {
                            strip.style.transform = `translateY(-${num * 1.2}em)`;
                            strip.style.transition = `transform ${1 + (idx * 0.1)}s cubic-bezier(0.16, 1, 0.3, 1)`; 
                        }
                    } else {
                        if(digitDiv.innerText !== char && !digitDiv.querySelector('.odometer-digit-strip')) {
                             digitDiv.innerText = char;
                        }
                    }
                });
            },

            // Generate a random pleasant color for ambient mode
            getRandomColor: () => {
                const colors = [
                    '#3ea6ff', '#cc0000', '#2ba640', '#9c27b0', '#ff9800', '#e91e63', '#00bcd4', '#673ab7'
                ];
                return colors[Math.floor(Math.random() * colors.length)];
            }
        };

        // --- Core Logic ---
        
        const simulation = {
            nextDay: () => {
                store.day++;
                document.getElementById('currentDayDisplay').innerText = `Day ${store.day}`;
                store.stats.viewsToday = 0; // Reset daily counter

                // Process Videos
                store.videos.forEach(vid => {
                    // 1. Decay Logic (Video Falloff)
                    // Age multiplied by decayRate means some videos age faster/slower
                    const effectiveAge = (store.day - (vid.uploadDay || 1)) * vid.decayRate;
                    
                    let decay = 1;
                    if (effectiveAge > 7) decay = 0.5;   
                    if (effectiveAge > 30) decay = 0.1;  
                    if (effectiveAge > 90) decay = 0.01; 

                    // 2. View Growth
                    const subCount = store.user.subscribers;
                    const isFlop = Math.random() < 0.2; 
                    
                    let viewGrowth = 0;
                    
                    if (subCount > 0) {
                        if (isFlop) {
                            viewGrowth = util.getRandomInt(0, Math.ceil(subCount * 0.05));
                        } else {
                            viewGrowth = util.getRandomInt(Math.ceil(subCount * 0.1), Math.ceil(subCount * 0.4));
                        }
                        if(Math.random() > 0.95) viewGrowth *= 3; // Viral hit
                    } else {
                        // New channel luck
                        viewGrowth = util.getRandomInt(0, 100); 
                    }

                    // Apply Decay
                    viewGrowth = Math.floor(viewGrowth * decay);
                    if (viewGrowth < 0) viewGrowth = 0;

                    const likeGrowth = Math.floor(viewGrowth * (util.getRandomInt(2, 8) / 100)); 

                    vid.views += viewGrowth;
                    vid.likes += likeGrowth;
                    
                    // Convert Views to Subs (Approx 1 sub per 100-300 views for example)
                    // Or just random small percentage
                    const newSubs = Math.floor(viewGrowth * (Math.random() * 0.01));
                    store.user.subscribers += newSubs;

                    store.user.totalViews += viewGrowth;
                    store.stats.viewsToday += viewGrowth;
                    
                    // CPM Simulation ($2.00 - $5.00 per 1000 views)
                    const revenue = (viewGrowth / 1000) * (Math.random() * 3 + 2);
                    store.stats.revenue += revenue;

                    // 3. Comment Logic
                    vid.comments.forEach(c => {
                         if(c.isCreator) {
                             c.likes += util.getRandomInt(500, 50000); 
                         } else {
                             const potential = Math.max(1, Math.floor(vid.views * 0.0001));
                             if(Math.random() > 0.5) c.likes += util.getRandomInt(0, potential);
                         }
                    });

                    // Add new comments randomly
                    if(viewGrowth > 0 && Math.random() > 0.7) {
                         const bot = bots[util.getRandomInt(0, bots.length - 1)];
                         vid.comments.unshift({
                            id: 'c_' + Date.now() + Math.random(),
                            author: bot.name,
                            pfp: bot.pfp,
                            text: botComments[util.getRandomInt(0, botComments.length - 1)],
                            likes: 0,
                            date: 'Just now',
                            isCreator: false
                        });
                    }
                });
                
                // Process Playlists
                store.playlists.forEach(pl => {
                    pl.views += util.getRandomInt(0, 50);
                });

                // Refresh Current View
                ui.refreshCurrentView();
                
                // Global Total Views on channel header
                util.updateOdometer("displaySubs", store.user.subscribers);
            }
        };

        // Onboarding
        const onboarding = {
            init: () => {
                // Populate Collaborator Dropdown
                const sel = document.getElementById('collabSelect');
                collaborators.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.name;
                    opt.innerText = `${c.name} (${util.formatNumber(c.subs)} subs)`;
                    sel.appendChild(opt);
                });

                document.getElementById('onboardingForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const pfpFile = document.getElementById('pfpInput').files[0];
                    const bannerFile = document.getElementById('bannerInput').files[0];
                    const subs = parseInt(document.getElementById('subCount').value) || 0;
                    
                    store.user = {
                        name: document.getElementById('channelName').value,
                        handle: '@' + document.getElementById('channelHandle').value.replace('@', ''),
                        subscribers: subs,
                        isVerified: subs >= 100000,
                        bio: document.getElementById('channelBio').value,
                        country: document.getElementById('country').value,
                        joinDate: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }),
                        pfp: pfpFile ? URL.createObjectURL(pfpFile) : document.getElementById('pfpPreview').src,
                        banner: bannerFile ? URL.createObjectURL(bannerFile) : document.getElementById('bannerPreview').src,
                        totalViews: 0
                    };

                    // Initial Playlist
                    store.playlists.push({
                        id: 'pl_1',
                        title: 'My Favorites',
                        views: util.getRandomInt(10, 500),
                        videoCount: 0,
                        thumbnail: 'https://via.placeholder.com/300x169/111/555?text=Playlist',
                        videos: []
                    });

                    onboarding.complete();
                });

                // Previews
                ['pfp', 'banner'].forEach(type => {
                    document.getElementById(`${type}Input`).addEventListener('change', function(e) {
                        if (this.files && this.files[0]) {
                            document.getElementById(`${type}Preview`).src = URL.createObjectURL(this.files[0]);
                        }
                    });
                });
            },
            complete: () => {
                document.getElementById('onboarding').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                ui.renderUserInfo();
                router.navigate('channel');
            }
        };

        // Router
        const router = {
            currentPage: 'channel',
            navigate: (page, data = null) => {
                router.currentPage = page;
                
                // Pause video
                const player = document.getElementById('mainPlayer');
                player.pause();

                // Hide all main views
                ['channelView', 'watchView', 'genericView', 'playlistDetailView', 'studioView'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });

                if (page === 'channel') {
                    document.getElementById('channelView').classList.remove('hidden');
                    ui.switchTab('home');
                    util.updateOdometer("displaySubs", store.user.subscribers);
                } else if (page === 'watch') {
                    document.getElementById('watchView').classList.remove('hidden');
                    videoMgr.loadVideo(data);
                } else if (page === 'shorts') {
                    document.getElementById('genericView').classList.remove('hidden');
                    document.getElementById('genericTitle').innerText = "Shorts";
                    const shorts = store.videos.filter(v => v.type === 'short');
                    ui.renderGrid('genericGrid', shorts, true);
                } else if (page === 'studio') {
                    document.getElementById('studioView').classList.remove('hidden');
                    studioMgr.render();
                } else if (page === 'history') {
                    document.getElementById('genericView').classList.remove('hidden');
                    document.getElementById('genericTitle').innerText = "Watch History";
                     ui.renderGrid('genericGrid', store.videos);
                } else if (page === 'playlists') {
                     document.getElementById('channelView').classList.remove('hidden');
                     ui.switchTab('playlists');
                } else if (page === 'playlistView') {
                    document.getElementById('playlistDetailView').classList.remove('hidden');
                    playlistMgr.renderDetail(data);
                }
                
                document.getElementById('mainContent').scrollTop = 0;
            }
        };

        // Studio Manager
        const studioMgr = {
            render: () => {
                // Update Storage Count
                const count = store.videos.length;
                const limit = 2; // Auto delete logic now
                const storageEl = document.getElementById('storageCount');
                storageEl.innerText = `${count}/${limit} Videos (Auto-delete oldest > 2)`;
                storageEl.className = "text-xs text-chirp-secondary";

                // Update Stats
                document.getElementById('studioRevenue').innerText = util.formatNumber(store.stats.revenue); // Uses Format for Billions
                document.getElementById('studioViewsToday').innerText = util.formatNumber(store.stats.viewsToday);
                document.getElementById('studioViewsLife').innerText = util.formatNumber(store.user.totalViews);
                document.getElementById('studioSubs').innerText = util.formatNumber(store.user.subscribers);

                // Render List
                const list = document.getElementById('studioVideoList');
                list.innerHTML = '';
                
                if (count === 0) {
                    document.getElementById('studioEmpty').classList.remove('hidden');
                } else {
                    document.getElementById('studioEmpty').classList.add('hidden');
                    store.videos.forEach(vid => {
                        const tr = document.createElement('tr');
                        tr.className = 'hover:bg-[#1a1a1a]';
                        tr.innerHTML = `
                            <td class="p-4 flex gap-3 items-center">
                                <div class="w-24 h-14 bg-black rounded overflow-hidden shrink-0">
                                    <video src="${vid.src}" class="w-full h-full object-cover"></video>
                                </div>
                                <div class="truncate max-w-[200px] font-medium">${vid.title}</div>
                            </td>
                            <td class="p-4 text-chirp-secondary">${new Date(vid.uploadDate).toLocaleDateString()}</td>
                            <td class="p-4">${util.formatNumber(vid.views)}</td>
                            <td class="p-4">${util.formatNumber(vid.likes)}</td>
                            <td class="p-4 text-right">
                                <button onclick="studioMgr.deleteVideo('${vid.id}')" class="text-chirp-secondary hover:text-chirp-red transition px-2">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </td>
                        `;
                        list.appendChild(tr);
                    });
                }
            },
            deleteVideo: (id) => {
                if(confirm("Are you sure you want to delete this video?")) {
                    store.videos = store.videos.filter(v => v.id !== id);
                    // Also remove from playlist refs
                    store.playlists.forEach(pl => {
                         pl.videos = pl.videos.filter(vidId => vidId !== id);
                         pl.videoCount = pl.videos.length;
                    });
                    
                    studioMgr.render();
                    
                    // Update header count immediately
                    document.getElementById('displayVideoCount').innerText = store.videos.length + ' videos';
                }
            }
        };

        // UI Manager
        const ui = {
            renderUserInfo: () => {
                // Nav
                document.getElementById('navPfp').src = store.user.pfp;
                document.getElementById('commentPfp').src = store.user.pfp;
                
                // Channel Header
                document.getElementById('channelPfp').src = store.user.pfp;
                document.getElementById('channelBanner').src = store.user.banner;
                document.getElementById('displayName').innerText = store.user.name;
                document.getElementById('displayHandle').innerText = store.user.handle;
                document.getElementById('bioSnippet').innerText = store.user.bio.substring(0, 60);
                document.getElementById('fullBio').innerText = store.user.bio;
                document.getElementById('joinDate').innerText = store.user.joinDate;
                document.getElementById('countryDisplay').innerText = store.user.country;
                
                // Verification Badge (Header)
                if(store.user.isVerified) {
                    document.getElementById('channelVerified').classList.remove('hidden');
                }
            },
            
            refreshCurrentView: () => {
                // Refresh grids based on active view
                if(router.currentPage === 'channel') {
                    util.updateOdometer("totalViewsStats", store.user.totalViews);
                    if(!document.getElementById('tab-home').classList.contains('hidden')) {
                        ui.renderGrid('latestVideosGrid', store.videos.slice(0, 10), false);
                    }
                    if(!document.getElementById('tab-videos').classList.contains('hidden')) {
                         ui.renderGrid('allVideosGrid', store.videos.filter(v=>v.type==='video'));
                    }
                } else if (router.currentPage === 'watch') {
                     videoMgr.refreshWatchStats();
                     // Re-render comments to show scaled likes
                     videoMgr.renderComments(store.videos.find(v => v.id === store.currentVideoId));
                } else if (router.currentPage === 'playlistView') {
                    playlistMgr.refreshView();
                } else if (router.currentPage === 'studio') {
                    studioMgr.render();
                }
            },
            
            switchTab: (tabName) => {
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    if (btn.dataset.tab === tabName) {
                        btn.classList.add('tab-active');
                        btn.classList.remove('tab-inactive');
                    } else {
                        btn.classList.remove('tab-active');
                        btn.classList.add('tab-inactive');
                    }
                });
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`tab-${tabName}`).classList.remove('hidden');
                
                // Re-render grids on tab switch to ensure view counts are fresh
                if(tabName === 'home') ui.renderGrid('latestVideosGrid', store.videos.slice(0, 10), false);
                if(tabName === 'videos') ui.renderGrid('allVideosGrid', store.videos.filter(v=>v.type==='video'));
                if(tabName === 'shorts') ui.renderGrid('shortsGrid', store.videos.filter(v => v.type === 'short'), true);

                if(tabName === 'about') {
                     util.updateOdometer("totalViewsStats", store.user.totalViews);
                }
            },

            toggleUploadModal: () => {
                const modal = document.getElementById('uploadModal');
                // No blocking check anymore, just visual note or nothing since we auto-delete
                modal.classList.toggle('hidden');
            },

            resetUpload: () => {
                document.getElementById('uploadDropZone').classList.remove('hidden');
                document.getElementById('uploadDetails').classList.add('hidden');
                document.getElementById('uploadActions').classList.add('hidden');
                document.getElementById('videoInput').value = '';
                document.getElementById('previewPlayer').src = '';
                document.getElementById('collabSelect').value = '';
            },

            toggleComments: () => {
                const list = document.getElementById('commentsList');
                const btn = document.getElementById('viewCommentsBtn');
                list.classList.remove('hidden');
                btn.style.display = 'none';
                
                list.style.opacity = '0';
                list.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    list.style.transition = 'all 0.5s ease';
                    list.style.opacity = '1';
                    list.style.transform = 'translateY(0)';
                }, 10);
            },

            renderGrid: (containerId, videos, isShorts = false) => {
                const container = document.getElementById(containerId);
                container.innerHTML = '';

                if (videos.length === 0 && containerId === 'latestVideosGrid') {
                    document.getElementById('emptyState').classList.remove('hidden');
                    return;
                } else if (containerId === 'latestVideosGrid') {
                    document.getElementById('emptyState').classList.add('hidden');
                }

                videos.forEach(vid => {
                    const el = document.createElement('div');
                    el.className = 'cursor-pointer group';
                    el.onclick = () => router.navigate('watch', vid.id);

                    const collabText = vid.collaborator ? ` & ${vid.collaborator}` : '';

                    if (isShorts) {
                        el.innerHTML = `
                             <div class="aspect-[9/16] rounded-xl overflow-hidden bg-gray-800 relative mb-2">
                                <video src="${vid.src}" class="w-full h-full object-cover group-hover:scale-105 transition duration-300" onmouseover="this.play()" onmouseout="this.pause();this.currentTime=0;" muted></video>
                                <div class="absolute bottom-2 right-2 text-xs font-bold shadow-md drop-shadow-md">
                                    <i class="fa-solid fa-play"></i> ${util.formatNumber(vid.views)}
                                </div>
                            </div>
                            <h3 class="font-bold text-sm leading-tight line-clamp-2 mb-1">${vid.title}</h3>
                            <p class="text-xs text-chirp-secondary">${util.formatNumber(vid.views)} views</p>
                        `;
                    } else {
                        el.innerHTML = `
                            <div class="aspect-video rounded-xl overflow-hidden bg-gray-800 relative mb-3">
                                <video src="${vid.src}" class="w-full h-full object-cover group-hover:scale-105 transition duration-300" muted onmouseover="this.play()" onmouseout="this.pause();this.currentTime=0;"></video>
                                <div class="absolute bottom-2 right-2 bg-black/80 px-1 rounded text-xs font-bold">12:34</div>
                            </div>
                            <div class="flex gap-3 items-start">
                                <img src="${store.user.pfp}" class="w-9 h-9 rounded-full object-cover">
                                <div>
                                    <h3 class="font-bold text-sm leading-tight line-clamp-2 mb-1 group-hover:text-white text-white">${vid.title}</h3>
                                    <p class="text-xs text-chirp-secondary hover:text-white transition">${store.user.name}${collabText} <i class="fa-solid fa-circle-check text-[10px]"></i></p>
                                    <p class="text-xs text-chirp-secondary">${util.formatNumber(vid.views)} views â€¢ ${util.getTimeAgo(vid.uploadDate)}</p>
                                </div>
                            </div>
                        `;
                    }
                    container.appendChild(el);
                });
            },

            renderPlaylists: () => {
                const container = document.getElementById('playlistsGrid');
                container.innerHTML = '';
                store.playlists.forEach(pl => {
                    const el = document.createElement('div');
                    el.className = 'cursor-pointer group';
                    el.onclick = () => router.navigate('playlistView', pl.id);
                    el.innerHTML = `
                         <div class="aspect-video rounded-xl overflow-hidden bg-gray-800 relative mb-3 border-r-8 border-[#222]">
                                <div class="w-full h-full bg-[#111] flex items-center justify-center relative">
                                    <span class="text-2xl font-bold z-10">${pl.videoCount}</span>
                                    <div class="absolute inset-0 bg-black/50 flex items-center justify-center">
                                        <i class="fa-solid fa-list text-3xl"></i>
                                    </div>
                                    <img src="${pl.thumbnail}" class="absolute inset-0 w-full h-full object-cover opacity-50">
                                </div>
                            </div>
                            <h3 class="font-bold text-sm leading-tight mb-1">${pl.title}</h3>
                            <p class="text-xs text-chirp-secondary">View full playlist</p>
                    `;
                    container.appendChild(el);
                });
            },

            triggerExplosion: (element) => {
                const rect = element.getBoundingClientRect();
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                
                for(let i=0; i<8; i++) {
                    const particle = document.createElement('div');
                    particle.classList.add('particle');
                    particle.style.width = Math.random() * 6 + 4 + 'px';
                    particle.style.height = particle.style.width;
                    particle.style.background = util.getRandomColor();
                    particle.style.left = centerX + 'px';
                    particle.style.top = centerY + 'px';
                    
                    const angle = Math.random() * Math.PI * 2;
                    const velocity = Math.random() * 50 + 20;
                    const tx = Math.cos(angle) * velocity;
                    const ty = Math.sin(angle) * velocity;
                    
                    particle.style.setProperty('--tw-translate-x', `${tx}px`);
                    particle.style.setProperty('--tw-translate-y', `${ty}px`);
                    
                    element.appendChild(particle);
                    
                    setTimeout(() => particle.remove(), 600);
                }
            }
        };

        const playlistMgr = {
            create: () => {
                const name = prompt("Enter playlist name:");
                if(name) {
                    store.playlists.push({
                        id: 'pl_' + Date.now(),
                        title: name,
                        views: 0,
                        videoCount: 0,
                        thumbnail: 'https://via.placeholder.com/300x169/300/555?text=' + encodeURIComponent(name),
                        videos: []
                    });
                    ui.renderPlaylists();
                }
            },
            renderDetail: (id) => {
                const pl = store.playlists.find(p => p.id === id);
                if(!pl) return;
                
                document.getElementById('plDetailTitle').innerText = pl.title;
                document.getElementById('plDetailOwner').innerText = store.user.name;
                document.getElementById('plDetailVideoCount').innerText = pl.videoCount;
                document.getElementById('plDetailThumb').src = pl.thumbnail;
                
                util.updateOdometer('plDetailViews', pl.views);

                const list = document.getElementById('plDetailList');
                list.innerHTML = '';
                
                if(pl.videos.length === 0) {
                    list.innerHTML = '<div class="p-10 text-center text-gray-500">No videos in this playlist yet.</div>';
                    return;
                }

                pl.videos.forEach((vidId, index) => {
                    const vid = store.videos.find(v => v.id === vidId);
                    if(vid) {
                        const el = document.createElement('div');
                        el.className = 'flex gap-4 p-2 hover:bg-[#272727] rounded-lg cursor-pointer group items-center';
                        el.onclick = () => router.navigate('watch', vid.id);
                        el.innerHTML = `
                            <div class="text-gray-500 w-6 text-center font-medium">${index + 1}</div>
                            <div class="w-32 h-20 bg-gray-800 rounded-lg overflow-hidden shrink-0 relative">
                                <video src="${vid.src}" class="w-full h-full object-cover"></video>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-bold text-sm line-clamp-2 text-white">${vid.title}</h4>
                                <p class="text-xs text-chirp-secondary">${store.user.name} â€¢ ${util.formatNumber(vid.views)} views</p>
                            </div>
                        `;
                        list.appendChild(el);
                    }
                });
            },
            refreshView: () => {
                const title = document.getElementById('plDetailTitle').innerText;
                const pl = store.playlists.find(p => p.title === title);
                if(pl) util.updateOdometer('plDetailViews', pl.views);
            }
        }

        // Video Manager
        const videoMgr = {
            currentFile: null,
            
            handleFileSelect: (input) => {
                if(input.files && input.files[0]){
                    videoMgr.currentFile = input.files[0];
                    const url = URL.createObjectURL(videoMgr.currentFile);
                    const player = document.getElementById('previewPlayer');
                    player.src = url;
                    
                    document.getElementById('uploadDropZone').classList.add('hidden');
                    document.getElementById('uploadDetails').classList.remove('hidden');
                    document.getElementById('uploadDetails').style.display = 'flex';
                    document.getElementById('uploadActions').classList.remove('hidden');
                    
                    document.getElementById('upFilename').innerText = videoMgr.currentFile.name;
                    document.getElementById('upTitle').value = videoMgr.currentFile.name.split('.')[0];
                }
            },

            finalizeUpload: () => {
                const isShort = document.getElementById('upIsShort').checked;
                const addToPl = document.getElementById('upAddToPlaylist').checked;
                const collabName = document.getElementById('collabSelect').value;
                
                // AUTO DELETE IF > 2 (Limit logic)
                // Limit is 2. If we have 2, remove last (oldest) before adding new.
                // store.videos[0] is newest. store.videos[length-1] is oldest.
                if(store.videos.length >= 2) {
                    store.videos.pop(); 
                }

                const newVideo = {
                    id: 'v_' + Date.now(),
                    title: document.getElementById('upTitle').value || 'Untitled Video',
                    description: document.getElementById('upDesc').value,
                    src: document.getElementById('previewPlayer').src,
                    uploadDate: new Date().toISOString(),
                    uploadDay: store.day,
                    views: 0,
                    likes: util.getRandomInt(0, 50),
                    dislikes: 0,
                    type: isShort ? 'short' : 'video',
                    hasLiked: false, 
                    comments: [],
                    color: util.getRandomColor(),
                    collaborator: collabName || null,
                    // Unique decay rate: 0.5 (slow decay) to 1.5 (fast decay)
                    decayRate: Math.random() + 0.5
                };

                // Fake comments
                const numComments = util.getRandomInt(3, 8);
                for(let i=0; i<numComments; i++) {
                    const bot = bots[util.getRandomInt(0, bots.length - 1)];
                    newVideo.comments.push({
                        id: 'c_'+i,
                        author: bot.name,
                        pfp: bot.pfp,
                        text: botComments[util.getRandomInt(0, botComments.length - 1)],
                        likes: util.getRandomInt(0, 200),
                        date: '2 hours ago',
                        isCreator: false
                    });
                }

                store.videos.unshift(newVideo);
                ui.toggleUploadModal();
                
                // Update Grids
                const normalVideos = store.videos.filter(v => v.type === 'video');
                const shortVideos = store.videos.filter(v => v.type === 'short');
                
                ui.renderGrid('latestVideosGrid', store.videos.slice(0, 10), false);
                ui.renderGrid('allVideosGrid', normalVideos);
                ui.renderGrid('shortsGrid', shortVideos, true);
                
                document.getElementById('displayVideoCount').innerText = store.videos.length + ' videos';

                if(addToPl && store.playlists.length > 0) {
                    const pl = store.playlists[0]; // Add to first playlist (Favorites)
                    pl.videoCount++;
                    pl.thumbnail = newVideo.src;
                    pl.videos.push(newVideo.id);
                    ui.renderPlaylists();
                }

                router.navigate('channel');
            },

            loadVideo: (id) => {
                store.currentVideoId = id;
                const video = store.videos.find(v => v.id === id);
                if(!video) return;

                const player = document.getElementById('mainPlayer');
                player.src = video.src;
                player.play();

                // Ambient Mode
                const hexColor = video.color || '#222';
                document.getElementById('playerContainer').style.background = `linear-gradient(to bottom, ${hexColor}40, #000)`;
                document.getElementById('descContainer').style.background = `linear-gradient(to right, ${hexColor}30, #222)`;
                document.getElementById('descContainer').style.borderColor = `${hexColor}40`;

                // Meta
                document.getElementById('videoTitle').innerText = video.title;
                document.getElementById('videoDesc').innerText = video.description || "No description provided.";
                document.getElementById('uploadDate').innerText = util.getTimeAgo(video.uploadDate);
                document.getElementById('videoOwnerPfp').src = store.user.pfp;
                
                const collabText = video.collaborator ? ` & ${video.collaborator}` : '';
                document.getElementById('videoOwnerName').innerText = store.user.name + collabText;
                
                document.getElementById('videoOwnerSubs').innerText = util.formatNumber(store.user.subscribers) + ' subscribers';
                document.getElementById('commentCount').innerText = video.comments.length;

                // Watch Page Verification Badge
                if(store.user.isVerified) {
                    document.getElementById('videoVerified').classList.remove('hidden');
                } else {
                    document.getElementById('videoVerified').classList.add('hidden');
                }

                // Animation using new Odometer
                util.updateOdometer('viewCount', video.views);
                util.updateOdometer('likeCount', video.likes);

                // Update Like Button State
                const likeBtn = document.getElementById('likeBtn');
                if(video.hasLiked) {
                    likeBtn.querySelector('i').classList.remove('fa-regular');
                    likeBtn.querySelector('i').classList.add('fa-solid');
                } else {
                    likeBtn.querySelector('i').classList.remove('fa-solid');
                    likeBtn.querySelector('i').classList.add('fa-regular');
                }

                // Render Comments
                videoMgr.renderComments(video);

                // Recommendations
                const rList = document.getElementById('recommendationsList');
                rList.innerHTML = '';
                const fakeRecs = [
                    { t: "Building a YouTube Clone in 1 Hour", v: "1.2M", ago: "1 year ago" },
                    { t: "Why Code is Art", v: "400K", ago: "2 months ago" },
                    { t: "Top 10 CSS Tricks", v: "89K", ago: "5 days ago" }
                ];
                const mix = [...store.videos.filter(v=>v.id !== id), ...fakeRecs];
                
                mix.forEach((item, idx) => {
                    const isReal = item.id !== undefined;
                    const el = document.createElement('div');
                    el.className = 'flex gap-2 cursor-pointer group';
                    if(isReal) el.onclick = () => router.navigate('watch', item.id);
                    
                    el.innerHTML = `
                        <div class="w-40 h-24 bg-gray-800 rounded-lg overflow-hidden shrink-0 relative">
                             ${isReal ? `<video src="${item.src}" class="w-full h-full object-cover"></video>` : '<div class="w-full h-full bg-[#333]"></div>'}
                        </div>
                        <div>
                            <h4 class="font-bold text-sm line-clamp-2 leading-tight mb-1 group-hover:text-white text-white">${isReal ? item.title : item.t}</h4>
                            <p class="text-xs text-chirp-secondary">${isReal ? store.user.name : 'Random Channel'}</p>
                            <p class="text-xs text-chirp-secondary">${isReal ? util.formatNumber(item.views) : item.v} views â€¢ ${isReal ? util.getTimeAgo(item.uploadDate) : item.ago}</p>
                        </div>
                    `;
                    rList.appendChild(el);
                });
            },

            showCollabModal: () => {
                const vid = store.videos.find(v => v.id === store.currentVideoId);
                if(!vid || !vid.collaborator) return;
                
                const collabData = collaborators.find(c => c.name === vid.collaborator);
                const collabSubs = collabData ? collabData.subs : 0;
                
                const msg = `
CHANNELS IN THIS VIDEO:
----------------------
1. ${store.user.name} 
   ${util.formatNumber(store.user.subscribers)} Subscribers

2. ${vid.collaborator} 
   ${util.formatNumber(collabSubs)} Subscribers
`;
                alert(msg);
            },

            renderComments: (video) => {
                const cList = document.getElementById('commentsList');
                cList.innerHTML = '';
                video.comments.forEach(c => {
                    const el = document.createElement('div');
                    el.className = 'flex gap-3';
                    const bgClass = c.isCreator ? 'bg-chirp-hover/50 p-2 rounded-lg' : '';
                    
                    // Assign a stable ID to comment counter for odometer
                    const counterId = `cnt_${c.id}`;
                    
                    el.innerHTML = `
                         <div class="w-10 h-10 rounded-full overflow-hidden shrink-0">
                            <img src="${c.pfp}" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1 ${bgClass}">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-sm ${c.isCreator ? 'bg-chirp-text text-black px-2 rounded-full' : 'bg-[#333] px-2 py-0.5 rounded-full text-xs text-white'}">${c.author}</span>
                                ${c.isCreator ? '<i class="fa-solid fa-circle-check text-chirp-secondary text-xs"></i>' : ''}
                                <span class="text-xs text-chirp-secondary">${c.date}</span>
                            </div>
                            <p class="text-sm text-white mb-2">${c.text}</p>
                            <div class="flex items-center gap-4 text-sm text-chirp-secondary">
                                <button onclick="videoMgr.botLikeComment('${c.id}', this)" class="flex items-center gap-1 hover:text-white group relative">
                                    <i class="fa-regular fa-thumbs-up group-active:scale-125 transition"></i> <span id="${counterId}" class="like-counter odometer-target">0</span>
                                </button>
                                <button class="hover:text-white"><i class="fa-regular fa-thumbs-down"></i></button>
                                <button class="font-bold hover:text-white text-xs">Reply</button>
                                <button onclick="videoMgr.botLikeBoost(this)" class="text-[10px] text-chirp-blue hover:underline opacity-0 group-hover:opacity-100 transition">Bot Boost</button>
                            </div>
                        </div>
                    `;
                    cList.appendChild(el);
                    
                    // Initialize odometer with value immediately
                    setTimeout(() => {
                        util.updateOdometer(counterId, c.likes);
                    }, 0);
                });
            },

            postComment: () => {
                const input = document.getElementById('commentInput');
                if(!input.value.trim()) return;
                
                const vid = store.videos.find(v => v.id === store.currentVideoId);
                if(vid) {
                    vid.comments.unshift({
                        id: 'c_' + Date.now(),
                        author: store.user.name,
                        pfp: store.user.pfp,
                        text: input.value,
                        likes: 0,
                        date: 'Just now',
                        isCreator: true
                    });
                    input.value = '';
                    document.getElementById('commentCount').innerText = vid.comments.length;
                    videoMgr.renderComments(vid);
                }
            },

            refreshWatchStats: () => {
                 const vid = store.videos.find(v => v.id === store.currentVideoId);
                 if(vid) {
                     util.updateOdometer('viewCount', vid.views);
                     util.updateOdometer('likeCount', vid.likes);
                 }
            },

            likeVideo: (btn) => {
                const vid = store.videos.find(v => v.id === store.currentVideoId);
                if(vid && !vid.hasLiked) {
                    vid.likes++;
                    vid.hasLiked = true;
                    util.updateOdometer('likeCount', vid.likes);
                    
                    // Update Button UI
                    const icon = btn.querySelector('i');
                    icon.classList.remove('fa-regular');
                    icon.classList.add('fa-solid');
                    
                    // Trigger Explosion
                    ui.triggerExplosion(btn);
                }
            },
            
            dislikeVideo: () => {
                 const btn = event.currentTarget.querySelector('i');
                 btn.classList.add('text-white');
                 setTimeout(() => btn.classList.remove('text-white'), 200);
            },

            botLikeComment: (cid, btn) => {
                // Visual toggle and explosion
                const icon = btn.querySelector('i');
                icon.classList.remove('fa-regular');
                icon.classList.add('fa-solid');
                ui.triggerExplosion(btn);
            },
            
            botLikeBoost: (btn) => {
                 const container = btn.parentElement;
                 const counter = container.querySelector('.like-counter');
                 // Ensure ID
                 if(!counter.id) counter.id = 'comm_like_' + Math.random().toString(36).substr(2,9);
                 
                 const randomBig = util.getRandomInt(1000, 50000);
                 util.updateOdometer(counter.id, randomBig);
                 
                 // Also explode on boost
                 ui.triggerExplosion(container.querySelector('button'));
            }
        };

        // Initialize
        onboarding.init();

    </script>
</body>
</html>
