<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chirpless - Chirp Less, Learn More</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        googleBg: '#202124',
                        googleCard: '#303134', 
                        googleText: '#e8eaed',
                        googleGray: '#9aa0a6',
                        googleBlue: '#8ab4f8',
                        googleDivider: '#3c4043',
                        incognitoBg: '#151515',
                    },
                    fontFamily: {
                        sans: ['Roboto', 'Arial', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        /* Chrome-like Scrollbar */
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #202124; }
        ::-webkit-scrollbar-thumb { background: #5f6368; border: 3px solid #202124; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #75797e; }

        body {
            background-color: #202124;
            color: #e8eaed;
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            transition: background-color 0.3s ease;
        }

        /* Incognito Overrides */
        body.incognito-mode { background-color: #151515; }
        body.incognito-mode .sticky { background-color: #151515; }
        body.incognito-mode ::-webkit-scrollbar-track { background: #151515; }

        /* Seasonal Layer */
        .seasonal-layer {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }
        .snowflake {
            position: absolute;
            color: #fff;
            opacity: 0.1;
            animation: fall linear infinite;
        }
        @keyframes fall {
            to { transform: translateY(105vh); }
        }

        /* Input Styles */
        input::placeholder { color: #9aa0a6; }
        
        .search-wrapper {
            transition: background 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .search-wrapper:hover {
            background-color: #3c4043;
            box-shadow: 0 1px 6px rgba(0,0,0,0.3);
            border-color: rgba(223, 225, 229, 0);
        }
        .search-wrapper:focus-within {
            background-color: #303134;
            box-shadow: 0 1px 6px rgba(0,0,0,0.3);
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        /* History Dropdown */
        .history-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #303134;
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
            padding-bottom: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 50;
            display: none;
            border-top: 1px solid #3c4043;
        }
        .search-wrapper:focus-within .history-dropdown { display: block; }
        
        /* View Management */
        .view-section { display: none; }
        .view-section.active { display: block; }
        
        /* Typography */
        h1, h2, h3 { font-weight: 400; }
        .result-title:hover { text-decoration: underline; }
    </style>
</head>
<body class="h-screen flex flex-col justify-between">

    <!-- Seasonal Background -->
    <div id="seasonal-layer" class="seasonal-layer"></div>

    <!-- Help / Settings Modal -->
    <div id="help-modal" class="fixed inset-0 z-[110] bg-black/80 flex items-center justify-center backdrop-blur-sm hidden animate-fade-in p-4">
        <div class="bg-googleCard p-6 rounded-2xl max-w-md w-full shadow-2xl border border-googleDivider relative">
            <button onclick="toggleHelp()" class="absolute top-4 right-4 text-googleGray hover:text-white"><i class="fas fa-times text-xl"></i></button>
            
            <div class="text-center mb-6">
                <div class="w-12 h-12 bg-googleBlue/20 rounded-full flex items-center justify-center mx-auto mb-3 text-googleBlue text-xl">
                    <i class="fas fa-wrench"></i>
                </div>
                <h2 class="text-xl text-white mb-1">Make Chirpless Default</h2>
                <p class="text-googleGray text-sm">Use Chirpless directly from your browser's address bar.</p>
            </div>

            <div class="bg-[#202124] p-4 rounded-lg border border-googleDivider mb-4">
                <label class="text-xs text-googleGray uppercase font-bold tracking-wider mb-2 block">1. Search Engine URL</label>
                <div class="flex items-center gap-2 bg-[#303134] p-2 rounded border border-googleDivider">
                    <code id="engine-url" class="text-xs text-googleBlue truncate flex-1">...</code>
                    <button onclick="copyEngineUrl()" class="text-googleGray hover:text-white p-1"><i class="fas fa-copy"></i></button>
                </div>
            </div>

            <div class="space-y-3 text-sm text-googleText">
                <p><span class="font-bold text-white">Chrome/Edge:</span> Go to Settings > Search Engine > Manage Search Engines > Site Search > Add.</p>
                <ul class="list-disc pl-5 text-googleGray space-y-1">
                    <li>Name: <span class="text-white">Chirpless</span></li>
                    <li>Shortcut: <span class="text-white">c</span></li>
                    <li>URL: <span class="text-white">Paste the link above</span></li>
                </ul>
                <p class="text-xs text-googleGray mt-2">Now type 'c' + Tab in your address bar to search!</p>
            </div>
        </div>
    </div>

    <!-- Limit Modal -->
    <div id="limit-modal" class="fixed inset-0 z-[100] bg-black/70 flex items-center justify-center backdrop-blur-sm hidden animate-fade-in">
        <div class="bg-googleCard p-6 rounded-xl max-w-sm text-center shadow-2xl border border-googleDivider mx-4">
            <i class="fas fa-hand-paper text-googleGray text-4xl mb-4"></i>
            <h2 class="text-xl text-white mb-2">Search Limit Reached</h2>
            <p class="text-googleGray text-sm mb-4">You've used your searches for this week.</p>
            <button onclick="localStorage.removeItem('chirpless_v6'); location.reload();" class="text-xs text-googleBlue hover:underline cursor-pointer">
                (Dev: Reset Limit)
            </button>
        </div>
    </div>

    <!-- Top Right Nav -->
    <div class="fixed top-4 right-4 z-50 flex items-center gap-3">
        <button onclick="toggleIncognito()" id="incognito-btn" class="w-10 h-10 rounded-full bg-googleCard hover:bg-[#3c4043] flex items-center justify-center text-googleGray hover:text-white transition-colors border border-transparent" title="Incognito Mode">
            <i class="fas fa-user-secret"></i>
        </button>
        <button onclick="toggleHelp()" class="w-10 h-10 rounded-full bg-googleCard hover:bg-[#3c4043] flex items-center justify-center text-googleGray hover:text-white transition-colors" title="Settings">
            <i class="fas fa-cog"></i>
        </button>
        <div class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center text-sm font-bold text-white cursor-pointer select-none">
            U
        </div>
    </div>

    <!-- Main App Area -->
    <main class="flex-grow w-full relative z-10" id="main-scroll">
        
        <!-- ================= LANDING PAGE ================= -->
        <section id="landing-view" class="view-section active min-h-screen flex flex-col items-center justify-center px-4">
            
            <div class="w-full max-w-[584px] flex flex-col items-center -mt-16">
                <!-- Welcome -->
                <div id="welcome-text" class="mb-4 text-googleGray text-sm font-medium opacity-80 uppercase tracking-widest"></div>

                <!-- Logo -->
                <div class="mb-8 flex flex-col items-center select-none">
                    <h1 class="text-6xl md:text-8xl font-bold tracking-tighter text-white mb-2 relative">
                        Chirpless
                        <span id="incognito-badge" class="hidden absolute -right-4 -top-2 text-xs bg-[#202124] border border-white/20 px-2 py-0.5 rounded text-gray-400 font-normal tracking-normal">Private</span>
                    </h1>
                    <p class="text-googleGray text-lg relative -top-1 font-light">"Chirp Less, Learn More."</p>
                </div>

                <!-- Search Input Form -->
                <div class="w-full relative search-wrapper bg-googleCard border border-googleDivider rounded-[24px] shadow-md z-20">
                    <form id="landing-form" class="flex items-center px-4 py-3 w-full" onsubmit="event.preventDefault(); handleSearch('landing');">
                        <i class="fas fa-search text-googleGray mr-3 text-lg cursor-pointer hover:text-white" onclick="handleSearch('landing')"></i>
                        <input type="text" id="landing-input" 
                            class="bg-transparent border-none outline-none text-white w-full text-base h-full"
                            placeholder="Search Google or type a URL" autocomplete="off">
                        
                        <!-- Voice Search -->
                        <button type="button" class="p-2 rounded-full hover:bg-white/10 transition-colors text-googleBlue mr-1" onclick="startVoiceSearch('landing')">
                            <i class="fas fa-microphone"></i>
                        </button>

                        <!-- AI Toggle -->
                        <button type="button" id="ai-toggle-landing" class="p-2 rounded-full hover:bg-white/10 transition-colors flex items-center gap-2 group relative" onclick="toggleAI()">
                            <i class="fas fa-brain text-googleGray group-[.active]:text-googleBlue"></i>
                        </button>
                    </form>

                    <!-- History Dropdown -->
                    <div id="landing-history" class="history-dropdown hidden">
                        <!-- Injected via JS -->
                    </div>
                </div>

                <!-- Quick Links -->
                <div class="mt-8 grid grid-cols-4 gap-4 md:gap-8 w-full max-w-md">
                    <div class="flex flex-col items-center gap-3 group cursor-pointer" onclick="window.open('https://youtube.com', '_blank')">
                        <div class="w-12 h-12 rounded-full bg-googleCard flex items-center justify-center group-hover:bg-[#3c4043] transition-colors border border-transparent group-hover:border-googleDivider">
                            <i class="fab fa-youtube text-white text-xl"></i>
                        </div>
                        <span class="text-xs text-googleGray">YouTube</span>
                    </div>
                    <div class="flex flex-col items-center gap-3 group cursor-pointer">
                        <div class="w-12 h-12 rounded-full bg-googleCard flex items-center justify-center group-hover:bg-[#3c4043] transition-colors border border-transparent group-hover:border-googleDivider">
                            <i class="fas fa-envelope text-white text-xl"></i>
                        </div>
                        <span class="text-xs text-googleGray">Gmail</span>
                    </div>
                    <div class="flex flex-col items-center gap-3 group cursor-pointer">
                        <div class="w-12 h-12 rounded-full bg-googleCard flex items-center justify-center group-hover:bg-[#3c4043] transition-colors border border-transparent group-hover:border-googleDivider">
                            <i class="fab fa-reddit text-white text-xl"></i>
                        </div>
                        <span class="text-xs text-googleGray">Reddit</span>
                    </div>
                    <div class="flex flex-col items-center gap-3 group cursor-pointer" onclick="toggleHelp()">
                        <div class="w-12 h-12 rounded-full bg-googleCard flex items-center justify-center group-hover:bg-[#3c4043] transition-colors border border-transparent group-hover:border-googleDivider">
                            <i class="fas fa-question text-white text-xl"></i>
                        </div>
                        <span class="text-xs text-googleGray">Help</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- ================= RESULTS PAGE ================= -->
        <section id="results-view" class="view-section min-h-screen bg-googleBg pb-10">
            <!-- Header -->
            <header class="sticky top-0 z-40 bg-googleBg border-b border-googleDivider pt-3 px-4 md:px-8 transition-colors">
                <div class="flex items-center gap-4 mb-3 max-w-[1200px]">
                    <!-- Logo -->
                    <div class="text-xl font-bold text-white cursor-pointer hidden md:block select-none tracking-tight" onclick="goHome()">Chirpless</div>
                    <div class="text-xl font-bold text-white cursor-pointer md:hidden select-none" onclick="goHome()">C</div>
                    
                    <!-- Search Bar Form -->
                    <form class="flex-1 max-w-[690px]" onsubmit="event.preventDefault(); handleSearch('results');">
                        <div class="bg-googleCard rounded-full flex items-center px-4 py-2 shadow-sm border border-transparent focus-within:bg-[#3c4043] focus-within:shadow-md transition-all">
                            <input type="text" id="results-input" 
                                class="bg-transparent border-none outline-none text-white w-full text-base"
                                value="">
                            <i class="fas fa-times text-googleGray ml-3 cursor-pointer hover:text-white px-2 border-r border-googleDivider mr-2" onclick="clearSearch()"></i>
                            <i class="fas fa-microphone text-googleBlue cursor-pointer px-2" onclick="startVoiceSearch('results')"></i>
                            <i class="fas fa-search text-googleBlue cursor-pointer px-1" onclick="handleSearch('results')"></i>
                        </div>
                    </form>

                    <!-- Header Icons (Restored) -->
                    <div class="flex items-center gap-3 pl-2">
                        <button id="ai-toggle-header" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-white/10 group transition-colors" onclick="toggleAI()">
                            <i class="fas fa-brain text-googleGray group-[.active]:text-googleBlue"></i>
                        </button>
                        <div class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center text-sm font-bold text-white cursor-pointer select-none">
                            U
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="flex gap-1 max-w-[1200px] text-sm text-googleGray overflow-x-auto no-scrollbar ml-0 md:ml-[100px]">
                    <button class="tab-btn active px-3 py-3 border-b-[3px] border-googleBlue text-googleBlue font-medium" onclick="setFilter('all', this)">All</button>
                    <button class="tab-btn px-3 py-3 border-b-[3px] border-transparent hover:text-googleText transition-colors" onclick="setFilter('images', this)">Images</button>
                    <button class="tab-btn px-3 py-3 border-b-[3px] border-transparent hover:text-googleText transition-colors" onclick="setFilter('news', this)">News</button>
                    <button class="tab-btn px-3 py-3 border-b-[3px] border-transparent hover:text-googleText transition-colors" onclick="setFilter('videos', this)">Videos</button>
                </div>
            </header>

            <!-- Main Content Area -->
            <div class="px-4 md:px-8 py-6 max-w-[1200px] mx-auto md:ml-[100px]">
                
                <!-- Loading State -->
                <div id="loader" class="hidden max-w-[652px] space-y-8 pt-2">
                    <div class="space-y-3">
                        <div class="h-4 w-32 bg-[#303134] rounded animate-pulse"></div>
                        <div class="h-5 w-3/4 bg-[#303134] rounded animate-pulse"></div>
                        <div class="h-12 w-full bg-[#303134] rounded animate-pulse"></div>
                    </div>
                </div>

                <!-- Dumb AI Panel -->
                <div id="dumb-ai-panel" class="hidden mb-8 max-w-[652px] animate-slide-up">
                    <div class="bg-[#2a2b2e] rounded-xl p-5 border border-googleDivider/50 shadow-sm relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-googleBlue to-purple-500"></div>
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fas fa-sparkles text-googleBlue text-sm animate-pulse"></i>
                            <span class="text-sm font-bold text-googleText">Generative AI Overview (Experimental)</span>
                        </div>
                        <div class="text-googleText text-base leading-7" id="dumb-ai-text">
                            Thinking...
                        </div>
                    </div>
                </div>

                <!-- Layout Container -->
                <div class="flex flex-col lg:flex-row gap-12">
                    <!-- Left Column (Main Results) -->
                    <div class="flex-1 max-w-[652px] min-w-0">
                        <!-- Mobile/Inline Knowledge Graph -->
                        <div id="inline-kg-container" class="lg:hidden mb-6"></div>
                        <!-- Organic Results -->
                        <div id="main-feed" class="space-y-8"></div>
                    </div>

                    <!-- Right Column (Desktop Sidebar) -->
                    <div id="sidebar-container" class="hidden lg:block w-[368px] shrink-0"></div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // --- CONFIG ---
        const API_KEY = "63295e5de863c9228036333af0971a6e69f108a3";
        const WEEKLY_LIMIT = 100;
        const STORAGE_KEY = 'chirpless_v6';
        
        // --- DATA ---
        const dumbJokes = [
            "My sophisticated algorithm has determined that the answer is likely '42'. Or maybe 'tacos'.",
            "I searched the entire internet and all I found was this cat video. ðŸ±",
            "I'm a language model, not a miracle worker.",
            "Loading... Loading... Just kidding, I forgot what you asked.",
            "Have you tried turning the internet off and on again?",
            "404: Motivation not found.",
            "I could tell you the answer, but then I'd have to delete my cache."
        ];

        let state = {
            count: 0,
            weekStart: 0,
            aiMode: false,
            filter: 'all',
            query: '',
            incognito: false,
            history: []
        };

        const els = {
            landingView: document.getElementById('landing-view'),
            resultsView: document.getElementById('results-view'),
            landingInput: document.getElementById('landing-input'),
            resultsInput: document.getElementById('results-input'),
            landingHistory: document.getElementById('landing-history'),
            mainFeed: document.getElementById('main-feed'),
            sidebarContainer: document.getElementById('sidebar-container'),
            inlineKgContainer: document.getElementById('inline-kg-container'),
            dumbAiPanel: document.getElementById('dumb-ai-panel'),
            dumbAiText: document.getElementById('dumb-ai-text'),
            loader: document.getElementById('loader'),
            limitModal: document.getElementById('limit-modal'),
            helpModal: document.getElementById('help-modal'),
            engineUrl: document.getElementById('engine-url'),
            incognitoBtn: document.getElementById('incognito-btn'),
            incognitoBadge: document.getElementById('incognito-badge'),
            seasonalLayer: document.getElementById('seasonal-layer'),
            // Note: toggleHeader is fetched in init() after it's guaranteed to be in DOM or checked via optional chaining
            toggleLanding: document.getElementById('ai-toggle-landing'),
        };

        // --- INIT ---
        function init() {
            // Late binding for toggleHeader to ensure it exists if moved/restored
            els.toggleHeader = document.getElementById('ai-toggle-header');

            loadState();
            checkReset();
            checkUrlParams(); 
            updateUI();
            setSeasonalTheme();
            setWelcomeText();
            renderHistory();
            
            // Set URL for help modal
            const currentUrl = window.location.href.split('?')[0];
            els.engineUrl.innerText = `${currentUrl}?q=%s`;
            
            // Input focus listeners for history
            els.landingInput.addEventListener('focus', () => {
                if(!state.incognito && state.history.length > 0) els.landingHistory.style.display = 'block';
            });
            // Hide delay to allow clicking
            els.landingInput.addEventListener('blur', () => {
                setTimeout(() => els.landingHistory.style.display = 'none', 200);
            });
        }

        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const q = urlParams.get('q');
            if(q) {
                performSearch(q);
            }
        }

        // --- CORE FEATURES ---
        function toggleIncognito() {
            state.incognito = !state.incognito;
            document.body.classList.toggle('incognito-mode');
            
            if(state.incognito) {
                els.incognitoBtn.classList.add('text-white', 'bg-blue-600');
                els.incognitoBtn.classList.remove('bg-googleCard');
                els.incognitoBadge.classList.remove('hidden');
            } else {
                els.incognitoBtn.classList.remove('text-white', 'bg-blue-600');
                els.incognitoBtn.classList.add('bg-googleCard');
                els.incognitoBadge.classList.add('hidden');
            }
        }

        function toggleHelp() {
            els.helpModal.classList.toggle('hidden');
        }

        function copyEngineUrl() {
            const text = els.engineUrl.innerText;
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            // Ensure textarea is not visible but part of DOM to allow selection
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if(successful) {
                    alert("URL copied! Paste this into your browser's search engine settings.");
                } else {
                    throw new Error("Copy command failed");
                }
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                alert("Could not copy automatically. Please select and copy the URL manually.");
            }
            
            document.body.removeChild(textArea);
        }

        function startVoiceSearch(source) {
            if (!('webkitSpeechRecognition' in window)) {
                alert("Voice search is not supported in this browser.");
                return;
            }
            const recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            
            recognition.onstart = function() {
                const input = source === 'landing' ? els.landingInput : els.resultsInput;
                input.placeholder = "Listening...";
            };
            
            recognition.onresult = function(event) {
                const text = event.results[0][0].transcript;
                const input = source === 'landing' ? els.landingInput : els.resultsInput;
                input.value = text;
                performSearch(text);
            };
            
            recognition.onend = function() {
                const input = source === 'landing' ? els.landingInput : els.resultsInput;
                input.placeholder = "Search Google or type a URL";
            };

            recognition.start();
        }

        // --- HISTORY LOGIC ---
        function addToHistory(query) {
            if(state.incognito) return;
            
            // Remove if exists then add to top
            state.history = state.history.filter(h => h !== query);
            state.history.unshift(query);
            if(state.history.length > 5) state.history.pop();
            
            saveState();
            renderHistory();
        }

        function renderHistory() {
            if(state.history.length === 0) {
                els.landingHistory.innerHTML = '';
                return;
            }
            
            els.landingHistory.innerHTML = state.history.map(h => `
                <div class="px-4 py-2 hover:bg-[#3c4043] cursor-pointer flex items-center gap-3 text-white" onclick="handleSearchHistory('${h}')">
                    <i class="fas fa-history text-googleGray text-sm"></i>
                    <span>${h}</span>
                </div>
            `).join('');
        }

        function handleSearchHistory(q) {
            performSearch(q);
        }

        // --- STORAGE ---
        function loadState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                state.count = parsed.count || 0;
                state.weekStart = parsed.weekStart || Date.now();
                state.history = parsed.history || [];
            } else {
                state.weekStart = Date.now();
                saveState();
            }
        }

        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({
                count: state.count,
                weekStart: state.weekStart,
                history: state.history
            }));
        }

        function checkReset() {
            if (Date.now() - state.weekStart > 604800000) {
                state.count = 0;
                state.weekStart = Date.now();
                saveState();
            }
        }

        // --- UI UTILS ---
        function updateUI() {
            const activeClass = 'active';
            
            // Check for elements before accessing properties to prevent crashes
            if(els.toggleLanding) {
                if(state.aiMode) els.toggleLanding.classList.add(activeClass);
                else els.toggleLanding.classList.remove(activeClass);
            }
            
            if(els.toggleHeader) {
                if(state.aiMode) els.toggleHeader.classList.add(activeClass);
                else els.toggleHeader.classList.remove(activeClass);
            }
        }

        function toggleAI() {
            state.aiMode = !state.aiMode;
            updateUI();
        }

        function goHome() {
            els.resultsView.classList.remove('active');
            els.landingView.classList.add('active');
            els.landingInput.value = '';
            els.landingInput.focus();
            window.scrollTo(0,0);
            
            // Clear Query Param
            const url = new URL(window.location);
            url.searchParams.delete('q');
            window.history.pushState({}, '', url);
        }

        function clearSearch() {
            els.resultsInput.value = '';
            els.resultsInput.focus();
        }

        function setWelcomeText() {
            const h = new Date().getHours();
            let msg = "Welcome";
            if(h < 12) msg = "Good morning";
            else if(h < 18) msg = "Good afternoon";
            else msg = "Good evening";
            document.getElementById('welcome-text').innerText = msg;
        }

        function setSeasonalTheme() {
            const month = new Date().getMonth(); 
            const layer = els.seasonalLayer;
            if (month === 11 || month === 0 || month === 1) {
                for(let i=0; i<30; i++) {
                    const flake = document.createElement('div');
                    flake.className = 'snowflake fas fa-snowflake';
                    flake.style.left = Math.random() * 100 + 'vw';
                    flake.style.fontSize = (Math.random() * 10 + 8) + 'px';
                    flake.style.animationDuration = (Math.random() * 5 + 10) + 's';
                    flake.style.animationDelay = (Math.random() * 5) + 's';
                    layer.appendChild(flake);
                }
            }
        }

        // --- SEARCH LOGIC ---
        function handleSearch(source) {
            const input = source === 'landing' ? els.landingInput : els.resultsInput;
            performSearch(input.value);
        }

        async function performSearch(query, increment = true) {
            if(!query || !query.trim()) return;
            state.query = query;

            if(increment && state.count >= WEEKLY_LIMIT) {
                els.limitModal.classList.remove('hidden');
                return;
            }

            addToHistory(query);

            // Prep UI
            els.landingView.classList.remove('active');
            els.resultsView.classList.add('active');
            els.resultsInput.value = query;
            window.scrollTo({ top: 0, behavior: 'instant' });
            
            // Clear previous
            els.mainFeed.innerHTML = '';
            els.sidebarContainer.innerHTML = '';
            els.inlineKgContainer.innerHTML = '';
            els.dumbAiPanel.classList.add('hidden');
            els.loader.classList.remove('hidden');

            if(increment) {
                state.count++;
                saveState();
            }

            // Dumb AI
            if(state.aiMode) {
                els.dumbAiPanel.classList.remove('hidden');
                els.dumbAiText.innerText = "Generating nonsense...";
                setTimeout(() => {
                    els.dumbAiText.innerText = dumbJokes[Math.floor(Math.random() * dumbJokes.length)];
                }, 1500);
            }

            try {
                let endpoint = 'search';
                if(state.filter === 'images') endpoint = 'images';
                if(state.filter === 'news') endpoint = 'news';
                if(state.filter === 'videos') endpoint = 'videos';

                const res = await fetch(`https://google.serper.dev/${endpoint}`, {
                    method: 'POST',
                    headers: {'X-API-KEY': API_KEY, 'Content-Type': 'application/json'},
                    body: JSON.stringify({ q: query, gl: 'us', hl: 'en' })
                });
                
                if (!res.ok) throw new Error("API Error");
                const data = await res.json();
                renderResults(data, endpoint);

            } catch(e) {
                console.error(e);
                els.mainFeed.innerHTML = '<div class="text-googleGray mt-4 p-4 text-center">Sorry, the search service is currently unavailable.</div>';
            } finally {
                els.loader.classList.add('hidden');
            }
        }

        function setFilter(filter, btn) {
            state.filter = filter;
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.className = 'tab-btn px-3 py-3 border-b-[3px] border-transparent hover:text-googleText transition-colors';
            });
            btn.className = 'tab-btn active px-3 py-3 border-b-[3px] border-googleBlue text-googleBlue font-medium';
            if(state.query) performSearch(state.query, false);
        }

        // --- RENDER LOGIC ---
        function renderResults(data, type) {
            
            // 1. Sponsored Ad
            const adCard = `
                <div class="mb-6 animate-fade-in cursor-pointer group" onclick="window.open('https://youtube.com/@lucidpp?si=eSAhrMTDPPWko8xA', '_blank')">
                   <div class="flex items-center gap-2 mb-1">
                        <span class="text-white font-bold text-sm">Sponsored</span>
                    </div>
                    <div class="bg-googleCard p-4 rounded-xl border border-googleDivider hover:border-googleGray transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="bg-red-600 w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fab fa-youtube text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-googleBlue text-lg group-hover:underline">Support Lucid++ on YouTube</h3>
                                <p class="text-sm text-googleGray">Tech tutorials, reviews, and more. Keep Chirpless free!</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            let contentHTML = '';

            // 2. Knowledge Graph Generation (Verified)
            if(data.knowledgeGraph) {
                const kg = data.knowledgeGraph;
                const kgHTML = `
                    <div class="bg-googleBg border border-googleDivider rounded-2xl overflow-hidden mb-8 animate-fade-in shadow-lg">
                        ${kg.imageUrl ? `<div class="w-full h-48 bg-[#202124]"><img src="${kg.imageUrl}" class="w-full h-full object-cover opacity-90"></div>` : ''}
                        <div class="p-4">
                            <h2 class="text-3xl font-normal text-white mb-2 font-sans flex items-center gap-2">
                                ${kg.title}
                                <i class="fas fa-check-circle text-blue-400 text-xl" title="Verified"></i>
                            </h2>
                            <div class="text-sm text-googleGray mb-4">${kg.type || 'Result'}</div>
                            <p class="text-sm text-googleText mb-4 leading-relaxed">${kg.description || ''}</p>
                            ${kg.attributes ? Object.entries(kg.attributes).slice(0, 4).map(([k,v]) => `
                                <div class="py-2 border-t border-googleDivider flex justify-between text-sm">
                                    <span class="font-bold text-googleGray">${k}</span>
                                    <span class="text-googleText text-right max-w-[60%]">${v}</span>
                                </div>
                            `).join('') : ''}
                            ${kg.website ? `<a href="${kg.website}" target="_blank" class="block mt-4 py-2 bg-[#3c4043] text-center rounded-full text-googleBlue text-sm hover:bg-[#45484c] border border-googleDivider">Visit Website</a>` : ''}
                        </div>
                    </div>
                `;
                els.sidebarContainer.innerHTML = kgHTML;
                els.inlineKgContainer.innerHTML = kgHTML;
            }

            // 3. Main Results
            if(type === 'search' && data.organic) {
                data.organic.forEach((res, idx) => {
                    if(idx === 1) contentHTML += adCard;
                    contentHTML += `
                        <div class="mb-8 animate-fade-in" style="animation-delay: ${idx * 0.05}s">
                            <div class="flex items-center gap-3 mb-1.5 group cursor-pointer">
                                <div class="bg-[#3c4043] p-1 rounded-full w-7 h-7 flex items-center justify-center">
                                    <img src="${res.favicon || 'https://via.placeholder.com/16'}" class="w-4 h-4 object-contain" onerror="this.style.display='none'">
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-sm text-googleText group-hover:text-white">${res.title.substring(0, 30)}...</span>
                                    <span class="text-xs text-googleGray truncate max-w-[250px]">${res.link}</span>
                                </div>
                            </div>
                            <a href="${res.link}" target="_blank" class="block group">
                                <h3 class="text-xl text-googleBlue result-title mb-1 font-normal group-hover:underline">${res.title}</h3>
                            </a>
                            <p class="text-sm text-googleGray leading-relaxed max-w-[600px]">${res.snippet}</p>
                            ${res.sitelinks ? `
                                <div class="mt-3 flex flex-wrap gap-2">
                                    ${res.sitelinks.map(sl => `<a href="${sl.link}" class="px-3 py-1 rounded-full bg-[#303134] text-xs text-googleText hover:bg-[#3c4043] transition-colors">${sl.title}</a>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            } else if (type === 'images' && data.images) {
                contentHTML = `<div class="grid grid-cols-2 md:grid-cols-3 gap-2">`;
                data.images.forEach(img => {
                    contentHTML += `
                        <a href="${img.link}" target="_blank" class="block aspect-square bg-[#202124] rounded-xl overflow-hidden relative group">
                            <img src="${img.imageUrl}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105">
                            <div class="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                                <p class="text-xs text-white truncate">${img.title}</p>
                            </div>
                        </a>
                    `;
                });
                contentHTML += `</div>`;
            } else if (type === 'news' && data.news) {
                data.news.forEach(item => {
                    contentHTML += `
                        <a href="${item.link}" target="_blank" class="block bg-googleBg border border-googleDivider p-4 rounded-xl mb-4 hover:bg-[#303134] transition-colors">
                            <div class="flex gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2 text-xs text-googleGray">
                                        <img src="${item.source.icon || ''}" class="w-4 h-4 rounded-full" onerror="this.style.display='none'">
                                        <span class="text-white">${item.source}</span>
                                        <span>â€¢ ${item.date}</span>
                                    </div>
                                    <h3 class="text-lg text-googleBlue mb-2 leading-snug hover:underline">${item.title}</h3>
                                </div>
                                ${item.imageUrl ? `<img src="${item.imageUrl}" class="w-20 h-20 object-cover rounded-lg bg-[#202124]">` : ''}
                            </div>
                        </a>
                    `;
                });
            }
            els.mainFeed.innerHTML = contentHTML;
        }

        init();
    </script>
</body>
</html>
