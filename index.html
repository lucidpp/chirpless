<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Chirpless">
    
    <!-- PWA Links -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="siteicon.png">
    <link rel="apple-touch-icon" href="siteicon.png">
    
    <title>Chirpless | Connected</title>
    <style>
        /* --- CSS VARIABLES & THEME --- */
        :root {
            --bg-color: #050505;
            --surface-color: #121212;
            --surface-highlight: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #999999;
            --accent: #ffffff;
            --accent-dim: #333333;
            /* Modern Glass Variables */
            --glass-panel: rgba(20, 20, 20, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-blur: blur(20px) saturate(180%);
            
            --border-radius: 20px;
            --padding: 20px;
            --nav-height: 85px;
            --mini-player-height: 70px;
            --sidebar-width: 250px;
            --font-main: 'SF Pro Display', -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        [data-theme="light"] {
            --bg-color: #f2f2f7;
            --surface-color: #ffffff;
            --surface-highlight: #e5e5ea;
            --text-primary: #000000;
            --text-secondary: #666666;
            --accent: #000000;
            --accent-dim: #d1d1d6;
            --glass-panel: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(0, 0, 0, 0.05);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            background-color: var(--bg-color); color: var(--text-primary);
            font-family: var(--font-main); margin: 0; padding: 0;
            height: 100dvh; width: 100vw;
            overflow: hidden;
            transition: background-color 0.3s;
            user-select: none;
        }

        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .w-full { width: 100%; }
        .text-sm { font-size: 0.9rem; }
        .text-xs { font-size: 0.75rem; }
        .font-bold { font-weight: 700; }
        .text-secondary { color: var(--text-secondary); }
        .icon { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        
        /* --- LAYOUT --- */
        #app { height: 100%; display: flex; flex-direction: column; position: relative; }
        
        /* HEADER (Mobile Only) */
        header {
            padding: var(--padding); padding-top: max(15px, var(--safe-top));
            display: flex; justify-content: space-between; align-items: center; z-index: 10;
        }
        .brand { font-size: 1.4rem; font-weight: 800; display: flex; align-items: center; gap: 8px; letter-spacing: -0.5px; }
        .brand img { width: 28px; height: 28px; border-radius: 6px; }

        /* SIDEBAR (Desktop Only) */
        #desktop-sidebar {
            display: none;
            position: fixed; top: 0; left: 0; height: 100%; width: var(--sidebar-width);
            background: var(--surface-color); border-right: 1px solid var(--surface-highlight);
            padding: 30px 20px; z-index: 150;
            flex-direction: column; justify-content: space-between;
        }

        .sidebar-menu { display: flex; flex-direction: column; gap: 10px; margin-top: 40px; }
        .sidebar-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px;
            border-radius: 12px; color: var(--text-secondary); cursor: pointer; transition: 0.2s;
            font-weight: 600;
        }
        .sidebar-item:hover { background: var(--surface-highlight); color: var(--text-primary); }
        .sidebar-item.active { background: var(--text-primary); color: var(--bg-color); }
        .sidebar-item svg { width: 20px; height: 20px; }

        /* MAIN CONTENT */
        main {
            flex: 1; overflow-y: scroll; scroll-behavior: smooth;
            padding-bottom: calc(var(--nav-height) + var(--mini-player-height) + 20px);
            overscroll-behavior: contain;
            transition: margin-left 0.3s;
        }
        main::-webkit-scrollbar { display: none; }

        /* --- COMPONENTS --- */
        .section-title { font-size: 1.3rem; margin: 24px var(--padding) 12px; font-weight: 700; }
        
        .search-container { padding: 0 var(--padding); margin-bottom: 15px; }
        .search-bar {
            width: 100%; background: var(--glass-panel);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            padding: 12px 16px; border-radius: 14px;
            display: flex; align-items: center; font-size: 1rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .search-bar:focus-within { background: rgba(100, 100, 100, 0.2); }
        .search-bar input { background: transparent; border: none; width: 100%; color: inherit; font-size: inherit; margin-left: 10px; }

        .filters { display: flex; gap: 10px; padding: 0 var(--padding); margin-bottom: 20px; overflow-x: auto; }
        .chip {
            padding: 8px 16px; background: var(--surface-color); border-radius: 20px;
            font-size: 0.85rem; font-weight: 600; color: var(--text-secondary);
            border: 1px solid transparent; transition: all 0.2s; white-space: nowrap;
        }
        .chip.active { background: var(--text-primary); color: var(--bg-color); }

        .horizontal-scroll { display: flex; gap: 16px; overflow-x: auto; padding: 0 var(--padding) 10px; }
        .horizontal-scroll::-webkit-scrollbar { display: none; }
        
        .podcast-card { min-width: 140px; width: 140px; display: flex; flex-direction: column; gap: 8px; cursor: pointer; }
        .cover-art {
            width: 100%; aspect-ratio: 1; background: var(--surface-highlight);
            border-radius: 16px; overflow: hidden; position: relative;
        }
        .cover-art img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        .podcast-card:hover .cover-art img { transform: scale(1.05); }

        .list-item {
            display: flex; align-items: center; gap: 16px; padding: 12px var(--padding);
            border-bottom: 1px solid rgba(255,255,255,0.03); transition: background 0.2s;
            cursor: pointer;
        }
        .list-item:active { background: var(--surface-highlight); }
        .list-img { width: 56px; height: 56px; border-radius: 12px; background: var(--surface-highlight); object-fit: cover; flex-shrink: 0; }
        .list-rank {
            font-size: 1.2rem; font-weight: 900; color: var(--text-secondary); width: 30px; text-align: center; font-variant-numeric: tabular-nums;
        }
        
        /* --- BADGES --- */
        .verified-badge { width: 14px; height: 14px; margin-left: 4px; vertical-align: middle; display: inline-block; visibility: hidden; }
        .verified-badge.visible { visibility: visible; }
        .verified-badge.lg { width: 18px; height: 18px; margin-left: 6px; }
        [data-theme="dark"] .verified-badge { fill: #ffffff; filter: drop-shadow(0 0 4px rgba(255,255,255,0.5)); }
        [data-theme="light"] .verified-badge { fill: #000000; filter: none; }

        .new-badge {
            font-size: 0.6rem; font-weight: 900; letter-spacing: 0.5px;
            background: var(--text-primary); color: var(--bg-color);
            padding: 3px 6px; border-radius: 6px; margin-left: 8px;
            vertical-align: middle; display: inline-block;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .chart-badge {
            font-size: 0.65rem; font-weight: 700;
            background: var(--surface-highlight); color: var(--text-secondary);
            padding: 2px 8px; border-radius: 4px; margin-left: 8px;
            vertical-align: middle; display: inline-flex; align-items: center; gap: 4px;
        }

        /* --- ODOMETER ANIMATION --- */
        .odometer-wrapper {
            display: inline-flex; align-items: baseline; overflow: hidden;
            height: 1.2em; line-height: 1.2em; vertical-align: bottom;
            font-variant-numeric: tabular-nums; opacity: 0;
            transition: opacity 0.3s ease;
        }
        .odometer-wrapper.active { opacity: 1; }
        .odometer-digit { display: inline-block; height: 1.2em; position: relative; }
        .odometer-ribbon {
            display: flex; flex-direction: column;
            transition: transform 1.2s cubic-bezier(0.16, 1, 0.3, 1);
            will-change: transform;
        }
        .odometer-ribbon div { height: 1.2em; display: flex; justify-content: center; align-items: center; }
        .odometer-static { display: inline-block; }
        .pop-effect { animation: pop-bright 0.2s ease-out forwards; }
        @keyframes pop-bright {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.1); filter: brightness(1.3); }
            100% { transform: scale(1); filter: brightness(1); }
        }

        /* --- PROFILE DETAIL VIEW --- */
        #view-profile-detail { 
            background: var(--bg-color); 
            z-index: 50; 
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            overflow-y: auto; 
            padding-bottom: calc(100px + var(--safe-bottom) + 80px); 
            overscroll-behavior: contain;
            transition: left 0.3s, width 0.3s;
        }
        .profile-header {
            padding: var(--padding); padding-top: 80px; display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .profile-art { width: 160px; height: 160px; border-radius: 30px; margin-bottom: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); object-fit: cover; }
        .profile-btn-row { display: flex; gap: 15px; margin-top: 20px; width: 100%; justify-content: center; }
        
        .chirp-btn-lg {
            display: flex; align-items: center; gap: 8px; padding: 12px 30px;
            border-radius: 30px; font-weight: 700; border: 1px solid var(--surface-highlight);
            background: var(--surface-color); color: var(--text-primary);
            transition: all 0.2s;
        }
        .chirp-btn-lg.active {
            background: var(--text-primary); color: var(--bg-color); transform: scale(1.05); border-color: var(--text-primary);
        }
        .chirp-btn-lg:active { transform: scale(0.95); }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 var(--padding); margin-top: 20px; }
        .stat-box {
            background: var(--surface-color); padding: 15px; border-radius: 16px;
            display: flex; flex-direction: column; gap: 4px;
        }

        /* --- MODALS --- */
        #install-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            width: 85%; max-width: 320px; background: var(--surface-color);
            padding: 24px; border-radius: 24px; text-align: center;
            z-index: 500; opacity: 0; pointer-events: none;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);
        }
        #install-modal.active { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }
        .install-btn { padding: 12px 24px; border-radius: 12px; font-weight: 700; margin: 0 5px; cursor: pointer; }
        .btn-yes { background: var(--text-primary); color: var(--bg-color); }
        .btn-no { background: var(--surface-highlight); color: var(--text-secondary); }

        #creators-modal {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--surface-color); border-top-left-radius: 30px; border-top-right-radius: 30px;
            z-index: 400; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            padding: 20px; padding-bottom: max(40px, var(--safe-bottom));
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }
        #creators-modal.active { transform: translateY(0); }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 350; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .creator-item {
            padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 1.1rem; font-weight: 500; display: flex; justify-content: space-between; align-items: center;
        }
        .creator-item:last-child { border-bottom: none; }
        .creator-item:active { background: var(--surface-highlight); border-radius: 12px; }

        /* --- MINI PLAYER & NAV --- */
        #mini-player {
            position: absolute; bottom: calc(var(--nav-height) + var(--safe-bottom)); left: 0; width: 100%;
            height: var(--mini-player-height); background: var(--glass);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.05);
            display: flex; align-items: center; padding: 0 var(--padding);
            z-index: 90; transition: transform 0.3s ease, left 0.3s, width 0.3s;
        }
        #mini-player.expanded { transform: translateY(200%); }

        nav {
            position: absolute; bottom: 0; width: 100%; 
            height: calc(var(--nav-height) + var(--safe-bottom));
            background: var(--bg-color); display: flex; justify-content: space-around;
            padding-top: 15px; padding-bottom: var(--safe-bottom);
            border-top: 1px solid rgba(255,255,255,0.05); z-index: 100;
            align-items: flex-start;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 6px; color: var(--text-secondary); opacity: 0.7; transition: 0.2s; }
        .nav-item.active { color: var(--text-primary); opacity: 1; }

        /* --- FULL PLAYER --- */
        #full-player {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(10, 10, 10, 0.65);
            backdrop-filter: blur(45px) saturate(180%); -webkit-backdrop-filter: blur(45px) saturate(180%);
            z-index: 200; display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            overflow: hidden; 
            padding: max(20px, var(--safe-top)) var(--padding) max(20px, var(--safe-bottom));
        }
        #full-player.active { transform: translateY(0); }
        [data-theme="light"] #full-player { background: rgba(255, 255, 255, 0.65); }

        .player-top { flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .player-art-area { flex: 1; display: flex; align-items: center; justify-content: center; min-height: 0; margin-bottom: 20px; position: relative; }
        .player-art-wrapper { width: 100%; height: 100%; max-width: 340px; max-height: 340px; aspect-ratio: 1; border-radius: 24px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .player-art-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        .player-info { flex: 0 0 auto; margin-bottom: 10px; text-align: left; }
        .player-controls-area { flex: 0 0 auto; width: 100%; }

        /* LYRICS OVERLAY */
        #lyrics-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(15px);
            z-index: 10; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            border-radius: 24px; padding: 30px;
        }
        #lyrics-overlay.active { opacity: 1; pointer-events: auto; }
        .lyrics-text { font-size: 1.4rem; font-weight: 600; line-height: 1.6; color: #fff; min-height: 100px; transition: opacity 0.2s; }
        
        .clickable-artist { text-decoration: underline; text-decoration-color: transparent; transition: 0.2s; cursor: pointer; }
        .clickable-artist.has-multi { text-decoration-color: var(--text-secondary); }
        .clickable-artist.has-multi:active { color: var(--text-primary); }

        /* --- TOAST --- */
        #toast {
            position: fixed; top: -60px; left: 50%; transform: translateX(-50%);
            background: var(--text-primary); color: var(--bg-color);
            padding: 12px 24px; border-radius: 30px; font-weight: 700;
            z-index: 300; transition: top 0.4s;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 8px;
        }
        #toast.show { top: 20px; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .popping { animation: pop 0.3s ease; }

        /* Loader */
        .spinner { width: 20px; height: 20px; border: 2px solid var(--text-secondary); border-top-color: var(--text-primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 10px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ================= DESKTOP STYLES ================= */
        @media (min-width: 768px) {
            header, nav { display: none !important; }
            #desktop-sidebar { display: flex; }
            main { margin-left: var(--sidebar-width); padding-bottom: calc(var(--mini-player-height) + 40px); height: 100vh; }
            #view-profile-detail { left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); padding-bottom: 120px; }
            #view-profile-detail > div:first-child { top: 20px; left: 30px; }
            #mini-player { left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); bottom: 0; }
            #full-player {
                left: 50%; top: 50%; width: 450px; height: 85vh;
                transform: translate(-50%, 150%); border-radius: 24px;
                border: 1px solid var(--glass-border);
                box-shadow: 0 40px 80px rgba(0,0,0,0.6);
            }
            #full-player.active { transform: translate(-50%, -50%); }
            .player-top { margin-top: 10px; }
            #full-player::before {
                content: ''; position: fixed; top: -50vh; left: -50vw; width: 200vw; height: 200vh;
                background: rgba(0,0,0,0.7); z-index: -1; pointer-events: none; opacity: 0; transition: opacity 0.4s;
            }
            #full-player.active::before { opacity: 1; pointer-events: auto; }
        }
    </style>
</head>
<body data-theme="dark">

    <div id="app">
        <!-- DESKTOP SIDEBAR -->
        <aside id="desktop-sidebar">
            <div class="brand"><img src="siteicon.png" alt="icon"> Chirpless</div>
            <div class="sidebar-menu">
                <div class="sidebar-item active" onclick="switchView('home', this)">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg> Home
                </div>
                <div class="sidebar-item" onclick="switchView('discover', this)">
                    <svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Discover
                </div>
                <div class="sidebar-item" onclick="switchView('library', this)">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg> Library
                </div>
            </div>
            <div style="cursor:pointer; display:flex; align-items:center; gap:12px; color:var(--text-secondary); font-weight:600; padding:12px 16px;" onclick="toggleTheme()">
                <svg class="icon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg> Theme
            </div>
        </aside>

        <!-- HEADER -->
        <header>
            <div class="brand"><img src="siteicon.png" alt="icon"> Chirpless</div>
            <button onclick="toggleTheme()" style="background:none; border:none; color:inherit;">
                <!-- Explicit Stroke for Icon Visibility -->
                <svg class="icon" style="stroke: currentColor; stroke-width: 2;" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
        </header>

        <main id="main-content">
            <div id="view-home" class="view">
                <div class="section-title">Trending Now</div>
                <div class="horizontal-scroll" id="trending-container" style="min-height:200px"><div class="spinner"></div></div>
                <div class="section-title">Recommended for You</div>
                <div class="horizontal-scroll" id="mix-container" style="min-height:200px"><div class="spinner"></div></div>
                <div style="height:20px"></div>
            </div>

            <div id="view-discover" class="view hidden">
                <div class="section-title">Explore</div>
                <div class="search-container">
                    <div class="search-bar">
                        <svg class="icon" style="opacity:0.5; width:20px;" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                        <input type="search" id="search-input" placeholder="Search..." onkeypress="handleSearch(event)">
                    </div>
                </div>
                <div class="filters">
                    <div class="chip active" onclick="setFilter('all', this)">All</div>
                    <div class="chip" onclick="setFilter('profile', this)">Profiles</div>
                    <div class="chip" onclick="setFilter('episode', this)">Episodes</div>
                    <div class="chip" onclick="setFilter('charts', this)">Charts</div>
                </div>
                <div id="search-results">
                    <div style="text-align:center; color:var(--text-secondary); margin-top:40px;">Find creators and stories.</div>
                </div>
            </div>

            <div id="view-library" class="view hidden">
                <div class="section-title">Your Chirps</div>
                <div id="library-list"></div>
            </div>
        </main>

        <!-- PROFILE DETAIL VIEW -->
        <div id="view-profile-detail" class="hidden">
            <div style="position:absolute; top:max(15px, env(safe-area-inset-top)); left:20px; z-index:10;">
                <button onclick="closeProfile()" style="background:var(--glass); width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:none; color:var(--text-primary);">
                    <svg class="icon" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
                </button>
            </div>
            
            <div class="profile-header">
                <img id="pd-img" src="" class="profile-art">
                <h1 id="pd-title" style="margin:0; font-size:1.8rem; line-height:1.2;">Title</h1>
                <p id="pd-artist-container" style="margin:8px 0;">
                    <span id="pd-artist" class="text-secondary clickable-artist" onclick="handleArtistClick(this.innerText)">Artist</span>
                    <svg class="verified-badge lg" id="pd-verified" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                </p>
                <div class="profile-btn-row">
                    <button id="pd-chirp-btn" class="chirp-btn-lg" onclick="toggleProfileChirp()">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
                        <span id="pd-chirp-text">Chirp</span>
                    </button>
                </div>
            </div>

            <div class="filters" style="justify-content:center; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:15px;">
                <div class="chip active" id="tab-episodes" onclick="switchProfileTab('episodes')">Episodes</div>
                <div class="chip" id="tab-stats" onclick="switchProfileTab('stats')">Stats</div>
            </div>

            <div id="pd-content-episodes" style="padding-bottom:100px;"></div>
            <div id="pd-loading-more" class="hidden"><div class="spinner"></div></div>

            <div id="pd-content-stats" class="hidden" style="padding-bottom:100px;">
                <div class="stats-grid">
                    <div class="stat-box">
                        <span class="text-xs text-secondary">Total Chirps</span>
                        <span class="font-bold odometer-container" style="font-size:1.5rem" id="stat-chirps"></span>
                    </div>
                    <div class="stat-box">
                        <span class="text-xs text-secondary">Total Cash Earned ($0.006/stream)</span>
                        <span class="font-bold odometer-container" style="font-size:1.8rem; color:var(--text-primary);" id="stat-cash">--</span>
                    </div>
                </div>
                <div style="padding:20px; text-align:center; color:var(--text-secondary); font-size:0.8rem; line-height:1.5;">
                    Analytics for displayed episodes.
                </div>
            </div>
        </div>

        <!-- MODALS -->
        <div class="modal-overlay" id="install-overlay"></div>
        <div id="install-modal">
            <h2 style="margin-top:0;">Install Chirpless?</h2>
            <p style="color:var(--text-secondary); margin-bottom:20px;">Get the full app experience on your home screen.</p>
            <div class="flex justify-center">
                <button class="install-btn btn-no" onclick="dismissInstall()">No</button>
                <button class="install-btn btn-yes" onclick="triggerInstall()">Yes</button>
            </div>
        </div>

        <div class="modal-overlay" id="modal-overlay" onclick="closeCreatorsModal()"></div>
        <div id="creators-modal">
            <div style="text-align:center; font-weight:bold; margin-bottom:20px; opacity:0.6;">Featured Creators</div>
            <div id="creators-list"></div>
        </div>

        <div id="toast"><svg width="20" height="20" viewBox="0 0 24 24" fill="var(--bg-color)"><path d="M21 15C21 19 17 22 13 22C9 22 10 18 10 15C10 12 5 10 3 8C5.5 6 12 2 12 2Z"/></svg> Chirped!</div>

        <!-- MINI PLAYER -->
        <div id="mini-player" onclick="openFullPlayer()">
            <img id="mini-img" src="" class="list-img" style="opacity:0">
            <div style="flex:1; margin-left:12px; overflow:hidden;">
                <div id="mini-title" class="font-bold text-sm" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Select a chirp</div>
                <div id="mini-artist" class="text-xs text-secondary">Chirpless</div>
            </div>
            <button id="mini-play-btn" onclick="event.stopPropagation(); togglePlay()" style="padding:10px; background:none; border:none; color:inherit;">
                <svg class="icon" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
            </button>
        </div>

        <!-- NAV -->
        <nav>
            <div class="nav-item active" onclick="switchView('home', this)">
                <svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg> Home
            </div>
            <div class="nav-item" onclick="switchView('discover', this)">
                <svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Discover
            </div>
            <div class="nav-item" onclick="switchView('library', this)">
                <svg class="icon" viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg> Library
            </div>
        </nav>

        <!-- FULL PLAYER -->
        <div id="full-player">
            <div class="player-top">
                <button onclick="closeFullPlayer()" style="background:none; border:none; color:inherit;"><svg class="icon" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg></button>
                <span class="text-xs font-bold" style="letter-spacing:2px;">NOW PLAYING</span>
                <div style="width:24px;"></div>
            </div>

            <div class="player-art-area">
                <div class="player-art-wrapper">
                    <img id="fp-img" src="" alt="Album Art">
                    <div id="lyrics-overlay">
                        <div class="spinner" id="lyrics-spinner" style="margin-bottom:20px;"></div>
                        <div class="lyrics-text" id="lyrics-content">Transcribing Audio Stream...</div>
                    </div>
                </div>
            </div>

            <div class="player-info">
                <h2 id="fp-title" style="margin:0; font-size:1.5rem; line-height:1.2; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">Title</h2>
                <p id="fp-artist" class="text-secondary clickable-artist" onclick="handleArtistClick(this.innerText)" style="margin:5px 0 0;">Artist</p>
            </div>

            <div class="player-controls-area">
                <div class="flex justify-between items-center" style="margin-bottom:15px; padding:0 10px;">
                    <button onclick="toggleLyrics()" style="color:var(--text-secondary); background:none; border:none;">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><line x1="9" y1="10" x2="15" y2="10"/><line x1="9" y1="6" x2="15" y2="6"/></svg>
                    </button>
                    <canvas id="wave-canvas" style="flex:1; height:40px; margin:0 15px; opacity:0.6;"></canvas>
                </div>
                
                <div id="progress-container" onclick="seek(event)" style="width:100%; height:20px; display:flex; align-items:center;">
                    <div style="width:100%; height:4px; background:var(--accent-dim); border-radius:2px; overflow:hidden;">
                        <div id="progress-fill" style="width:0%; height:100%; background:var(--text-primary);"></div>
                    </div>
                </div>
                <div class="flex justify-between text-xs text-secondary" style="margin-bottom:20px;">
                    <span id="time-current">0:00</span>
                    <span id="time-total">0:00</span>
                </div>

                <div class="flex justify-between items-center" style="max-width:350px; margin:0 auto;">
                    <button class="bird-btn" id="fp-bird-btn" onclick="toggleTrackChirp()" style="background:var(--surface-highlight); width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:inherit; border:none;">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
                    </button>
                    
                    <button onclick="skip(-15)" style="background:none; border:none; color:inherit;"><svg class="icon" style="width:32px; height:32px;" viewBox="0 0 24 24"><path d="M11 17l-5-5 5-5M18 17l-5-5 5-5"/></svg></button>
                    
                    <button onclick="togglePlay()" style="width:70px; height:70px; background:var(--text-primary); color:var(--bg-color); border-radius:50%; display:flex; align-items:center; justify-content:center; border:none;">
                        <svg id="fp-play-icon" style="width:32px; height:32px; fill:currentColor; stroke:none;" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                    </button>
                    
                    <button onclick="skip(15)" style="background:none; border:none; color:inherit;"><svg class="icon" style="width:32px; height:32px;" viewBox="0 0 24 24"><path d="M13 17l5-5-5-5M6 17l5-5-5-5"/></svg></button>
                    
                    <button onclick="changeSpeed()" style="background:var(--surface-highlight); width:44px; height:44px; border-radius:50%; font-weight:bold; font-size:0.8rem; border:none; color:inherit;" id="speed-btn">1x</button>
                </div>
            </div>
        </div>
    </div>

    <audio id="audio-player" preload="none"></audio>

    <script>
        // --- 1. STATE & CONFIG ---
        let currentTrack = null; let isPlaying = false; let playbackSpeed = 1.0; let currentFilter = 'all';
        let savedChirps = JSON.parse(localStorage.getItem('chirps_v30') || '[]');
        let savedProfileChirps = JSON.parse(localStorage.getItem('profile_chirps_v30') || '[]');
        let currentProfileId = null; let currentProfileEpisodes = []; let renderedEpisodeCount = 0; const EPISODES_PER_PAGE = 10;
        let activeProfileStats = null;
        let lyricsInterval;
        let deferredPrompt;

        const VERIFIED_BADGE_HTML = `<svg class="verified-badge" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>`;
        const PODCAST_SCRIPT = ["So, I was thinking about this the other day.","Right, exactly.","It's a complex issue.","Data suggests otherwise.","Wait, let me pull that up.","Ideally, yes.","That's fascinating.","Moving on.","Incredible point.","Let's dive deeper."];

        // --- 2. UTILITY FUNCTIONS (Must be defined first) ---
        function formatTime(s) {
            if(!s) return "0:00";
            const m = Math.floor(s/60);
            const sec = Math.floor(s%60);
            return `${m}:${sec<10?'0':''}${sec}`;
        }
        function seededRandom(str) { let h=1779033703^str.length; for(let i=0;i<str.length;i++)h=Math.imul(h^str.charCodeAt(i),3432918353); return function(){h=Math.imul(h^(h>>>16),2246822507);h=Math.imul(h^(h>>>13),3266489909);return(h>>>0)/4294967296;} }
        function formatNumber(n) { if(isNaN(n))return"0"; if(n>=1e9)return(n/1e9).toFixed(1)+'b'; if(n>=1e6)return(n/1e6).toFixed(1)+'m'; if(n>=1e3)return(n/1e3).toFixed(1)+'k'; return n.toLocaleString(); }
        function formatCurrency(n) { if(isNaN(n))return"$0.00"; return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(n); }
        function isNewEpisode(d) { if(!d)return false; const date=new Date(d); if(isNaN(date.getTime()))return false; return(new Date()-date)<(7*24*60*60*1000); }
        function timeAgo(d) { const s=Math.floor((new Date()-new Date(d))/1000); if(s<60)return'now'; if(s<3600)return Math.floor(s/60)+'m'; if(s<86400)return Math.floor(s/3600)+'h'; if(s<604800)return Math.floor(s/86400)+'d'; return Math.floor(s/604800)+'w'; }

        // --- 3. STATS LOGIC ---
        function getDeterministicStats(id, isProfile=false, dateStr=null) {
            const rng=seededRandom(id); const t=rng(), v=rng();
            let minC=3000, maxC=281000;
            if(t<0.4){minC=3000;maxC=281000} else if(t<0.7){minC=1200;maxC=14200000} else if(t<0.9){minC=827000;maxC=28000000} else {minC=5000000;maxC=5000000000}
            if(isProfile) { const c=Math.floor(minC+Math.pow(v,2)*(maxC-minC)); return {chirps:c, listens:0, cash:0}; }
            let epMin=Math.floor(minC/50), epMax=Math.floor(maxC/20); if(epMin<100)epMin=100;
            if(dateStr){ const d=new Date(dateStr); if(!isNaN(d.getTime())) { const h=(new Date()-d)/(1000*60*60); if(h<24)epMax=Math.min(epMax,15000); else if(h<168)epMax=Math.min(epMax,500000); else if(h<720)epMax=Math.min(epMax,5000000); } }
            const c=Math.floor(epMin+Math.pow(v,3)*(epMax-epMin));
            const l=c*20; const cash=l*0.006;
            return {listens:l, chirps:c, cash:cash};
        }
        function getChartRank(id) { const rng=seededRandom(id+"_chart"); return rng()>0.8?Math.floor(rng()*45)+1:null; }
        function getTopNewRank(id,d) { if(!isNewEpisode(d))return null; const rng=seededRandom(id+"_newchart"); return rng()>0.7?Math.floor(rng()*45)+1:null; }

        // --- 4. DOM & ANIMATION HELPERS ---
        function updateOdometer(c, val) {
            if(!c)return; const fmt=typeof val==='number'?formatNumber(val):val;
            if(!c.hasChildNodes()){
                c.innerHTML='';c.classList.add('odometer-wrapper');
                fmt.split('').forEach(ch=>{
                    if(/[0-9]/.test(ch)){
                        const w=document.createElement('span');w.className='odometer-digit';
                        const r=document.createElement('div');r.className='odometer-ribbon';
                        for(let i=0;i<=9;i++){const d=document.createElement('div');d.innerText=i;r.appendChild(d)}
                        w.appendChild(r);c.appendChild(w);
                    }else{const s=document.createElement('span');s.className='odometer-static';s.innerText=ch;c.appendChild(s)}
                });
            }
            requestAnimationFrame(()=>{requestAnimationFrame(()=>{
                c.classList.add('active');c.classList.add('pop-effect');
                const chs=fmt.split(''); let idx=0;
                Array.from(c.children).forEach(child=>{
                    if(child.classList.contains('odometer-digit')){
                        const t=parseInt(chs[idx]); const r=child.querySelector('.odometer-ribbon');
                        if(r&&!isNaN(t))r.style.transform=`translateY(${t*-1.2}em)`;
                    } idx++;
                });
                setTimeout(()=>c.classList.remove('pop-effect'),500);
            })});
        }
        function simLive(){if(activeProfileStats&&!document.getElementById('pd-content-stats').classList.contains('hidden')){activeProfileStats.chirps+=Math.floor(Math.random()*5)+1;activeProfileStats.cash=activeProfileStats.chirps*20*0.006;updateOdometer(document.getElementById('stat-chirps'),activeProfileStats.chirps);updateOdometer(document.getElementById('stat-cash'),formatCurrency(activeProfileStats.cash));}}

        // --- 5. APP LOGIC ---
        async function search(q){
            let ent='podcastEpisode'; if(currentFilter==='profile')ent='podcast';
            try{
                const r=await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(q)}&media=podcast&entity=${ent}&limit=45&_t=${Date.now()}`);
                const d=await r.json(); return (d.results||[]).map(i=>({
                    id:i.trackId||i.collectionId, type:i.kind==='podcast'?'profile':'episode',
                    title:i.trackName||i.collectionName||'Untitled', collectionName:i.collectionName||i.trackName,
                    artist:i.artistName||i.collectionName||'Unknown', image:i.artworkUrl600,
                    src:i.episodeUrl, collectionId:i.collectionId, date:i.releaseDate
                }));
            }catch(e){return[]}
        }

        async function fetchProfileEpisodes(id, fallback, original){
            try{
                const r=await fetch(`https://itunes.apple.com/lookup?id=${id}&media=podcast&entity=podcastEpisode&limit=60&_t=${Date.now()}`);
                const d=await r.json(); if(!d.results||d.results.length===0)throw new Error();
                const art=d.results[0].artistName||d.results[0].collectionName||"Unknown";
                return d.results.slice(1).map(i=>({id:i.trackId, title:i.trackName||"Untitled", src:i.episodeUrl, image:i.artworkUrl600, artist:art, date:i.releaseDate}));
            }catch(e){
                if(fallback){const r=await search(fallback); if(r.length>0)return r.filter(x=>x.type==='episode');}
                if(original)return[{id:original.id, title:original.title, src:original.src, image:original.image, artist:original.artist, date:original.date}];
                return [];
            }
        }

        function init(){
            renderLibrary(); loadHomeContent(); setInterval(simLive,1400); 
            document.getElementById('view-profile-detail').addEventListener('scroll',e=>{if(e.target.scrollTop+e.target.clientHeight>=e.target.scrollHeight-50)renderMore();});
            switchView('home', document.querySelectorAll('.nav-item')[0]);
        }

        async function loadHomeContent(){
            const t=document.getElementById('trending-container'); t.innerHTML='';
            const res=await search('Popular'); if(res.length===0)t.innerHTML='<div style="padding:20px;opacity:0.5">Offline</div>';
            else res.slice(0,10).forEach(i=>createCard(i,t));
            const m=document.getElementById('mix-container'); m.innerHTML='';
            const mix=await search('Documentary'); if(mix.length>0)mix.slice(0,10).forEach(i=>createCard(i,m));
        }

        function createCard(i,c){
            const s=getDeterministicStats(i.id.toString(),true);
            const v=s.chirps>5e7?VERIFIED_BADGE_HTML:'';
            const d=document.createElement('div'); d.className='podcast-card premium-hover';
            d.onclick=()=>i.type==='profile'?openProfile(i):playTrack(i);
            d.innerHTML=`<div class="cover-art"><img src="${i.image}"></div><div style="font-weight:700;font-size:0.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${i.title}</div><div style="font-size:0.8rem;opacity:0.6;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${i.artist} ${v}</div>`;
            c.appendChild(d);
        }

        function setFilter(f,b){
            currentFilter=f; 
            document.querySelectorAll('.filters .chip').forEach(c=>c.classList.remove('active')); 
            b.classList.add('active'); 
            if(f==='charts') renderCharts(); 
            else{
                const v=document.getElementById('search-input').value; 
                if(v)doSearch(v); 
                else document.getElementById('search-results').innerHTML='<div style="text-align:center;padding:40px;opacity:0.5">Find content</div>';
            }
        }
        
        async function renderCharts(){
            const c=document.getElementById('search-results'); c.innerHTML='<div class="spinner"></div>';
            const r=await search('Podcast Hits'); c.innerHTML='';
            const tDiv = document.createElement('div'); tDiv.className='section-title'; tDiv.innerText='Top 45 Global'; c.appendChild(tDiv);
            r.slice(0,45).forEach((i,x)=>{
                const el=document.createElement('div');el.className='list-item premium-hover';
                el.onclick=()=>i.type==='profile'?openProfile(i):playTrack(i);
                el.innerHTML=`<div class="list-rank">${x+1}</div><img src="${i.image}" class="list-img"><div style="flex:1"><div style="font-weight:700;font-size:0.95rem">${i.title}</div><div style="font-size:0.8rem;opacity:0.6">${i.artist}</div></div>`;
                c.appendChild(el);
            });
            const nDiv = document.createElement('div'); nDiv.className='section-title'; nDiv.innerText='Top New'; c.appendChild(nDiv);
            const n=r.filter(x=>isNewEpisode(x.date)).slice(0,45);
            if(!n.length) {const empty = document.createElement('div'); empty.style.cssText='padding:20px;opacity:0.5;text-align:center'; empty.innerText='No new entries'; c.appendChild(empty);}
            else n.forEach((i,x)=>{
                const el=document.createElement('div');el.className='list-item premium-hover';
                el.onclick=()=>playTrack(i);
                el.innerHTML=`<div class="list-rank" style="color:var(--text-primary)">${x+1}</div><img src="${i.image}" class="list-img"><div style="flex:1"><div style="font-weight:700;font-size:0.95rem">${i.title} <span class="new-badge">NEW</span></div><div style="font-size:0.8rem;opacity:0.6">${i.artist}</div></div>`;
                c.appendChild(el);
            });
        }

        function handleSearch(e){
            if(e.key==='Enter'){
                document.getElementById('search-input').blur();
                if(currentFilter==='charts') setFilter('all',document.querySelector('.filters .chip'));
                doSearch(e.target.value);
            }
        }

        async function doSearch(q){
            const c=document.getElementById('search-results'); c.innerHTML='<div class="spinner"></div>';
            const r=await search(q); c.innerHTML=''; 
            if(r.length===0){c.innerHTML='<div style="text-align:center;opacity:0.5;padding:20px">No results</div>';return;}
            r.forEach(i=>{
                const s=getDeterministicStats(i.id.toString(), i.type==='profile', i.date);
                const el=document.createElement('div'); el.className='list-item premium-hover';
                if(i.type==='profile'){
                    el.onclick=()=>openProfile(i);
                    const v=s.chirps>5e7?VERIFIED_BADGE_HTML:'';
                    el.innerHTML=`<img src="${i.image}" class="list-img" style="border-radius:50%"><div style="flex:1" class="info-col"><div style="font-weight:700">${i.title} ${v}</div><div style="opacity:0.6;font-size:0.85rem">Podcast • ${i.artist}</div></div><button style="padding:6px 14px;border-radius:20px;background:var(--glass-highlight);border:none;color:inherit;font-weight:600">View</button>`;
                    const statContainer = document.createElement('div'); statContainer.className = 'text-xs text-secondary flex items-center gap-1 info-col'; statContainer.style.marginTop = '4px'; statContainer.innerHTML = `<svg class="icon" style="width:12px;height:12px" viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg> <span class="odometer-container"></span>`;
                    el.querySelector('.info-col').appendChild(statContainer);
                    setTimeout(() => updateOdometer(statContainer.querySelector('.odometer-container'), s.chirps), 600);
                }else{
                    el.onclick=()=>playTrack(i);
                    const n=isNewEpisode(i.date)?'<span class="new-badge">NEW</span>':'';
                     const viewProfileBtn = `<button onclick="event.stopPropagation(); openProfile({id:'${i.collectionId}', collectionId:'${i.collectionId}', title:'${i.collectionName?.replace(/'/g, "\\'") || ''}', artist:'${i.artist?.replace(/'/g, "\\'") || ''}', image:'${i.image}'})" style="font-size:0.7rem; padding:4px 8px; background:rgba(255,255,255,0.1); border-radius:8px; margin-left:auto; z-index:2; border:none; color:inherit;">Profile</button>`;
                    el.innerHTML=`<img src="${i.image}" class="list-img"><div style="flex:1"><div style="font-weight:700;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;">${i.title} ${n}</div><div style="display:flex;align-items:center;gap:6px;font-size:0.8rem;opacity:0.6;margin-top:2px;"><span>${timeAgo(i.date)}</span> • <span class="odo-c"></span> Chirps</div></div>${viewProfileBtn}`;
                    setTimeout(()=>updateOdometer(el.querySelector('.odo-c'),s.chirps),300);
                }
                c.appendChild(el);
            });
        }

        async function openProfile(i){
            currentProfileId=(i.collectionId||i.id).toString();
            const v=document.getElementById('view-profile-detail');
            document.getElementById('pd-img').src=i.image; document.getElementById('pd-title').innerText=i.title||i.collectionName;
            document.getElementById('pd-artist').innerText=i.artist;
            if(i.artist.includes(','))document.getElementById('pd-artist').classList.add('has-multi'); else document.getElementById('pd-artist').classList.remove('has-multi');
            
            updateProfBtn(); v.classList.remove('hidden'); 
            switchProfileTab('episodes');
            
            activeProfileStats=null; document.getElementById('stat-chirps').innerHTML=''; document.getElementById('stat-cash').innerHTML='';
            document.getElementById('pd-verified').classList.remove('visible');
            document.getElementById('pd-content-episodes').innerHTML='<div class="spinner"></div>';
            
            currentProfileEpisodes=await fetchProfileEpisodes(i.collectionId||i.id, i.artist, i);
            let ac=0, am=0;
            if(currentProfileEpisodes.length>0){
                currentProfileEpisodes.forEach(e=>{const s=getDeterministicStats(e.id.toString(),false,e.date);ac+=s.chirps;am+=s.cash;});
                activeProfileStats={chirps:ac, cash:am};
                setTimeout(()=>{updateOdometer(document.getElementById('stat-chirps'),ac);updateOdometer(document.getElementById('stat-cash'),formatCurrency(am));},100);
                if(ac>=5e7)document.getElementById('pd-verified').classList.add('visible');
                document.getElementById('pd-content-episodes').innerHTML=''; renderedEpisodeCount=0; renderMore();
            } else { document.getElementById('pd-content-episodes').innerHTML='<div style="text-align:center;padding:20px;opacity:0.5">Empty</div>'; }
        }

        function renderMore(){
            if(renderedEpisodeCount>=currentProfileEpisodes.length)return;
            const c=document.getElementById('pd-content-episodes');
            const end=Math.min(renderedEpisodeCount+EPISODES_PER_PAGE, currentProfileEpisodes.length);
            for(let i=renderedEpisodeCount;i<end;i++){
                const e=currentProfileEpisodes[i]; const s=getDeterministicStats(e.id.toString(),false,e.date);
                const d=document.createElement('div'); d.className='list-item premium-hover';
                if(!e.artist)e.artist=document.getElementById('pd-artist').innerText;
                const n=isNewEpisode(e.date)?'<span class="new-badge">NEW</span>':'';
                d.onclick=()=>playTrack(e);
                d.innerHTML=`<div style="width:44px;height:44px;background:rgba(255,255,255,0.1);border-radius:50%;display:flex;align-items:center;justify-content:center"><svg class="icon" style="width:18px" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg></div><div style="flex:1"><div style="font-weight:700;font-size:0.95rem;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden">${e.title} ${n}</div><div style="font-size:0.8rem;opacity:0.6;margin-top:4px;display:flex;gap:8px"><span>${timeAgo(e.date)}</span> • <span class="odo-sub"></span></div></div>`;
                c.appendChild(d); setTimeout(()=>updateOdometer(d.querySelector('.odo-sub'),s.chirps),50+(i-renderedEpisodeCount)*30);
            }
            renderedEpisodeCount=end;
        }

        // --- UI HANDLERS ---
        function renderLibrary(){const l=document.getElementById('library-list'); l.innerHTML=''; if(!savedChirps.length){l.innerHTML='<div style="padding:20px;opacity:0.5;text-align:center">No saved chirps</div>';return;} savedChirps.forEach(i=>{const d=document.createElement('div');d.className='list-item premium-hover';d.onclick=()=>playTrack(i);d.innerHTML=`<img src="${i.image}" class="list-img"><div style="flex:1"><div style="font-weight:700;font-size:0.95rem">${i.title}</div><div style="font-size:0.8rem;opacity:0.6">Saved</div></div>`;l.appendChild(d);});}
        
        function switchView(n,el){
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-discover').classList.add('hidden');
            document.getElementById('view-library').classList.add('hidden');
            document.getElementById('view-'+n).classList.remove('hidden'); 
            if(el) {
                const targetText = el.innerText.trim();
                document.querySelectorAll('.nav-item, .sidebar-item').forEach(i=>{
                    i.classList.remove('active');
                    if(i.innerText.trim()===targetText) i.classList.add('active');
                });
            }
        }
        
        function closeProfile(){document.getElementById('view-profile-detail').classList.add('hidden'); activeProfileStats=null;}
        
        function switchProfileTab(t){
            document.getElementById('tab-episodes').classList.toggle('active',t==='episodes'); document.getElementById('tab-stats').classList.toggle('active',t==='stats');
            const s=document.getElementById('pd-content-stats'); const e=document.getElementById('pd-content-episodes');
            if(t==='stats'){e.classList.add('hidden');s.classList.remove('hidden');if(activeProfileStats){const c=document.getElementById('stat-chirps'),m=document.getElementById('stat-cash');c.innerHTML='';m.innerHTML='';setTimeout(()=>{updateOdometer(c,activeProfileStats.chirps);updateOdometer(m,formatCurrency(activeProfileStats.cash));},50);}}else{s.classList.add('hidden');e.classList.remove('hidden');}
        }
        
        function toggleTrackChirp(){if(!currentTrack)return; const i=savedChirps.findIndex(x=>x.id===currentTrack.id); if(i>-1)savedChirps.splice(i,1); else{savedChirps.unshift(currentTrack);showToast();} localStorage.setItem('chirps_v29',JSON.stringify(savedChirps)); renderLibrary(); const b=document.getElementById('fp-bird-btn'); const is=savedChirps.some(x=>x.id===currentTrack.id); b.style.background=is?'var(--text-primary)':'rgba(255,255,255,0.1)'; b.style.color=is?'var(--bg-color)':'inherit';}
        function toggleProfileChirp(){const i=savedProfileChirps.indexOf(currentProfileId); if(i>-1)savedProfileChirps.splice(i,1); else{savedProfileChirps.push(currentProfileId);showToast();} localStorage.setItem('profile_chirps_v29',JSON.stringify(savedProfileChirps)); updateProfBtn();}
        function updateProfBtn(){const a=savedProfileChirps.includes(currentProfileId); const b=document.getElementById('pd-chirp-btn'), t=document.getElementById('pd-chirp-text'); if(a){b.classList.add('active');t.innerText="Chirped!";}else{b.classList.remove('active');t.innerText="Chirp";}}
        function updPlay(){const p=isPlaying?'<rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect>':'<polygon points="5 3 19 12 5 21 5 3"></polygon>'; document.querySelectorAll('#mini-play-btn svg,#fp-play-icon').forEach(s=>s.innerHTML=p);}
        function togglePlay(){const a=document.getElementById('audio-player'); if(a.paused&&a.src){a.play();isPlaying=true;startWaveform();}else{a.pause();isPlaying=false;}updPlay();}
        function playTrack(t){currentTrack=t; document.getElementById('mini-img').src=t.image; document.getElementById('mini-title').innerText=t.title; document.getElementById('mini-artist').innerText=t.artist; document.getElementById('fp-img').src=t.image; document.getElementById('fp-title').innerText=t.title; document.getElementById('fp-artist').innerText=t.artist; if(t.artist.includes(','))document.getElementById('fp-artist').classList.add('has-multi'); else document.getElementById('fp-artist').classList.remove('has-multi'); const b=document.getElementById('fp-bird-btn'); const is=savedChirps.some(x=>x.id===t.id); b.style.background=is?'var(--text-primary)':'rgba(255,255,255,0.1)'; b.style.color=is?'var(--bg-color)':'inherit'; const a=document.getElementById('audio-player'); a.src=t.src; a.play().then(()=>{isPlaying=true;updPlay();openFullPlayer();startWaveform();});}
        function openFullPlayer(){document.getElementById('full-player').classList.add('active');document.getElementById('mini-player').classList.add('expanded');}
        function closeFullPlayer(){document.getElementById('full-player').classList.remove('active');document.getElementById('mini-player').classList.remove('expanded');}
        function showToast(){const t=document.getElementById('toast');t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000);}
        function handleArtistClick(str){if(!str)return; const c=str.split(',').filter(x=>x.trim()); if(c.length>1){const l=document.getElementById('creators-list');l.innerHTML='';c.forEach(x=>{const d=document.createElement('div');d.className='creator-item';d.innerHTML=`${x} <svg class="icon" style="width:16px;opacity:0.5" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>`;d.onclick=()=>{closeCreatorsModal();closeFullPlayer();closeProfile();switchView('discover',document.querySelectorAll('.nav-item')[1]);document.getElementById('search-input').value=x.trim();doSearch(x.trim());};l.appendChild(d);});document.getElementById('modal-overlay').classList.add('active');document.getElementById('creators-modal').classList.add('active');}else{closeFullPlayer();closeProfile();switchView('discover',document.querySelectorAll('.nav-item')[1]);document.getElementById('search-input').value=str;doSearch(str);}}
        function closeCreatorsModal(){document.getElementById('modal-overlay').classList.remove('active');document.getElementById('creators-modal').classList.remove('active');}
        function toggleTheme(){document.body.setAttribute('data-theme',document.body.getAttribute('data-theme')==='dark'?'light':'dark');}

        // --- EVENTS ---
        const audioEl = document.getElementById('audio-player');
        audioEl.ontimeupdate=()=>{if(audioEl.duration){const p=(audioEl.currentTime/audioEl.duration)*100; document.getElementById('progress-fill').style.width=p+'%'; document.getElementById('time-current').innerText=formatTime(audioEl.currentTime); document.getElementById('time-total').innerText=formatTime(audioEl.duration);}};
        function changeSpeed(){playbackSpeed=playbackSpeed===1.0?1.5:(playbackSpeed===1.5?2.0:1.0); audioEl.playbackRate=playbackSpeed; document.getElementById('speed-btn').innerText=playbackSpeed+'x';}
        function skip(v){audioEl.currentTime+=v;}
    </script>
</body>
</html>
