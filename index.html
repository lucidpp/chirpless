<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chirpless</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">
    <link rel="icon" href="siteicon.png" type="image/png">
    <link rel="apple-touch-icon" href="siteicon.png">

    <style>
        /* --- RESET & VARS --- */
        :root {
            --bg: #ffffff;
            --text: #000000;
            --subtle: #888888;
            --border: #f0f0f0;
            --accent: #000000;
            --glass: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(0, 0, 0, 0.05);
            --sidebar-width: 260px;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --anim-speed: 0.8s;
            --anim-ease: cubic-bezier(0.25, 1, 0.5, 1);
            
            /* Interaction Colors */
            --like-color: #e0245e; 
            --repost-grad: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #000000;
                --text: #ffffff;
                --subtle: #666666;
                --border: #1f1f1f;
                --accent: #ffffff;
                --glass: rgba(0, 0, 0, 0.9);
                --glass-border: rgba(255, 255, 255, 0.1);
            }
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; font-family: var(--font-main); background: var(--bg); color: var(--text); height: 100%; overflow: hidden; }

        /* --- TYPOGRAPHY --- */
        h1, h2, h3 { margin: 0; font-weight: 700; letter-spacing: -0.02em; }
        p { margin: 0; line-height: 1.5; }
        .bold { font-weight: 600; }
        .subtle { color: var(--subtle); font-size: 0.9rem; }
        .pointer { cursor: pointer; }

        /* --- ODOMETER ANIMATION --- */
        .ticker-root {
            display: inline-flex;
            flex-direction: row;
            align-items: flex-start;
            overflow: hidden;
            height: 1.2em; 
            line-height: 1.2em; 
            vertical-align: text-bottom;
            font-variant-numeric: tabular-nums;
            position: relative;
            mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%);
        }
        .ticker-digit-col {
            display: flex;
            flex-direction: column;
            transition: transform var(--anim-speed) var(--anim-ease);
            will-change: transform;
        }
        .ticker-digit {
            height: 1.2em;
            line-height: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- UI COMPONENTS --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg);
            z-index: 999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.hidden { opacity: 0; pointer-events: none; }
        
        #collab-modal, #note-modal { background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); }
        .modal-card {
            background: var(--bg);
            padding: 2rem;
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            border: 1px solid var(--border);
            text-align: left;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            max-height: 90vh;
            overflow-y: auto;
        }

        .input-group { margin: 1rem 0; width: 100%; text-align: left; }
        .input-group label { display: block; font-size: 0.75rem; color: var(--subtle); margin-bottom: 0.4rem; font-weight: 700; letter-spacing: 0.05em; text-transform: uppercase; }
        input[type="text"], input[type="number"], textarea.modal-input {
            width: 100%; padding: 0.8rem; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 1rem; font-family: inherit;
        }
        textarea.modal-input { min-height: 100px; resize: none; }
        input:focus, textarea.modal-input:focus { border-color: var(--text); }
        
        .btn-primary {
            background: var(--text); color: var(--bg); border: none; padding: 1rem; border-radius: 12px; font-weight: 700; cursor: pointer; width: 100%; margin-top: 1rem;
        }
        .btn-primary:active { transform: scale(0.98); }
        .btn-secondary {
            background: transparent; color: var(--subtle); border: 1px solid var(--border); padding: 0.8rem; border-radius: 12px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 0.5rem;
        }

        /* --- LAYOUT --- */
        #app { display: none; flex-direction: row; height: 100%; }

        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-width); height: 100%; padding: 2rem; display: flex; flex-direction: column;
            border-right: 1px solid var(--border); position: relative; background: var(--glass); z-index: 10;
        }

        .brand { font-size: 1.5rem; font-weight: 900; margin-bottom: 2rem; display: flex; align-items: center; gap: 12px; letter-spacing: -1px; }
        .brand-icon { width: 28px; height: 28px; background: var(--text); border-radius: 8px; }

        .nav-btn {
            background: transparent; border: none; text-align: left; padding: 1rem 1.2rem; font-size: 1.1rem;
            color: var(--subtle); cursor: pointer; transition: color 0.2s, transform 0.2s;
            display: flex; align-items: center; gap: 15px; font-weight: 600;
            border-radius: 16px; margin-bottom: 0.5rem;
            position: relative; overflow: hidden;
        }
        .nav-btn.active { color: var(--text); font-weight: 800; background: var(--border); }
        .nav-btn:hover { color: var(--text); background: rgba(125,125,125,0.05); }
        .nav-btn::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: skewX(-20deg); transition: 0.5s; pointer-events: none;
        }
        @media (prefers-color-scheme: dark) {
            .nav-btn::after { background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); }
        }
        .nav-btn:hover::after { left: 150%; transition: 0.7s; }
        
        .sidebar-stats { margin-top: auto; padding-top: 2rem; border-top: 1px solid var(--border); }
        .stat-block { margin-bottom: 1.5rem; }
        .stat-label { font-size: 0.75rem; color: var(--subtle); text-transform: uppercase; font-weight: 700; margin-bottom: 0.3rem;}
        .stat-value { font-size: 1.3rem; font-weight: 800; }

        /* MAIN CONTENT */
        .main-content {
            flex: 1; display: flex; flex-direction: column; position: relative; max-width: 650px; margin: 0 auto; width: 100%;
        }

        .top-bar {
            padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 20;
        }
        @media (prefers-color-scheme: dark) { .top-bar { background: rgba(0,0,0,0.85); } }

        .day-counter { font-weight: 800; font-size: 0.9rem; padding: 0.5rem 1rem; background: var(--border); border-radius: 20px; }
        .btn-next-day {
            background: var(--text); color: var(--bg); border: none; padding: 0.6rem 1.2rem; border-radius: 20px; font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: transform 0.2s;
        }
        .btn-next-day:hover { transform: scale(1.05); }

        .mobile-stats-bar {
            display: none; padding: 0.8rem 1rem; background: var(--bg); border-bottom: 1px solid var(--border); gap: 1rem; justify-content: space-between; font-size: 0.9rem;
            position: sticky; top: 61px; z-index: 15;
        }

        .view-section { display: none; flex-direction: column; flex: 1; overflow-y: auto; }
        .view-section.active { display: flex; }

        /* COMPOSER */
        .composer { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; gap: 1rem; flex-direction: column; }
        .composer-top { display: flex; gap: 1rem; }
        .avatar {
            width: 44px; height: 44px; background: #333; color: #fff; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; cursor: pointer;
        }
        .avatar.bot { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        textarea { width: 100%; border: none; resize: none; background: transparent; font-family: inherit; font-size: 1.1rem; color: var(--text); min-height: 50px; padding: 0.5rem 0; }
        
        .composer-tools { display: flex; justify-content: space-between; align-items: center; padding-left: 60px; }
        .tools-left { display: flex; gap: 0.5rem; align-items: center; }
        .collab-select { font-size: 0.85rem; padding: 0.4rem 0.8rem; border-radius: 15px; border: 1px solid var(--border); background: transparent; color: var(--text); cursor: pointer; }
        .btn-icon { background: transparent; border: 1px solid var(--border); padding: 0.4rem; border-radius: 50%; color: var(--text); cursor: pointer; display: flex; align-items: center; justify-content: center;}
        .btn-icon:hover { background: var(--border); }
        .btn-post { background: var(--text); color: var(--bg); border: none; padding: 0.5rem 1.5rem; border-radius: 20px; font-weight: 700; cursor: pointer; opacity: 0.5; pointer-events: none; transition: 0.2s; }
        .btn-post.active { opacity: 1; pointer-events: auto; }

        /* POLL CREATOR */
        .poll-creator { display: none; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem; padding: 1rem; background: var(--border); border-radius: 12px; margin-left: 60px; }
        .poll-creator.active { display: flex; }
        .poll-creator input { padding: 0.5rem; font-size: 0.9rem; background: var(--bg); }

        /* POSTS */
        .post { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; gap: 1rem; animation: slideIn 0.4s ease-out; position: relative; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .post-header { display: flex; justify-content: space-between; margin-bottom: 0.3rem; align-items: baseline; }
        .handle-group { display: flex; gap: 6px; align-items: baseline; flex-wrap: wrap; cursor: pointer; }
        .handle { font-weight: 800; color: var(--text); text-decoration: none; }
        .handle:hover { text-decoration: underline; }
        .collab-badge { font-size: 0.75rem; background: var(--border); padding: 1px 6px; border-radius: 4px; color: var(--text); }
        .post-text { font-size: 1rem; line-height: 1.5; margin-bottom: 1rem; white-space: pre-wrap; }

        /* POST MENU (3 DOTS) */
        .post-menu-container { position: relative; }
        .post-menu-btn { background: none; border: none; padding: 4px; cursor: pointer; color: var(--subtle); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .post-menu-btn:hover { background: var(--border); color: var(--text); }
        .post-menu { 
            position: absolute; right: 0; top: 100%; background: var(--bg); border: 1px solid var(--border); 
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: none; z-index: 100; min-width: 150px; overflow: hidden;
            margin-top: 4px;
        }
        .post-menu.active { display: block; }
        .menu-item { display: block; padding: 0.8rem 1rem; width: 100%; text-align: left; background: none; border: none; cursor: pointer; font-size: 0.9rem; color: var(--text); font-weight: 500; }
        .menu-item:hover { background: var(--border); }

        /* PRIVATE NOTE DISPLAY */
        .private-note { 
            background: #fdfdfd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem; 
            color: var(--text); border-left: 3px solid var(--text); font-style: italic; display: flex; flex-direction: column; gap: 4px;
        }
        .private-note-label { font-size: 0.7rem; font-weight: 700; color: var(--subtle); text-transform: uppercase; }
        @media (prefers-color-scheme: dark) { .private-note { background: #111; } }

        /* POLL DISPLAY */
        .poll-wrapper { margin-bottom: 1rem; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .poll-option {
            padding: 0.8rem 1rem; background: var(--bg); border-bottom: 1px solid var(--border); cursor: pointer;
            display: flex; justify-content: space-between; align-items: center; position: relative; height: 3rem;
        }
        .poll-option:last-child { border-bottom: none; }
        .poll-option:hover { background: rgba(0,0,0,0.02); }
        .poll-result-bg {
            position: absolute; top:0; left:0; height:100%; background: rgba(0,0,0,0.08); z-index: 0; transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1);
        }
        @media (prefers-color-scheme: dark) { .poll-result-bg { background: rgba(255,255,255,0.15); } }
        .poll-text { z-index: 1; font-weight: 500; font-size: 0.95rem; }
        .poll-percent { z-index: 1; font-weight: 700; display: flex; align-items: center; font-size: 0.9rem; }
        
        /* INTERACTIONS */
        .post-stats { display: flex; gap: 1.5rem; font-size: 0.9rem; color: var(--subtle); align-items: center; }
        .stat-item { display: flex; align-items: center; gap: 6px; cursor: pointer; transition: transform 0.1s; user-select: none; }
        .stat-item:active { transform: scale(0.9); }
        .stat-icon { stroke: currentColor; fill: transparent; transition: 0.3s; }
        .stat-item.liked .stat-icon { fill: var(--text); stroke: var(--text); animation: bounce 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes bounce { 0% { transform: scale(1); } 50% { transform: scale(1.4); } 100% { transform: scale(1); } }
        .stat-item.reposted .stat-icon { stroke: orange; animation: spin 0.6s ease; }
        .stat-item.reposted { color: orange; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .view-count-container { margin-top: 0.8rem; font-size: 0.8rem; color: var(--subtle); font-weight: 700; display: flex; align-items: center; gap: 4px; opacity: 0.8; }

        /* PROFILE */
        .profile-header { padding: 2rem 1.5rem; border-bottom: 1px solid var(--border); }
        .profile-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
        .profile-info h2 { font-size: 1.8rem; margin-bottom: 0.2rem; }
        .profile-handle { color: var(--subtle); margin-bottom: 1rem; display: block; }
        .profile-stats-row { display: flex; gap: 1.5rem; font-size: 0.95rem; }
        .profile-stat span { font-weight: 800; color: var(--text); }
        .profile-action-btn { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 0.5rem 1.2rem; border-radius: 12px; font-weight: 600; cursor: pointer; }
        .profile-action-btn.primary { background: var(--text); color: var(--bg); border: none; }

        /* MOBILE NAV */
        .mobile-nav {
            display: none; position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: var(--bg); border-top: 1px solid var(--border); justify-content: space-around; align-items: center; z-index: 50; padding-bottom: env(safe-area-inset-bottom);
        }
        
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .mobile-nav { display: flex; }
            #app { flex-direction: column; }
            .main-content { max-width: 100%; border-right: none; }
            .composer { padding: 1rem; }
            .composer-tools { padding-left: 0; }
            .poll-creator { margin-left: 0; }
            .post { padding: 1rem; }
            .sidebar-stats { display: none; }
            .mobile-stats-bar { display: flex; }
        }
        
        svg { width: 20px; height: 20px; stroke-width: 2; }
    </style>
</head>
<body onclick="closeAllMenus(event)">

    <!-- Onboarding -->
    <div id="onboarding" class="modal-overlay">
        <div style="margin-bottom: 2rem;">
            <h1>Welcome to Chirpless.</h1>
            <p class="subtle">Simulation of fame.</p>
        </div>
        <div class="input-group"><label>DISPLAY NAME</label><input type="text" id="setup-name" placeholder="e.g. Jane Doe" autocomplete="off"></div>
        <div class="input-group"><label>HANDLE</label><input type="text" id="setup-handle" placeholder="e.g. janedoe" autocomplete="off"></div>
        <div class="input-group"><label>INITIAL MONTHLY AUDIENCE</label><input type="number" id="setup-audience" value="1200"></div>
        <div class="input-group"><label>INITIAL FOLLOWERS</label><input type="number" id="setup-followers" value="450"></div>
        <button class="btn-primary" onclick="startApp()">Enter Simulation</button>
    </div>

    <!-- Collaboration Modal -->
    <div id="collab-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <h2>Collaboration Hub</h2>
            <p class="subtle" style="margin-bottom: 1.5rem;">Create bots to collaborate with. Higher stats = bigger boost.</p>
            <div class="input-group"><label>BOT NAME</label><input type="text" id="bot-name" placeholder="e.g. Cool Brand"></div>
            <div class="input-group"><label>BOT HANDLE</label><input type="text" id="bot-handle" placeholder="e.g. coolbrand"></div>
            <div style="display: flex; gap: 1rem;">
                <div class="input-group"><label>AUDIENCE</label><input type="number" id="bot-audience" value="50000"></div>
                <div class="input-group"><label>FOLLOWERS</label><input type="number" id="bot-followers" value="2000"></div>
            </div>
            <button class="btn-primary" onclick="confirmAddBot()">Create Bot</button>
            <button class="btn-secondary" onclick="closeCollabModal()">Close</button>
            <div style="margin-top: 2rem; border-top: 1px solid var(--border); padding-top: 1rem;">
                <label style="font-size: 0.8rem; color: var(--subtle); font-weight: 600;">EXISTING BOTS</label>
                <div id="bot-list" style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--subtle);">No bots yet.</div>
            </div>
        </div>
    </div>

    <!-- Note Modal -->
    <div id="note-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <h2>Private Note</h2>
            <p class="subtle" style="margin-bottom: 1rem;">Add a private note to this post. Only you can see this.</p>
            <textarea id="note-input" class="modal-input" placeholder="Type your thoughts..."></textarea>
            <button class="btn-primary" onclick="saveNote()">Save Note</button>
            <button class="btn-secondary" onclick="closeNoteModal()">Cancel</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand"><div class="brand-icon"></div>Chirpless</div>
            <nav>
                <button class="nav-btn active" onclick="switchTab('home')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg> Home
                </button>
                <button class="nav-btn" onclick="switchTab('search')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg> Search
                </button>
                <button class="nav-btn" onclick="switchTab('profile')">
                     <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg> Profile
                </button>
                <button class="nav-btn" onclick="switchTab('notes')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg> Notes
                </button>
                <button class="nav-btn" onclick="openCollabModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg> Collaborate
                </button>
            </nav>
            <div class="sidebar-stats">
                <div class="stat-block"><div class="stat-label">Monthly Audience</div><div class="stat-value ticker-root" id="audience-count">0</div></div>
                <div class="stat-block"><div class="stat-label">Followers</div><div class="stat-value ticker-root" id="follower-count">0</div></div>
            </div>
        </aside>

        <!-- Content -->
        <main class="main-content">
            <div class="top-bar">
                <div class="day-counter">Day <span id="day-display">1</span></div>
                <button class="btn-next-day" onclick="nextDay()">Next Day &rarr;</button>
            </div>

            <div class="mobile-stats-bar" id="mobile-stats">
                <div style="display: flex; gap: 5px;">Audience: <span class="ticker-root bold" id="mob-audience-count">0</span></div>
                <div style="display: flex; gap: 5px;">Followers: <span class="ticker-root bold" id="mob-follower-count">0</span></div>
            </div>

            <!-- HOME TAB -->
            <div id="view-home" class="view-section active">
                <div class="composer">
                    <div class="composer-top">
                        <div class="avatar" id="user-avatar" onclick="switchTab('profile')">?</div>
                        <div class="composer-area"><textarea id="post-input" placeholder="What's new?" oninput="checkInput()"></textarea></div>
                    </div>
                    <div class="composer-tools">
                        <div class="tools-left">
                            <select id="collab-select" class="collab-select"><option value="">No Collaborator</option></select>
                            <button class="btn-icon" onclick="togglePollCreator()" title="Create Poll">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 20v-6M6 20V10M18 20V4"></path></svg>
                            </button>
                        </div>
                        <button class="btn-post" id="post-btn" onclick="createPost()">Post</button>
                    </div>
                    <div class="poll-creator" id="poll-creator">
                        <input type="text" id="poll-opt-1" placeholder="Option 1">
                        <input type="text" id="poll-opt-2" placeholder="Option 2">
                    </div>
                </div>
                <div id="feed"></div>
            </div>

            <!-- SEARCH TAB -->
            <div id="view-search" class="view-section">
                <div style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border);">
                    <input type="text" id="search-input" placeholder="Search posts..." oninput="renderSearch()">
                </div>
                <div id="search-results"></div>
            </div>

            <!-- PROFILE TAB -->
            <div id="view-profile" class="view-section">
                <div id="profile-container"></div>
                <div id="profile-feed"></div>
            </div>

            <!-- NOTES TAB -->
            <div id="view-notes" class="view-section">
                <div style="padding: 2rem 1.5rem; border-bottom: 1px solid var(--border);">
                    <h2>My Notes</h2>
                    <p class="subtle">Private thoughts on posts.</p>
                </div>
                <div id="notes-feed"></div>
            </div>
        </main>

        <!-- Mobile Nav -->
        <div class="mobile-nav">
            <div class="nav-btn" onclick="switchTab('home')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg></div>
            <div class="nav-btn" onclick="switchTab('search')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></div>
            <div class="nav-btn" onclick="switchTab('profile')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></div>
            <div class="nav-btn" onclick="switchTab('notes')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><line x1="16" y1="13" x2="8" y2="13"></line></svg></div>
            <div class="nav-btn" onclick="openCollabModal()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg></div>
        </div>

    </div>

    <script>
        // --- GAME STATE ---
        let state = {
            user: { id: 'me', name: "", handle: "", audience: 0, followers: 0 },
            day: 1,
            posts: [],
            bots: [],
            lastPostDay: 0,
            activeTab: 'home',
            viewingProfile: null
        };

        // --- PERSISTENCE ---
        const DB_KEY = 'chirpless_save_v2';
        
        function saveData() {
            localStorage.setItem(DB_KEY, JSON.stringify(state));
        }

        function loadData() {
            const saved = localStorage.getItem(DB_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Merge cleanly to ensure new fields in future updates don't break
                    state = { ...state, ...parsed };
                    return true;
                } catch(e) { console.error("Save data corrupted", e); return false; }
            }
            return false;
        }

        // --- APP INIT ---
        window.onload = function() {
            if(loadData()) {
                // Restore UI from loaded state
                document.getElementById('onboarding').classList.add('hidden');
                document.getElementById('app').style.display = 'flex';
                
                const initials = state.user.name.substring(0,2).toUpperCase();
                document.getElementById('user-avatar').innerText = initials;
                document.getElementById('day-display').innerText = state.day;

                updateGlobalStats(true);
                updateBotList();
                renderFeed('feed');
            } else {
                // Show Onboarding
                document.getElementById('onboarding').classList.remove('hidden');
            }
        };

        // --- TICKER ENGINE ---
        function createTicker(element, value) {
            if(!element) return;
            const strVal = formatNumber(value);
            element.innerHTML = ''; 
            element.dataset.value = value;
            element.dataset.str = strVal;

            strVal.split('').forEach(char => {
                const wrapper = document.createElement('span');
                if (/\d/.test(char)) {
                    wrapper.className = 'ticker-digit-col';
                    let html = '';
                    for(let i=0; i<=9; i++) html += `<span class="ticker-digit">${i}</span>`;
                    wrapper.innerHTML = html;
                    wrapper.style.transform = `translateY(${-(parseInt(char) * 10)}%)`; 
                } else {
                    wrapper.className = 'ticker-digit';
                    wrapper.innerText = char;
                }
                element.appendChild(wrapper);
            });
        }

        function updateTicker(element, newValue) {
            if(!element) return;
            const strVal = formatNumber(newValue);
            if (element.dataset.str === strVal) return;
            
            const oldStr = element.dataset.str || "";
            if (oldStr.length !== strVal.length || oldStr.replace(/\d/g,'') !== strVal.replace(/\d/g,'')) {
                createTicker(element, newValue);
                return;
            }
            
            element.dataset.value = newValue;
            element.dataset.str = strVal;
            
            const cols = element.querySelectorAll('.ticker-digit-col');
            let digitIndex = 0;
            strVal.split('').forEach(char => {
                if (/\d/.test(char)) {
                    if(cols[digitIndex]) {
                        cols[digitIndex].style.transform = `translateY(${-(parseInt(char) * 10)}%)`;
                    }
                    digitIndex++;
                }
            });
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return Math.floor(num).toString();
        }

        // --- CORE LOGIC ---
        function startApp() {
            const name = document.getElementById('setup-name').value;
            const handle = document.getElementById('setup-handle').value;
            const audience = parseInt(document.getElementById('setup-audience').value) || 0;
            const followers = parseInt(document.getElementById('setup-followers').value) || 0;

            if(!name || !handle) { alert("Name and handle required."); return; }

            state.user.name = name;
            state.user.handle = handle.startsWith('@') ? handle : '@' + handle;
            state.user.audience = audience;
            state.user.followers = followers;

            document.getElementById('onboarding').classList.add('hidden');
            document.getElementById('app').style.display = 'flex';
            
            const initials = name.substring(0,2).toUpperCase();
            document.getElementById('user-avatar').innerText = initials;

            saveData();
            updateGlobalStats(true);
            renderFeed('feed');
        }

        function updateGlobalStats(force = false) {
            ['audience-count', 'mob-audience-count'].forEach(id => {
                const el = document.getElementById(id);
                if(force) createTicker(el, state.user.audience); else updateTicker(el, state.user.audience);
            });
            ['follower-count', 'mob-follower-count'].forEach(id => {
                const el = document.getElementById(id);
                if(force) createTicker(el, state.user.followers); else updateTicker(el, state.user.followers);
            });
        }

        function togglePollCreator() {
            const el = document.getElementById('poll-creator');
            el.classList.toggle('active');
        }

        function createPost() {
            const text = document.getElementById('post-input').value.trim();
            const pollOpt1 = document.getElementById('poll-opt-1').value.trim();
            const pollOpt2 = document.getElementById('poll-opt-2').value.trim();
            const hasPoll = document.getElementById('poll-creator').classList.contains('active') && pollOpt1 && pollOpt2;

            if(!text && !hasPoll) return;

            const collabId = document.getElementById('collab-select').value;
            const bot = state.bots.find(b => b.id == collabId);
            
            let mult = 1.0;
            if (bot) mult = 1 + (bot.audience / (state.user.audience + 1000)) * 0.5;

            const newPost = {
                id: Date.now(),
                authorId: 'me',
                content: text,
                dayPosted: state.day,
                views: 0, likes: 0, reposts: 0,
                liked: false, reposted: false,
                collab: bot ? { id: bot.id, name: bot.name, handle: bot.handle } : null,
                potential: state.user.audience * (1 + Math.random()) * mult, 
                decay: 1.0,
                poll: hasPoll ? {
                    options: [{text: pollOpt1, votes: 0}, {text: pollOpt2, votes: 0}],
                    totalVotes: 0,
                    voted: false
                } : null,
                myNote: null
            };

            state.posts.unshift(newPost);
            state.lastPostDay = state.day;
            state.user.audience += Math.floor(state.user.audience * 0.02) + 50; 
            
            document.getElementById('post-input').value = '';
            document.getElementById('poll-opt-1').value = '';
            document.getElementById('poll-opt-2').value = '';
            document.getElementById('poll-creator').classList.remove('active');
            document.getElementById('collab-select').value = "";
            checkInput();
            
            if(state.activeTab === 'home') renderFeed('feed');
            else if(state.activeTab === 'profile' && state.viewingProfile === 'me') renderProfile('me');
            
            updateGlobalStats();
            saveData();
        }

        function checkInput() {
            const val = document.getElementById('post-input').value.trim();
            document.getElementById('post-btn').classList.toggle('active', val.length > 0 || document.getElementById('poll-creator').classList.contains('active'));
        }

        // --- NAVIGATION & VIEWS ---
        function switchTab(tab, profileId = null) {
            state.activeTab = tab;
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            
            const navIndex = {'home':0, 'search':1, 'profile':2, 'notes': 3}[tab];
            if(navIndex !== undefined) document.querySelectorAll('.sidebar .nav-btn')[navIndex].classList.add('active');

            if(tab === 'home') {
                document.getElementById('view-home').classList.add('active');
                renderFeed('feed');
            } else if(tab === 'search') {
                document.getElementById('view-search').classList.add('active');
                renderSearch();
            } else if(tab === 'profile') {
                document.getElementById('view-profile').classList.add('active');
                renderProfile(profileId || 'me');
            } else if(tab === 'notes') {
                document.getElementById('view-notes').classList.add('active');
                renderFeed('notes-feed');
            }
        }

        // --- NOTES SYSTEM ---
        let currentNotePostId = null;

        function togglePostMenu(event, postId) {
            event.stopPropagation();
            closeAllMenus();
            const menu = document.getElementById(`menu-${postId}`);
            if(menu) menu.classList.add('active');
        }

        function closeAllMenus(e) {
            document.querySelectorAll('.post-menu').forEach(el => el.classList.remove('active'));
        }

        function openNoteModal(postId) {
            currentNotePostId = postId;
            const post = state.posts.find(p => p.id === postId);
            if(!post) return;
            
            document.getElementById('note-input').value = post.myNote || "";
            document.getElementById('note-modal').classList.remove('hidden');
            document.getElementById('note-modal').style.opacity = '1';
        }

        function closeNoteModal() {
            document.getElementById('note-modal').style.opacity = '0';
            setTimeout(() => document.getElementById('note-modal').classList.add('hidden'), 300);
            currentNotePostId = null;
        }

        function saveNote() {
            if(!currentNotePostId) return;
            const text = document.getElementById('note-input').value.trim();
            const post = state.posts.find(p => p.id === currentNotePostId);
            
            if(post) {
                post.myNote = text;
                // Re-render to show note indicator or updated view
                const currentContainer = state.activeTab === 'notes' ? 'notes-feed' : 
                                         state.activeTab === 'profile' ? 'profile-feed' : 'feed';
                renderFeed(currentContainer);
                saveData();
            }
            closeNoteModal();
        }

        // --- COLLAB MODAL ---
        function openCollabModal() {
            document.getElementById('collab-modal').classList.remove('hidden');
            document.getElementById('collab-modal').style.opacity = '1';
        }
        function closeCollabModal() {
            document.getElementById('collab-modal').style.opacity = '0';
            setTimeout(() => document.getElementById('collab-modal').classList.add('hidden'), 300);
        }
        function confirmAddBot() {
            const name = document.getElementById('bot-name').value;
            let handle = document.getElementById('bot-handle').value;
            const aud = parseInt(document.getElementById('bot-audience').value) || 0;
            const fol = parseInt(document.getElementById('bot-followers').value) || 0;
            if(!name || !handle) return;
            if(!handle.startsWith('@')) handle = '@' + handle;
            const bot = { id: Date.now(), name, handle, audience: aud, followers: fol };
            state.bots.push(bot);
            updateBotList();
            closeCollabModal();
            saveData();
        }
        function updateBotList() {
            const list = document.getElementById('bot-list');
            const select = document.getElementById('collab-select');
            list.innerHTML = state.bots.length ? state.bots.map(b => 
                `<div><b>${b.name}</b> <span class="subtle">${b.handle}</span><br><span style="font-size:0.8rem">Aud: ${formatNumber(b.audience)} | Fol: ${formatNumber(b.followers)}</span></div>`
            ).join('<hr style="border:0; border-top:1px solid var(--border); margin:0.5rem 0;">') : "No bots yet.";
            select.innerHTML = `<option value="">No Collaborator</option>` + state.bots.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
        }

        // --- SIMULATION ---
        function nextDay() {
            state.day++;
            document.getElementById('day-display').innerText = state.day;
            const daysSincePost = state.day - state.lastPostDay;
            let totalNewViews = 0;

            // 1. Process Posts
            state.posts.forEach(post => {
                const age = state.day - post.dayPosted;
                let dailyDecay = Math.exp(-0.15 * age); 
                
                if (dailyDecay > 0.01) {
                    let dailyViews = Math.floor(post.potential * dailyDecay * (Math.random() * 0.4 + 0.1));
                    if(dailyViews < 0) dailyViews = 0;
                    
                    post.views += dailyViews;
                    totalNewViews += dailyViews;
                    post.likes += Math.floor(dailyViews * 0.04);
                    post.reposts += Math.floor(dailyViews * 0.008);
                    
                    if(post.poll && age < 3 && Math.random() > 0.5) {
                        const votes = Math.floor(dailyViews * 0.1);
                        post.poll.totalVotes += votes;
                        const split = Math.random();
                        post.poll.options[0].votes += Math.floor(votes * split);
                        post.poll.options[1].votes += Math.floor(votes * (1-split));
                        updatePollDOM(post);
                    }

                    updatePostStatsDOM(post.id, post.views, post.likes, post.reposts);
                }
            });

            // 2. Audience Fall Off
            let audChange = 0;
            if (daysSincePost < 4) {
                audChange = Math.floor(totalNewViews * 0.015) + Math.floor(Math.random() * 100);
            } else if (daysSincePost >= 4 && daysSincePost < 23) {
                const slideFactor = 0.005 * (daysSincePost - 3);
                audChange = -Math.floor(state.user.audience * slideFactor);
            } else {
                audChange = -Math.floor(state.user.audience * 0.10);
            }
            
            state.user.audience = Math.max(0, state.user.audience + audChange);
            state.user.followers += Math.floor(totalNewViews * 0.001);
            
            updateGlobalStats();
            // Force re-render of times
            const activeFeed = state.activeTab === 'notes' ? 'notes-feed' : 
                               state.activeTab === 'profile' ? 'profile-feed' : 'feed';
            renderFeed(activeFeed, true); 
            saveData();
        }

        // --- INTERACTION ---
        function toggleLike(postId) {
            const post = state.posts.find(p => p.id === postId);
            if(!post) return;
            post.liked = !post.liked;
            post.likes += post.liked ? 1 : -1;
            const btn = document.getElementById(`like-btn-${postId}`);
            if(post.liked) btn.classList.add('liked'); else btn.classList.remove('liked');
            updateTicker(document.getElementById(`like-${postId}`), post.likes);
            saveData();
        }
        function toggleRepost(postId) {
            const post = state.posts.find(p => p.id === postId);
            if(!post) return;
            post.reposted = !post.reposted;
            post.reposts += post.reposted ? 1 : -1;
            const btn = document.getElementById(`repost-btn-${postId}`);
            if(post.reposted) btn.classList.add('reposted'); else btn.classList.remove('reposted');
            updateTicker(document.getElementById(`repost-${postId}`), post.reposts);
            saveData();
        }
        function votePoll(postId, optIdx) {
            const post = state.posts.find(p => p.id === postId);
            if(!post || post.poll.voted) return;
            post.poll.voted = true;
            post.poll.totalVotes++;
            post.poll.options[optIdx].votes++;
            updatePollDOM(post);
            saveData();
        }

        // --- RENDERING ---
        function renderFeed(containerId, updateTimesOnly = false) {
            const container = document.getElementById(containerId);
            if(!container) return;
            
            let posts = state.posts;
            if (containerId === 'profile-feed') {
                if(state.viewingProfile === 'me') posts = state.posts.filter(p => p.authorId === 'me');
                else posts = state.posts.filter(p => p.collab && p.collab.id == state.viewingProfile);
            } else if (containerId === 'search-results') {
                const query = document.getElementById('search-input').value.toLowerCase();
                posts = state.posts.filter(p => p.content.toLowerCase().includes(query));
            } else if (containerId === 'notes-feed') {
                posts = state.posts.filter(p => p.myNote && p.myNote.trim().length > 0);
            }

            if (updateTimesOnly) {
                posts.forEach(p => {
                    const timeEl = document.getElementById(`time-${p.id}`);
                    if(timeEl) timeEl.innerText = p.dayPosted === state.day ? "Today" : `${state.day - p.dayPosted}d ago`;
                });
                return;
            }

            container.innerHTML = '';
            if (posts.length === 0) {
                container.innerHTML = `<div style="padding:3rem; text-align:center; color:var(--subtle);">No posts found.</div>`;
                return;
            }
            posts.forEach(p => container.appendChild(createPostElement(p)));
        }

        function renderSearch() { renderFeed('search-results'); }

        function renderProfile(profileId) {
            state.viewingProfile = profileId;
            const container = document.getElementById('profile-container');
            const isMe = profileId === 'me';
            const user = isMe ? state.user : state.bots.find(b => b.id == profileId);
            if (!user) { container.innerHTML = "User not found"; return; }
            const initials = user.name.substring(0,2).toUpperCase();
            
            container.innerHTML = `
                <div class="profile-header">
                    <div class="profile-top">
                        <div class="avatar" style="width:80px; height:80px; font-size:2rem; ${!isMe ? 'background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);' : ''}">${initials}</div>
                        ${isMe ? `<button class="profile-action-btn" onclick="switchTab('notes')">My Notes</button>` : `<button class="profile-action-btn primary" onclick="this.innerText = this.innerText==='Follow'?'Following':'Follow'">Follow</button>`}
                    </div>
                    <div class="profile-info">
                        <h2>${user.name}</h2>
                        <span class="profile-handle">${user.handle}</span>
                        <div class="profile-stats-row"><div class="profile-stat"><span>${formatNumber(user.followers)}</span> followers</div><div class="profile-stat"><span>${formatNumber(user.audience)}</span> audience</div></div>
                    </div>
                </div>
            `;
            renderFeed('profile-feed');
        }

        function createPostElement(post) {
            const div = document.createElement('div');
            div.className = 'post';
            div.id = `post-${post.id}`;
            const timeStr = post.dayPosted === state.day ? "Today" : `${state.day - post.dayPosted}d ago`;
            
            let handleHTML = `<span class="handle" onclick="switchTab('profile', 'me')">${state.user.name}</span>`;
            if (post.collab) {
                handleHTML += ` <span class="subtle">&</span> <span class="handle" onclick="switchTab('profile', '${post.collab.id}')">${post.collab.name}</span> <span class="collab-badge">Collab</span>`;
            }

            let pollHTML = '';
            if (post.poll) {
                pollHTML = `<div class="poll-wrapper" id="poll-${post.id}"></div>`;
            }

            let noteHTML = '';
            if (post.myNote && post.myNote.trim().length > 0) {
                noteHTML = `
                <div class="private-note">
                    <span class="private-note-label">Private Note</span>
                    ${post.myNote}
                </div>`;
            }

            div.innerHTML = `
                <div class="avatar" onclick="switchTab('profile', 'me')">${state.user.name.substring(0,1)}</div>
                <div class="post-content">
                    <div class="post-header">
                        <div class="handle-group">${handleHTML}</div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span class="time" id="time-${post.id}">${timeStr}</span>
                            <div class="post-menu-container">
                                <button class="post-menu-btn" onclick="togglePostMenu(event, ${post.id})">
                                    <svg viewBox="0 0 24 24" fill="currentColor" style="width:16px; height:16px;"><circle cx="12" cy="12" r="1.5"/><circle cx="6" cy="12" r="1.5"/><circle cx="18" cy="12" r="1.5"/></svg>
                                </button>
                                <div class="post-menu" id="menu-${post.id}">
                                    <button class="menu-item" onclick="openNoteModal(${post.id})">
                                        ${post.myNote ? 'Edit Note' : 'Add Note'}
                                    </button>
                                    <button class="menu-item" style="color:#e0245e;" onclick="alert('Delete feature coming soon')">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="post-text">${post.content}</div>
                    ${pollHTML}
                    ${noteHTML}
                    <div class="post-stats">
                        <div class="stat-item ${post.liked ? 'liked' : ''}" id="like-btn-${post.id}" onclick="toggleLike(${post.id})">
                            <svg class="stat-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                            <span class="ticker-root" id="like-${post.id}"></span>
                        </div>
                        <div class="stat-item ${post.reposted ? 'reposted' : ''}" id="repost-btn-${post.id}" onclick="toggleRepost(${post.id})">
                            <svg class="stat-icon" viewBox="0 0 24 24"><path d="M17 1l4 4-4 4"></path><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><path d="M7 23l-4-4 4-4"></path><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>
                            <span class="ticker-root" id="repost-${post.id}"></span>
                        </div>
                    </div>
                    <div class="view-count-container"><span class="ticker-root" id="view-${post.id}"></span> views</div>
                </div>
            `;
            
            setTimeout(() => {
                createTicker(div.querySelector(`#like-${post.id}`), post.likes);
                createTicker(div.querySelector(`#repost-${post.id}`), post.reposts);
                createTicker(div.querySelector(`#view-${post.id}`), post.views);
                if(post.poll) updatePollDOM(post, div.querySelector(`#poll-${post.id}`));
            }, 0);

            return div;
        }

        function updatePollDOM(post, element) {
            const el = element || document.getElementById(`poll-${post.id}`);
            if(!el) return;
            
            const total = post.poll.totalVotes || 1; 
            const showResults = post.poll.voted || post.authorId === 'me';
            
            let html = '';
            post.poll.options.forEach((opt, idx) => {
                if(showResults) {
                    const pct = Math.round((opt.votes / total) * 100);
                    html += `
                        <div class="poll-option" style="cursor: default;">
                            <div class="poll-result-bg" style="width: ${pct}%"></div>
                            <span class="poll-text">${opt.text}</span>
                            <span class="poll-percent"><span class="ticker-root" id="poll-${post.id}-opt-${idx}">${pct}</span>%</span>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="poll-option" onclick="votePoll(${post.id}, ${idx})">
                            <span class="poll-text">${opt.text}</span>
                        </div>
                    `;
                }
            });
            
            if(showResults) {
                html += `<div style="padding: 0.5rem 1rem; font-size: 0.8rem; color: var(--subtle); border-top: 1px solid var(--border);">
                    <span class="ticker-root" id="poll-${post.id}-total">${post.poll.totalVotes}</span> votes
                </div>`;
            }

            el.innerHTML = html;

            if(showResults) {
                setTimeout(() => {
                    post.poll.options.forEach((opt, idx) => {
                        const pct = Math.round((opt.votes / total) * 100);
                        createTicker(el.querySelector(`#poll-${post.id}-opt-${idx}`), pct);
                    });
                    createTicker(el.querySelector(`#poll-${post.id}-total`), post.poll.totalVotes);
                }, 0);
            }
        }

        function updatePostStatsDOM(pid, v, l, r) {
            updateTicker(document.getElementById(`view-${pid}`), v);
            updateTicker(document.getElementById(`like-${pid}`), l);
            updateTicker(document.getElementById(`repost-${pid}`), r);
        }
    </script>
</body>
</html>
